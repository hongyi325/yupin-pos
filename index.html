<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å¾¡å“æ³¡èŒ¶é«”é©—</title>

    <!-- å¼•å…¥ Firebase v8 (å·²ç§»é™¤ authï¼Œé€€å›ç°¡æ˜“å‰ç«¯é˜²è­·) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <!-- å¼•å…¥ XLSX ç”¨æ–¼åŒ¯å‡º Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- å¼•å…¥ SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- å¼•å…¥ Notyf -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">
    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>

    <!-- å¼•å…¥ Phosphor Icons (ç¾ä»£è³ªæ„Ÿå‘é‡åœ–ç¤º) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* ç¾ä»£åŒ–è‰²å½©èˆ‡è¨­è¨ˆç³»çµ± Token */
        :root {
            --bg-body: #F7F6F3;
            --bg-card: #FFFFFF;
            --primary: #9C836A;     /* è«è˜­è¿ªå¥¶èŒ¶è‰² */
            --primary-hover: #8C735B;
            --accent-green: #5A8F69; /* æŸ”å’Œå“ç‰Œç¶  */
            --danger-red: #D96C6C;   /* æŸ”å’Œç´… */
            --text-main: #3C3633;
            --text-muted: #8E8A86;
            --border-soft: #EFEBE6;
            --shadow-soft: 0 4px 24px rgba(60, 54, 51, 0.06);
            --shadow-float: 0 12px 32px rgba(156, 131, 106, 0.2);
            --radius-md: 14px;
            --radius-lg: 20px;
            --radius-pill: 999px;
            --font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;

            /* è£œå›èˆŠç‰ˆè®Šæ•¸æ˜ å°„ï¼Œè§£æ±ºæŒ‰éˆ•æ²’åº•è‰²çš„å•é¡Œ */
            --main-brown: var(--primary);
            --accent-brown: var(--primary);
            --profit-green: var(--accent-green);
            --price-red: var(--danger-red);
        }

        body {
            font-family: var(--font-family); background: var(--bg-body); margin: 0;
            display: flex; flex-direction: column; height: 100vh; color: var(--text-main);
            overflow: hidden; -webkit-font-smoothing: antialiased;
        }

        /* é ‚éƒ¨ Header */
        header {
            background: var(--bg-card); color: var(--primary); padding: 16px;
            text-align: center; font-size: 1.25em; font-weight: 700; flex-shrink: 0;
            cursor: default; user-select: none; border-bottom: 1px solid var(--border-soft);
            display: flex; justify-content: center; align-items: center; gap: 8px;
            box-shadow: var(--shadow-soft); z-index: 10;
        }

        /* Nav Bar å°è¦½åˆ— */
        .nav-bar {
            background: var(--bg-body); padding: 12px 16px; display: flex; gap: 12px;
            overflow-x: auto; border-bottom: 1px solid var(--border-soft); flex-shrink: 0;
            align-items: center; white-space: nowrap; -webkit-overflow-scrolling: touch;
        }
        .nav-bar::-webkit-scrollbar { display: none; }
        .nav-btn {
            background: var(--bg-card); border: 1px solid var(--border-soft); color: var(--text-main);
            padding: 10px 20px; border-radius: var(--radius-pill); cursor: pointer;
            font-size: 1em; font-weight: 500; transition: all 0.2s; min-height: 44px;
            display: flex; align-items: center; gap: 6px; box-shadow: var(--shadow-soft);
        }
        .nav-btn:active { transform: scale(0.96); opacity: 0.9; }

        .dash-btn {
            background: var(--primary); color: white; border: none; padding: 10px 20px;
            border-radius: var(--radius-pill); font-weight: 600; cursor: pointer; transition: all 0.2s;
            min-height: 44px; display: flex; align-items: center; justify-content: center; gap: 6px; box-shadow: var(--shadow-float);
        }
        .dash-btn:active { transform: scale(0.96); opacity: 0.9; }

        .sync-btn {
            background: var(--text-muted); color: white; border: none; padding: 10px 20px;
            border-radius: var(--radius-pill); font-weight: 600; cursor: pointer; margin-left: auto;
            display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.3s; min-height: 44px;
        }
        .sync-btn:active { transform: scale(0.96); }
        .sync-btn.has-data { background: var(--danger-red); animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(217, 108, 108, 0.6); }
            70% { box-shadow: 0 0 0 10px rgba(217, 108, 108, 0); }
            100% { box-shadow: 0 0 0 0 rgba(217, 108, 108, 0); }
        }

        /* Main Layout */
        .main-content { display: flex; flex: 1; overflow: hidden; padding: 16px; gap: 16px; }

        /* å·¦å´é¡¯ç¤ºå€ (å•†å“/æ¡Œæ³) */
        .left-pane {
            flex: 1.8; display: flex; flex-direction: column; overflow: hidden;
            background: transparent; position: relative;
        }
        .item-area { flex: 1; overflow-y: auto; padding-right: 8px; }
        .table-area { flex: 1; overflow-y: auto; display: none; }

        /* å•†å“åˆ†é¡èˆ‡ Grid */
        .cat-title {
            padding: 10px 0; margin: 16px 0 12px; font-weight: 700; color: var(--text-main);
            font-size: 1.25em; display: flex; align-items: center; gap: 8px;
        }
        .cat-title i { color: var(--primary); }

        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
        .p-btn {
            background: var(--bg-card); border: 1px solid var(--border-soft); border-radius: var(--radius-md);
            padding: 16px 12px; text-align: center; cursor: pointer; box-shadow: var(--shadow-soft);
            min-height: 100px; display: flex; flex-direction: column; justify-content: center;
            position: relative; transition: all 0.2s;
        }
        .p-btn:active { transform: scale(0.96); box-shadow: none; border-color: var(--primary); }
        .p-btn.combo-item { border: 2px solid var(--primary); background: #FDFCF9; padding-top: 32px; /* é¿å…æ¨™ç±¤é®æ“‹æ–‡å­— */ }
        .combo-badge {
            position: absolute; top: 0px; right: 0px; background: var(--primary); color: white;
            font-size: 0.75em; padding: 6px 10px; border-radius: 0 var(--radius-md) 0 var(--radius-md); font-weight: 600;
        }
        .p-name { font-size: 0.9em; font-weight: 600; margin-bottom: 8px; height: 2.6em; overflow: hidden; line-height: 1.3; color: var(--text-main); }
        .p-price { color: var(--primary); font-size: 1.15em; font-weight: 700; margin-bottom: 4px; }
        .p-stock { font-size: 0.8em; color: var(--text-muted); font-weight: 500; }

        /* å³å´çµå¸³èˆ‡ç´€éŒ„å€ (iPad ç«¯) */
        .checkout-area {
            flex: 1; display: flex; flex-direction: column; gap: 16px;
            min-width: 360px; overflow-y: auto; max-width: 450px;
        }
        .card {
            background: var(--bg-card); border-radius: var(--radius-lg); padding: 20px;
            border: 1px solid var(--border-soft); display: flex; flex-direction: column;
            box-shadow: var(--shadow-soft);
        }
        .card-header-title { font-size: 1.1em; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; color: var(--text-main); }

        #cart-list { flex: 1; min-height: 180px; max-height: 350px; overflow-y: auto; border-bottom: 1px dashed var(--border-soft); margin-bottom: 12px; }
        .cart-item { display: flex; justify-content: space-between; align-items: flex-start; padding: 12px 0; font-size: 1.05em; border-bottom: 1px solid var(--bg-body); }
        .cart-details { font-size: 0.85em; color: var(--text-muted); margin-top: 4px; display: block; display: flex; gap: 4px; align-items: center; }

        /* --- è¼¸å…¥èˆ‡æ§åˆ¶å…ƒä»¶ (è§£æ±º iOS è£åˆ‡èˆ‡è·‘ç‰ˆå•é¡Œæ ¸å¿ƒ) --- */
        .big-input, .table-select, .form-control {
            font-size: 16px !important; /* ç¢ºä¿ 16px é¿å… iOS è‡ªå‹•ç¸®æ”¾é€ æˆè·‘ç‰ˆ */
            padding: 0 16px;
            min-height: 48px;
            width: 100%;
            border-radius: var(--radius-md);
            border: 1px solid #E2DED9;
            text-align: left;
            box-sizing: border-box;
            background: var(--bg-body);
            color: var(--text-main);
            font-weight: 500;
            transition: all 0.2s;
            line-height: normal;
            -webkit-appearance: none; /* ç§»é™¤ iOS é è¨­æ¨£å¼ä»¥é˜²æ­¢å…§å»º padding æ¨æ“ ç ´ç‰ˆ */
            appearance: none;
        }
        .big-input:focus, .table-select:focus, .form-control:focus { outline: none; border-color: var(--primary); background: #FFF; box-shadow: 0 0 0 4px rgba(156, 131, 106, 0.1); }
        .big-input { text-align: right; font-size: 1.25em !important; font-weight: 700; background: #FFF; border-color: var(--border-soft); min-height: 54px; }

        /* æ¡Œè™Ÿä¸‹æ‹‰é¸å–®å°ˆå±¬é˜²å‘†è¨­è¨ˆ */
        .table-select {
            text-align: center;
            text-align-last: center; /* è®“æ–‡å­—åœ¨ä¸‹æ‹‰é¸å–®å…§çœŸæ­£ç½®ä¸­ */
            color: var(--primary);
            background-color: #FDFCF9;
            border-width: 2px;
            font-weight: 700;
            cursor: pointer;
            min-height: 54px;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%239C836A' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 18px;
            padding-right: 40px; /* ç•™å‡ºç®­é ­ç©ºé–“ */
        }

        .small-note { font-size: 16px !important; padding: 0 16px; min-height: 48px; width: 100%; border-radius: var(--radius-md); border: 1px solid #E2DED9; box-sizing: border-box; margin-top: 8px; background: var(--bg-body); }

        /* æ—¥æœŸé¸æ“‡å™¨ä¿®å¾© (é‡å° iOS è·‘ç‰ˆ) */
        input[type="date"].form-control {
            padding: 12px 16px;
            font-family: inherit;
            background-color: #FFF;
            display: block;
            min-height: 52px;
        }

        .total-display { font-size: 2.8em; font-weight: 800; color: var(--danger-red); text-align: right; margin: 16px 0; letter-spacing: -1px; }

        .pay-btn {
            flex: 1; padding: 14px; border-radius: var(--radius-md); border: 1px solid var(--border-soft);
            background: var(--bg-body); cursor: pointer; font-weight: 600; font-size: 1.1em;
            display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; min-height: 48px; color: var(--text-muted);
        }
        .pay-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: var(--shadow-float); }
        .pay-btn:active { transform: scale(0.96); }

        .btn-submit {
            width: 100%; padding: 16px; background: var(--accent-green); color: white; border: none;
            border-radius: var(--radius-md); font-weight: 700; font-size: 1.25em; margin-top: 16px;
            cursor: pointer; box-shadow: 0 8px 20px rgba(90, 143, 105, 0.25); transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px; min-height: 54px;
        }
        .btn-submit:active { transform: scale(0.97); box-shadow: none; }

        /* Table Dashboard Styles */
        .table-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 16px; margin-top: 12px; }
        .t-card {
            border-radius: var(--radius-lg); padding: 16px; text-align: center; border: 1px solid var(--border-soft);
            cursor: pointer; display: flex; flex-direction: column; justify-content: center;
            min-height: 120px; box-shadow: var(--shadow-soft); transition: all 0.2s; background: var(--bg-card);
        }
        .t-card:active { transform: scale(0.96); }
        .t-empty { color: var(--text-muted); border: 2px dashed #E2DED9; background: transparent; box-shadow: none; }
        .t-green { background: #F0FDF4; border-color: #C6F6D5; color: #22543D; }
        .t-yellow { background: #FFFFF0; border-color: #FEFCBF; color: #744210; }
        .t-red { background: #FFF5F5; border-color: #FED7D7; color: #742A2A; }
        .t-red-blink { animation: modernPulse 2s infinite; color: #742A2A; border: 1px solid #FC8181; }
        @keyframes modernPulse { 0%, 100% { background: #FFF5F5; box-shadow: 0 0 0 0 rgba(252, 129, 129, 0.4); } 50% { background: #FED7D7; box-shadow: 0 0 0 8px rgba(252, 129, 129, 0); } }

        .t-name { font-size: 1.3em; font-weight: 700; margin-bottom: 8px; }
        .t-time { font-size: 0.9em; font-weight: 600; background: rgba(255,255,255,0.7); padding: 4px 8px; border-radius: var(--radius-pill); display: inline-flex; align-items: center; gap: 4px; margin: 0 auto; }
        .t-items { font-size: 0.85em; margin-top: 12px; font-weight: 500; display: flex; flex-direction: column; gap: 4px;}

        /* Panels / Modals (Modernized & z-index Fixed to 15000) */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(30, 26, 24, 0.4); z-index: 15000;
            display: none; justify-content: center; align-items: center; backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px); padding: 20px; box-sizing: border-box;
        }
        .modal-content {
            background: var(--bg-body); width: 100%; max-width: 900px; height: 90%; max-height: 800px;
            border-radius: var(--radius-lg); display: flex; flex-direction: column; padding: 24px;
            box-shadow: 0 24px 48px rgba(0,0,0,0.15); position: relative; animation: modalFadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); box-sizing: border-box;
        }
        .modal-small { max-width: 520px; height: auto; max-height: 90vh; }
        @keyframes modalFadeIn { from { transform: translateY(20px) scale(0.98); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }

        .modal-header-modern { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-soft); padding-bottom: 16px; flex-shrink: 0; }
        .modal-header-modern h2 { margin: 0; display: flex; align-items: center; gap: 10px; font-size: 1.4em; color: var(--text-main); }
        .close-icon-btn { background: transparent; border: none; font-size: 1.5em; color: var(--text-muted); cursor: pointer; padding: 8px; display: flex; align-items: center; justify-content: center; border-radius: var(--radius-full); transition: 0.2s; min-width: 44px; min-height: 44px;}
        .close-icon-btn:hover { background: var(--border-soft); color: var(--text-main); }
        .close-icon-btn:active { transform: scale(0.9); }

        /* æ²å‹•å®¹å™¨ï¼šç‚ºç¢ºä¿ Modal å…§å®¹é †æš¢æ²å‹• */
        .modal-body-scroll { flex: 1; overflow-y: auto; padding-right: 4px; display: flex; flex-direction: column; overscroll-behavior: contain; }

        /* è¡¨å–®å”èª¿è¨­å®š */
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-weight: 600; font-size: 0.95em; color: var(--text-muted); margin-bottom: 8px; }

        /* --- ç®¡ç†ä¸­å¿ƒ Grid æ¯”ä¾‹èª¿æ•´ --- */
        .admin-layout {
            display: grid;
            grid-template-columns: 2.5fr 1fr; /* é›»è…¦ç‰ˆè®“å•†å“å“é …ä½”æ¯”æ”¾å¤§è‡³ 71% */
            gap: 20px; flex: 1; overflow: hidden; min-height: 0;
        }
        .admin-actions { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }

        /* ç®¡ç†ä¸­å¿ƒè¡¨æ ¼è¨­å®š */
        .admin-table-container {
            flex: 1; overflow: auto; border: 1px solid var(--border-soft);
            border-radius: var(--radius-md); background: white;
            overscroll-behavior: none; -webkit-overflow-scrolling: touch;
            min-width: 0; min-height: 0;
        }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background: #F2EFEA; position: sticky; top: 0; padding: 0 14px; border-bottom: 1px solid var(--border-soft); z-index: 5; font-weight: 600; color: var(--text-main); text-align: left; height: 50px; box-sizing: border-box; }
        td { padding: 10px 14px; border-bottom: 1px solid var(--border-soft); vertical-align: middle; }

        /* å›ºå®šåˆ†é¡åˆ— */
        .cat-header-row td { position: sticky; top: 49px; z-index: 4; background: #FDFCF9; border-bottom: 2px solid var(--border-soft); box-shadow: 0 2px 6px rgba(0,0,0,0.03); box-sizing: border-box; }

        .del-x { color: var(--danger-red); cursor: pointer; font-size: 1.2em; padding: 8px; border-radius: var(--radius-md); transition: 0.2s; display: inline-flex; }
        .del-x:hover { background: #FFF5F5; }

        .admin-table-input { width: 100%; box-sizing: border-box; border: 1px solid #E2DED9; background: var(--bg-body); border-radius: 8px; padding: 0 10px; height: 44px; font-size: 1em; color: var(--text-main); transition: all 0.2s; text-align: center; font-weight: 500;}
        .admin-table-input:focus { outline: none; border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(156, 131, 106, 0.1); }
        td input[type="text"].admin-table-input { text-align: left; }

        .drag-handle { cursor: grab; color: var(--text-muted); font-size: 1.4em; user-select: none; touch-action: none; padding: 8px; display: inline-flex; }
        .drag-handle:active { cursor: grabbing; color: var(--primary); }
        tr.dragging { opacity: 0.5; background: #FDFCF9; }

        /* éŠ·å”®æ’åå°ˆå±¬å¤–å±¤å®¹å™¨ */
        .admin-ranking-box {
            background: #FDFCF9; padding: 20px; border-radius: 12px;
            border: 1px solid var(--border-soft); display: flex; flex-direction: column;
            flex-shrink: 0; min-width: 0; min-height: 0;
        }
        .admin-ranking-inner {
            flex: 1; overflow: auto; -webkit-overflow-scrolling: touch;
            overscroll-behavior: none; min-height: 0;
        }

        /* Combo Settings */
        .combo-config-area { border: 1px solid var(--border-soft); background: white; border-radius: var(--radius-md); padding: 16px; display: flex; flex-direction: column; flex: none; }
        .combo-cols { display: flex; gap: 16px; margin-top: 12px; }
        .combo-group-list { width: 35%; overflow-y: auto; padding-right: 8px; max-height: 300px; }
        .combo-item-pool { flex: 1; overflow-y: auto; padding-left: 8px; border-left: 1px solid var(--border-soft); max-height: 300px; }
        .group-card { padding: 12px 16px; border: 1px solid var(--border-soft); border-radius: var(--radius-md); margin-bottom: 10px; cursor: pointer; background: var(--bg-body); transition: 0.2s; }
        .group-card.active { border-color: var(--primary); background: #FDFCF9; box-shadow: 0 2px 8px rgba(156, 131, 106, 0.15); }

        .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .check-item { display: flex; align-items: center; padding: 12px; border: 1px solid var(--border-soft); background: var(--bg-body); border-radius: var(--radius-md); cursor: pointer; font-size: 0.95em; font-weight: 500; transition: 0.2s;}
        .check-item:hover { border-color: var(--primary); }
        .check-item input { margin-right: 10px; width: 18px; height: 18px; accent-color: var(--primary); }

        /* Combo Selection Modal UI */
        .combo-select-step { margin-bottom: 16px; border: 1px solid var(--border-soft); padding: 16px; border-radius: var(--radius-lg); background: var(--bg-body); }
        .combo-step-title { font-weight: 700; margin-bottom: 12px; color: var(--primary); font-size: 1.1em; display: flex; align-items: center; gap: 8px;}
        .combo-option {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 10px 20px; border: 2px solid var(--border-soft);
            border-radius: var(--radius-pill); cursor: pointer; background: var(--bg-card);
            font-weight: 600; font-size: 1.05em; transition: all 0.2s; min-height: 44px; color: var(--text-main);
            user-select: none; -webkit-tap-highlight-color: transparent;
        }
        .combo-option.selected {
            background: var(--primary); color: white; border-color: var(--primary);
            box-shadow: var(--shadow-float);
        }
        .combo-option:active { transform: scale(0.96); }
        .combo-option.disabled { opacity: 0.5; background: var(--bg-body); cursor: not-allowed; pointer-events: none; }

        /* History Items */
        .history-card {
            background: white; border: 1px solid var(--border-soft); padding: 16px;
            border-radius: var(--radius-md); margin-bottom: 12px; box-shadow: var(--shadow-sm);
            display: flex; flex-direction: column;
        }
        .history-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; gap: 12px;}
        .history-del-btn {
            color: var(--danger-red); cursor: pointer; font-weight: 600; border: 1px solid #FED7D7;
            padding: 6px 12px; border-radius: 8px; font-size: 0.85em; background: #FFF5F5;
            display: inline-flex; align-items: center; justify-content: center; gap: 4px; transition: 0.2s; flex-shrink: 0;
            min-height: 36px;
        }
        .history-del-btn:active { transform: scale(0.95); }

        .btn-setting {
            background: var(--bg-body); color: var(--text-main); border: 1px solid var(--border-soft); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 0.9em; font-weight: 600; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 6px; min-height: 38px;
        }
        .btn-setting:active { transform: scale(0.96); background: var(--border-soft); }

        /* Bottom Controls (Desktop) */
        .bottom-controls { padding: 16px; display: flex; justify-content: center; gap: 16px; flex-shrink: 0; background: var(--bg-body); border-top: 1px solid var(--border-soft); z-index: 10;}
        .ctrl-btn { padding: 14px 24px; border-radius: var(--radius-pill); font-weight: 600; font-size: 1.1em; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; min-height: 48px; border: none;}
        .ctrl-btn.outline { background: white; color: var(--text-main); border: 1px solid var(--border-soft); box-shadow: var(--shadow-sm); }
        .ctrl-btn.primary { background: var(--primary); color: white; box-shadow: var(--shadow-float); }
        .ctrl-btn:active { transform: scale(0.96); }

        /* SweetAlert2 & Notyf Fixes */
        div.swal2-container { z-index: 100000 !important; font-family: var(--font-family); }
        .swal2-popup { border-radius: 24px !important; }
        html.swal2-height-auto, body.swal2-height-auto { height: 100vh !important; }
        body.swal2-shown { padding-right: 0 !important; overflow: hidden !important; }

        /* Refined Login Overlay Styles */
        #login-overlay {
            position: fixed; inset: 0; background: var(--bg-body); z-index: 10000;
            display: flex; justify-content: center; align-items: center;
        }
        .login-card-ui {
            background: white; padding: 40px 32px; border-radius: 24px;
            box-shadow: var(--shadow-float); text-align: center; width: 90%; max-width: 380px;
            box-sizing: border-box; border: 1px solid var(--border-soft);
        }
        .login-card-ui h2 { margin-top: 0; color: var(--text-main); margin-bottom: 24px; font-size: 1.6em; font-weight: 800; display: flex; align-items: center; justify-content: center; gap: 8px; }

        .login-input-wrapper { position: relative; margin-bottom: 20px; width: 100%; }

        .login-input {
            width: 100%;
            height: 60px;
            padding: 0 16px;
            font-size: 1.5em;
            border: 2px solid var(--border-soft);
            border-radius: 12px;
            background: #fff;
            color: var(--text-main);
            transition: all 0.3s ease;
            text-align: center;
            letter-spacing: 8px;
            box-sizing: border-box;
            font-weight: 700;
        }
        .login-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(156, 131, 106, 0.15);
            outline: none;
        }
        .login-input::placeholder {
            text-align: center;
            color: #bcaaa4;
            letter-spacing: normal;
            font-size: 0.7em;
            font-weight: 500;
        }

        .login-card-ui .btn-submit {
            background: var(--primary);
            color: #fff;
            padding: 16px;
            font-size: 1.2em;
            border-radius: 12px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-float);
            border: none;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            box-sizing: border-box;
            min-height: 54px;
        }
        .login-card-ui .btn-submit:hover { background: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(156, 131, 106, 0.3); }
        .login-card-ui .btn-submit:active { transform: translateY(0); box-shadow: 0 2px 4px rgba(156, 131, 106, 0.2); }

        /* Notyf Toast å®¢è£½åŒ– UI/UX æ¨£å¼ */
        .notyf { z-index: 100000 !important; top: 50% !important; bottom: auto !important; transform: translateY(-50%) !important; align-items: center !important; justify-content: center !important; pointer-events: none; font-family: var(--font-family); }
        .notyf__toast { border-radius: var(--radius-pill) !important; padding: 12px 24px !important; box-shadow: var(--shadow-float) !important; max-width: 90vw !important; min-height: auto !important; align-items: center !important; pointer-events: auto; }
        .notyf__wrapper { padding: 0 !important; display: flex !important; justify-content: center !important; align-items: center !important; }
        .notyf__message { font-size: 1.05em !important; font-weight: 600 !important; padding: 0 !important; text-align: center !important; color: #ffffff !important; }

        /* Table Items Status UI */
        .td-item-row { padding: 14px 12px; border-bottom: 1px solid var(--border-soft); display: flex; justify-content: space-between; align-items: center; transition: 0.3s; background: white; border-radius: 8px; margin-bottom: 6px; }
        .td-item-row.is-served { opacity: 0.5; background: transparent; border-color: transparent; }
        .td-item-right { display: flex; align-items: center; gap: 16px; }
        .serve-cb-wrapper { display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; padding: 8px 14px; background: var(--bg-body); border-radius: var(--radius-pill); border: 1px solid #E2DED9; user-select: none; transition: 0.2s; font-weight: 600; min-height: 44px; min-width: 80px;}
        .serve-cb { width: 20px; height: 20px; accent-color: var(--accent-green); cursor: pointer; margin: 0; }
        .serve-cb-wrapper.served { border-color: var(--accent-green); background: #F0FDF4; color: var(--accent-green); }

        /* iPhone å°ˆå±¬çš„åº•éƒ¨æ‡¸æµ®çµå¸³åˆ— (Sticky Summary Bar) */
        .mobile-cart-summary {
            display: none; position: fixed; bottom: 20px; left: 16px; right: 16px;
            background: var(--primary); color: white; padding: 16px 24px;
            border-radius: var(--radius-pill); box-shadow: 0 12px 28px rgba(156, 131, 106, 0.4);
            z-index: 4000; justify-content: space-between; align-items: center;
            font-weight: 700; font-size: 1.15em; cursor: pointer; transition: transform 0.2s;
            margin-bottom: env(safe-area-inset-bottom, 0px);
        }
        .mobile-cart-summary:active { transform: scale(0.96); }
        .mobile-cart-summary .qty-badge { background: white; color: var(--primary); padding: 2px 8px; border-radius: 12px; font-size: 0.9em; margin-left: 8px; }

        /* --- é‡å°çª„è¢å¹• (iPhone) çš„ RWD å„ªåŒ– --- */
        @media (max-width: 768px) {
            .main-content { padding: 12px; padding-bottom: 12px; flex-direction: column; overflow-y: auto;}

            /* å·¦å´å•†å“/æ¡Œæ³åœ¨æ‰‹æ©Ÿä¸Šè‡ªç„¶å‘ä¸‹æ’ */
            .left-pane { flex: none; overflow: visible; background: transparent; border: none; }
            .item-area { padding: 0; overflow: visible; }
            .table-area { padding: 0; overflow: visible; background: transparent; }

            /* Grid èª¿æ•´ */
            .product-grid { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; }
            .table-grid { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; }

            /* é‡é»ï¼šå°‡å³å´çµå¸³å€æ”¹ç‚ºåº•éƒ¨æŠ½å±œ (Bottom Sheet) */
            .checkout-area {
                position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 5000;
                backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
                display: flex; flex-direction: column; justify-content: flex-end;
                opacity: 0; pointer-events: none; transition: opacity 0.3s;
                max-width: none; min-width: 0; padding: 0; gap: 0;
            }
            .checkout-area.is-open { opacity: 1; pointer-events: auto; }

            /* è®“ Card è®ŠæˆæŠ½å±œæœ¬é«” */
            .checkout-area > .card {
                background: var(--bg-body); border-radius: 24px 24px 0 0; margin: 0;
                border: none; padding: 20px; max-height: 85vh; overflow-y: auto;
                transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
                padding-bottom: max(20px, env(safe-area-inset-bottom)); /* å®‰å…¨å€åŸŸç•™ç™½ */
            }
            .checkout-area.is-open > .card { transform: translateY(0); }

            /* åœ¨æŠ½å±œé ‚éƒ¨åŠ å…¥é—œé–‰æŠŠæ‰‹èˆ‡æŒ‰éˆ• */
            .mobile-drawer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
            .mobile-drawer-handle { width: 50px; height: 5px; background: #E2DED9; border-radius: 5px; margin: 0 auto 16px; }

            .mobile-cart-summary { display: flex; }

            /* éš±è—æ¡Œé¢ç‰ˆçš„ ä»Šæ—¥ç´€éŒ„ */
            #log-card-container { display: none; }

            /* æ¨¡æ…‹æ¡†æ‰‹æ©Ÿç‰ˆæ”¹ç‚º Bottom Sheet */
            .modal-overlay { align-items: flex-end; padding: 0; }
            .modal-content {
                border-radius: 24px 24px 0 0; margin: 0; max-height: 90vh;
                animation: slideUpMobile 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); padding: 20px;
                padding-bottom: max(20px, env(safe-area-inset-bottom)); /* å®‰å…¨å€åŸŸç•™ç™½ */
            }
            @keyframes slideUpMobile { from { transform: translateY(100%); } to { transform: translateY(0); } }

            /* ç®¡ç†ä¸­å¿ƒ Grid æ¯”ä¾‹èª¿æ•´ (æ‰‹æ©Ÿç‰ˆ 65% : 35%) */
            .admin-layout { grid-template-columns: 1fr; grid-template-rows: 65% 35%; gap: 12px; min-height: 0; }
            .admin-ranking-box { padding: 12px; }

            /* ç®¡ç†å‹•ä½œæŒ‰éˆ•æ°´å¹³æ»‘å‹•é˜²æ“ å£“ */
            .admin-actions { flex-wrap: nowrap; overflow-x: auto; padding-bottom: 8px; -webkit-overflow-scrolling: touch; }
            .admin-actions button { white-space: nowrap; flex-shrink: 0; }

            /* åº•éƒ¨æŒ‰éˆ•é‡ç–Š */
            .bottom-controls {
                flex-direction: row;
                padding: 12px;
                padding-bottom: calc(90px + env(safe-area-inset-bottom, 0px));
                justify-content: space-between; gap: 10px;
            }
            .bottom-controls .ctrl-btn { flex: 1; padding: 12px; font-size: 1em; justify-content: center; }

            /* è¡¨æ ¼èˆ‡åˆ—è¡¨å¾®èª¿ */
            .td-item-row { flex-direction: column; align-items: flex-start; gap: 12px; }
            .td-item-right { width: 100%; justify-content: space-between; padding-top: 8px; border-top: 1px dashed var(--border-soft); }

            /* Table Dashboard RWD adjustments */
            .t-card { padding: 10px 5px; min-height: 90px; }
            .t-name { font-size: 1.15em; margin-bottom: 4px; }
            .t-time { font-size: 0.75em; padding: 2px 4px; }
            .t-items { font-size: 0.75em; margin-top: 6px; }

            /* History Item RWD adjustments */
            .history-card { padding: 12px; }
            .history-del-btn { position: static; margin-left: auto; padding: 6px 10px; font-size: 0.85em; }

            .login-card-ui { padding: 30px 20px; }
            .login-card-ui h2 { font-size: 1.5em; }
            .login-input { font-size: 1.3em; height: 54px; letter-spacing: 6px; }
            .login-card-ui .btn-submit { font-size: 1.1em; padding: 14px; }
            .notyf__toast { padding: 8px 16px !important; }
            .notyf__message { font-size: 0.95em !important; }

            /* æ–°å¢å¥—é¤è·‘ç‰ˆ */
            .combo-config-area { flex: none; display: flex; flex-direction: column; overflow: visible; padding: 12px; }
            .combo-cols { flex-direction: column; overflow: visible; height: auto; margin-top: 12px; }
            .combo-group-list { width: 100%; height: auto; max-height: 200px; border-right: none; border-bottom: 1px solid var(--border-soft); padding-right: 0; padding-bottom: 12px; margin-bottom: 12px; }
            .combo-item-pool { width: 100%; height: auto; max-height: 300px; padding-left: 0; border-left: none; }

            /* ä¿®æ­£æ‰‹æ©Ÿç‰ˆæ¡Œè™Ÿé¸æ“‡èˆ‡è¼¸å…¥æ¡†é–“è·ã€ç¸®å° Placeholder èˆ‡å­—é«” */
            .table-select { font-size: 16px !important; height: 56px !important; margin-bottom: 20px; }
            .big-input { font-size: 16px !important; min-height: 56px; margin-top: 12px; margin-bottom: 16px; }
            .big-input::placeholder { font-size: 0.9em; }
            .small-note { font-size: 16px !important; min-height: 52px; margin-top: 12px; margin-bottom: 20px; }
            .small-note::placeholder { font-size: 0.9em; }

            input[type="date"].form-control {
                font-size: 16px !important;
                margin-top: 12px;
                width: 100%;
                min-height: 52px;
            }

            /* çµå¸³å€å…§çš„å€å¡Šå¢åŠ ä¸Šä¸‹é–“è· */
            #cart-list { margin-bottom: 16px; margin-top: 16px; }
        }

        /* ä¿®å¾©æ—¥æœŸé¸æ“‡æ¡†å…§è·å°è‡´æ‰‹æ©Ÿç‰ˆè£åˆ‡æˆ–ç ´ç‰ˆçš„å•é¡Œ */
        input[type="date"].form-control {
            padding: 12px 16px;
            font-family: inherit;
            background-color: #FFF;
            display: block;
            width: 100%;
            box-sizing: border-box;
            -webkit-appearance: none;
            appearance: none;
        }

        /* æ¡Œé¢ç«¯éš±è—æ‰‹æ©ŸæŠ½å±œé ­éƒ¨ */
        @media (min-width: 769px) { .mobile-drawer-header { display: none; } }

    </style>
</head>
<body>

<!-- ç™»å…¥è¦†è“‹å±¤ -->
<div id="login-overlay">
    <div class="login-card-ui">
        <h2><i class="ph-fill ph-leaf"></i> å¾¡å“æ³¡èŒ¶</h2>
        <div class="login-input-wrapper">
            <input type="password" id="login-pwd-input" class="login-input" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" onkeypress="if(event.key==='Enter') checkSystemLogin()">
        </div>
        <button onclick="checkSystemLogin()" class="btn-submit"><i class="ph-bold ph-sign-in"></i> é€²å…¥ç³»çµ±</button>
    </div>
</div>

<header onclick="handleHeaderSecretClick()"><i class="ph-fill ph-leaf"></i> å¾¡å“æ³¡èŒ¶é«”é©—</header>
<div class="nav-bar">
    <button id="btn-nav-menu" class="dash-btn" onclick="toggleView('products')" style="background:var(--primary); color:white; border:none;"><i class="ph-bold ph-list"></i> ä¸»é¸å–®</button>
    <button id="btn-nav-tables" class="dash-btn" onclick="toggleView('tables')" style="background:var(--bg-card); color:var(--text-main); border:1px solid var(--border-soft);"><i class="ph-bold ph-armchair"></i> é–€å¸‚æ¡Œæ³</button>
    <div style="flex:1;"></div>
    <button id="sync-btn" class="sync-btn" onclick="syncOfflineData()"><i class="ph-bold ph-cloud-arrow-up"></i> é›²ç«¯åŒæ­¥</button>
</div>

<div class="main-content">
    <!-- å·¦å´é¡¯ç¤ºå€ (å•†å“/æ¡Œæ³) -->
    <div class="left-pane">
        <div class="item-area" id="item-area">åŒæ­¥ä¸­...</div>
        <div class="table-area" id="table-area"></div>
    </div>

    <!-- å³å´çµå¸³å€ (æ‰‹æ©Ÿç‰ˆç‚ºåº•éƒ¨æŠ½å±œ) -->
    <div class="checkout-area" id="checkout-drawer">
        <!-- é»æ“ŠèƒŒæ™¯é—œé–‰æŠ½å±œ (åƒ…æ‰‹æ©Ÿç‰ˆç”Ÿæ•ˆ) -->
        <div style="flex:1;" onclick="toggleMobileCart(false)"></div>

        <div class="card" style="flex-shrink: 0;" onclick="event.stopPropagation()">
            <div class="mobile-drawer-handle"></div>
            <div class="mobile-drawer-header">
                <span style="font-size: 1.2em; font-weight: 700;"><i class="ph-bold ph-shopping-cart"></i> è³¼ç‰©è»Šçµå¸³</span>
                <button class="close-icon-btn" onclick="toggleMobileCart(false)"><i class="ph ph-x"></i></button>
            </div>

            <div class="card-header-title" style="display: none /* æ¡Œé¢ç”¨è‡ªè¨‚titleï¼Œå·²èåˆ */">ğŸ›’ ç•¶å‰æ¸…å–®</div>

            <select id="checkout-table" class="table-select"></select>

            <div id="cart-list"></div>
            <div style="margin-top:12px; flex-shrink: 0;">
                <input type="number" id="discount" class="big-input" placeholder="æŠ˜æ‰£é‡‘é¡" oninput="calc()">
                <input type="text" id="discount-note" class="small-note" placeholder="æŠ˜æ‰£åŸå› /å‚™è¨» (ä¾‹å¦‚: æ»¿é¡è´ˆ)">
                <div style="margin-top:8px; display:flex; gap:8px;">
                    <button onclick="addExtraCost()" style="flex:1; padding:12px; background:#FFF5F5; border:1px solid #FED7D7; color:var(--danger-red); border-radius:10px; cursor:pointer; font-weight:600; display:flex; align-items:center; justify-content:center; gap:6px;"><i class="ph-bold ph-plus-circle"></i> ç´€éŒ„é¡å¤–æ”¯å‡º</button>
                </div>
            </div>
            <div class="total-display" style="flex-shrink: 0;">$<span id="final-total">0</span></div>
            <div style="display:flex; gap:10px; margin-bottom:12px; flex-shrink: 0;">
                <button class="pay-btn active" id="btn-cash" onclick="setPay('ç¾é‡‘')"><i class="ph-bold ph-money"></i> ç¾é‡‘</button>
                <button class="pay-btn" id="btn-elec" onclick="setPay('é›»æ”¯')"><i class="ph-bold ph-device-mobile"></i> é›»æ”¯</button>
            </div>
            <input type="number" id="cash-in" class="big-input" placeholder="å¯¦æ”¶é‡‘é¡" oninput="calcChange()" style="flex-shrink: 0;">
            <div style="text-align:right; margin-top:8px; font-size: 1.2em; flex-shrink: 0; font-weight: 600;">æ‰¾é›¶: <span id="cash-change" style="font-weight:800; color:var(--danger-red); font-size:1.6em;">0</span></div>

            <div style="margin: 12px 0; padding: 12px; background: #FDFCF9; border-radius: 12px; border: 1px dashed var(--primary); flex-shrink: 0; display: flex; flex-direction: column; gap: 8px;">
                <label style="font-size: 0.95em; cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: 500; margin: 0;">
                    <input type="checkbox" id="backdate-mode" onclick="document.getElementById('manual-date').style.display = this.checked ? 'block' : 'none'" style="width:18px; height:18px; accent-color:var(--primary); margin:0;">
                    <i class="ph-bold ph-calendar-blank"></i> è£œç™»éå»æ—¥æœŸè³‡æ–™
                </label>
                <input type="date" id="manual-date" class="form-control" style="display:none;">
            </div>

            <button onclick="submitOrder()" class="btn-submit">çµå¸³ / é€å–® <i class="ph-bold ph-paper-plane-right"></i></button>
        </div>

        <!-- æ¡Œæ©Ÿç‰ˆä»Šæ—¥ç´€éŒ„ -->
        <div class="card" id="log-card-container" style="font-size: 1em; overflow-y: auto; height: 180px; flex-shrink: 0; margin-top: 16px;">
            <div class="card-header-title"><i class="ph-bold ph-receipt"></i> ä»Šæ—¥å³æ™‚ç´€éŒ„</div>
            <div id="order-log"></div>
        </div>
    </div>
</div>

<!-- æ‰‹æ©Ÿç‰ˆå°ˆå±¬åº•éƒ¨æ‡¸æµ®åˆ— -->
<div class="mobile-cart-summary" onclick="toggleMobileCart(true)">
    <div style="display:flex; align-items:center; gap:8px;">
        <i class="ph-bold ph-shopping-cart" style="font-size: 1.3em;"></i> è³¼ç‰©è»Š <span class="qty-badge" id="mobile-cart-count">0</span>
    </div>
    <div>$<span id="mobile-cart-total">0</span></div>
</div>

<!-- åº•éƒ¨ç³»çµ±ç®¡ç†å€ -->
<div class="bottom-controls">
    <button class="ctrl-btn outline" onclick="openModal('admin-panel')"><i class="ph-bold ph-gear"></i> å•†å“ç®¡ç† / çµ±è¨ˆ</button>
    <button class="ctrl-btn primary" onclick="openHistoryPanel()"><i class="ph-bold ph-clock-counter-clockwise"></i> æ­·å²ç´€éŒ„ / é€€è²¨</button>
</div>

<!-- æ¡Œæ³æ˜ç´° Modal -->
<div id="table-details-modal" class="modal-overlay">
    <div class="modal-content modal-small">
        <div class="modal-header-modern">
            <h2 id="td-modal-title"><i class="ph-fill ph-armchair"></i> æ¡Œæ³æ˜ç´°</h2>
            <button class="close-icon-btn" onclick="closeModal('table-details-modal')"><i class="ph ph-x"></i></button>
        </div>
        <div class="modal-body-scroll">
            <div id="td-modal-info" style="background:#FDFCF9; padding:16px; border-radius:12px; font-weight:600; margin-bottom:12px; flex-shrink:0; border:1px solid var(--border-soft);"></div>
            <div id="td-modal-items" style="flex:1; border-radius:12px; background:var(--bg-body); padding: 8px;"></div>
        </div>
        <button id="td-modal-clear-btn" class="btn-submit" style="background:var(--danger-red); margin-top:16px; flex-shrink:0;"><i class="ph-bold ph-broom"></i> æ¸…é™¤æ¡Œé¢ (å®¢é›¢)</button>
    </div>
</div>

<!-- History Modal -->
<div id="history-panel" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header-modern">
            <h2><i class="ph-bold ph-clock-counter-clockwise"></i> æ­·å²ç´€éŒ„ç®¡ç†</h2>
            <button class="close-icon-btn" onclick="closeModal('history-panel')"><i class="ph ph-x"></i></button>
        </div>
        <div style="background:#FDFCF9; padding:16px; border-radius:12px; margin-bottom:16px; display:flex; gap:16px; align-items:center; flex-wrap:wrap; border:1px solid var(--border-soft); flex-shrink:0;">
            <div style="display:flex; align-items:center; gap:8px;">
                <input type="date" id="search-date" class="form-control" style="min-height:44px; padding:0 12px; width:auto; height: 44px;">
                <button onclick="searchHistory('day')" class="dash-btn" style="min-height:44px;"><i class="ph-bold ph-magnifying-glass"></i> æŸ¥è©¢</button>
            </div>
            <div style="border-left: 2px solid var(--border-soft); padding-left: 16px; display:flex; align-items:center; gap:8px;">
                <input type="month" id="search-month" class="form-control" style="min-height:44px; padding:0 12px; width:auto; height: 44px;">
                <button onclick="searchHistory('month')" class="dash-btn" style="background:var(--accent-green); min-height:44px;"><i class="ph-bold ph-chart-bar"></i> çµ±è¨ˆ</button>
            </div>
        </div>
        <div id="history-result-area" style="flex:1; overflow-y:auto; background:white; padding:16px; border-radius:12px; border:1px solid var(--border-soft);"></div>
    </div>
</div>

<!-- Admin Modal (Main) -->
<div id="admin-panel" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header-modern">
            <h2><i class="ph-bold ph-gear"></i> ç®¡ç†ä¸­å¿ƒ</h2>
            <button class="close-icon-btn" onclick="closeModal('admin-panel')"><i class="ph ph-x"></i></button>
        </div>

        <div class="admin-actions">
            <button onclick="openAddSingleModal()" class="dash-btn" style="background:var(--accent-green);"><i class="ph-bold ph-plus-circle"></i> æ–°å¢å–®å“</button>
            <button onclick="openAddComboModal()" class="dash-btn" style="background:#D97706;"><i class="ph-bold ph-squares-four"></i> æ–°å¢å¥—é¤</button>
            <button onclick="setTableCount()" class="dash-btn" style="background:#4A90E2;"><i class="ph-bold ph-hash"></i> è¨­å®šæ¡Œæ•¸</button>

            <div style="margin-left:auto; display:flex; gap:12px;">
                <button onclick="exportToExcel()" class="dash-btn" style="background:#2F855A;"><i class="ph-bold ph-download-simple"></i> åŒ¯å‡º</button>
                <button onclick="backupData()" class="dash-btn" style="background:var(--text-muted);"><i class="ph-bold ph-floppy-disk"></i> å‚™ä»½</button>
                <input type="file" id="import-file" style="display:none;" onchange="importData(event)">
                <button onclick="document.getElementById('import-file').click()" class="dash-btn" style="background:var(--danger-red);"><i class="ph-bold ph-warning"></i> é‚„åŸ</button>
            </div>
        </div>

        <div class="admin-layout">
            <div class="admin-table-container">
                <table id="admin-main-table">
                    <!-- è¡¨æ ¼å…§å®¹ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                </table>
            </div>
            <div class="admin-ranking-box">
                <h3 style="margin-top:0; margin-bottom:12px; color:var(--text-main); display:flex; align-items:center; gap:8px; flex-shrink: 0; font-size:1.1em;"><i class="ph-bold ph-chart-line-up"></i> éŠ·å”®æ’å</h3>
                <div class="admin-ranking-inner">
                    <table style="font-size:0.95em; width:100%; border-collapse: collapse; white-space: nowrap;">
                        <thead style="position: sticky; top: 0; background: #FDFCF9; z-index: 2;">
                        <tr>
                            <th style="border-bottom:2px solid #E2DED9; padding-bottom:8px; text-align: left;">å“å</th>
                            <th style="border-bottom:2px solid #E2DED9; padding-bottom:8px; padding-left:12px; text-align:center;">é‡</th>
                            <th style="border-bottom:2px solid #E2DED9; padding-bottom:8px; padding-left:12px; text-align:center;">é¡</th>
                        </tr>
                        </thead>
                        <tbody id="stat-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Add Single Product -->
<div id="modal-single-product" class="modal-overlay">
    <div class="modal-content modal-small">
        <div class="modal-header-modern">
            <h2><i class="ph-bold ph-plus-circle"></i> æ–°å¢å–®å“</h2>
            <button class="close-icon-btn" onclick="closeModal('modal-single-product')"><i class="ph ph-x"></i></button>
        </div>
        <div class="modal-body-scroll">
            <div class="form-group">
                <label>å•†å“åˆ†é¡</label>
                <select id="single-cat" class="form-control" onchange="checkNewCat(this.value, 'single-cat')"></select>
            </div>
            <div class="form-group">
                <label>å•†å“ä»£ç¢¼ (é¸å¡«)</label>
                <input type="text" id="single-id" class="form-control" placeholder="ä¾‹å¦‚: A01">
            </div>
            <div class="form-group">
                <label>å•†å“åç¨±</label>
                <input type="text" id="single-name" class="form-control" placeholder="è«‹è¼¸å…¥åç¨±">
            </div>
            <div style="display:flex; gap:16px;">
                <div class="form-group" style="flex:1;">
                    <label>æˆæœ¬</label>
                    <input type="number" id="single-cost" class="form-control" value="0">
                </div>
                <div class="form-group" style="flex:1;">
                    <label>å”®åƒ¹</label>
                    <input type="number" id="single-price" class="form-control" value="0">
                </div>
            </div>
            <div class="form-group">
                <label>åˆå§‹åº«å­˜</label>
                <input type="number" id="single-stock" class="form-control" value="99">
            </div>
        </div>
        <button onclick="saveSingleProduct()" class="btn-submit" style="flex-shrink:0;">ç¢ºèªæ–°å¢</button>
    </div>
</div>

<!-- Modal: Add Combo Product -->
<div id="modal-combo-product" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header-modern">
            <h2><i class="ph-bold ph-squares-four"></i> æ–°å¢/ç·¨è¼¯å¥—é¤</h2>
            <button class="close-icon-btn" onclick="closeModal('modal-combo-product')"><i class="ph ph-x"></i></button>
        </div>
        <div class="modal-body-scroll">
            <!-- Basic Info -->
            <div style="display:flex; gap:16px; flex-wrap:wrap; margin-bottom: 12px; flex-shrink: 0;">
                <div class="form-group" style="flex:1; min-width:150px;">
                    <label>åˆ†é¡</label>
                    <select id="combo-cat" class="form-control" onchange="checkNewCat(this.value, 'combo-cat')"></select>
                </div>
                <div class="form-group" style="flex:1; min-width:150px;">
                    <label>å¥—é¤åç¨±</label>
                    <input type="text" id="combo-name" class="form-control" placeholder="ä¾‹: ä¸‹åˆèŒ¶çµ„åˆ">
                </div>
                <div class="form-group" style="width:120px;">
                    <label>å”®åƒ¹</label>
                    <input type="number" id="combo-price" class="form-control" value="0">
                </div>
                <div class="form-group" style="width:100px;">
                    <label>ä»£ç¢¼</label>
                    <input type="text" id="combo-id" class="form-control">
                </div>
            </div>

            <!-- Combo Config -->
            <div class="combo-config-area">
                <div style="display:flex; gap:10px; margin-bottom:16px; align-items:center; background:#F0FDF4; padding:12px 16px; border-radius:12px; border: 1px solid #C6F6D5; flex-wrap: wrap;">
                    <strong style="color:#22543D; display:flex; align-items:center; gap:6px; flex-shrink: 0;"><i class="ph-fill ph-check-circle"></i> æ­¥é©Ÿï¼š</strong>
                    <span style="color:#22543D; font-weight:500; flex-shrink: 0;">è¼¸å…¥ç¾¤çµ„åç¨± (å¦‚: é£²å“é¸ä¸€) </span>
                    <input type="text" id="combo-group-input" class="form-control" style="min-height:44px; padding:6px 12px; flex: 1; min-width: 140px; margin-bottom: 0;" placeholder="ç¾¤çµ„åç¨±...">
                    <button onclick="addComboGroup()" class="dash-btn" style="background:var(--accent-green); min-height:44px; padding:6px 16px; flex-shrink: 0;"><i class="ph-bold ph-plus"></i> åŠ å…¥ç¾¤çµ„</button>
                </div>

                <div class="combo-cols">
                    <!-- Left: Group List -->
                    <div class="combo-group-list" id="combo-group-list-ui">
                        <div style="color:var(--text-muted); text-align:center; padding:30px; background:var(--bg-body); border-radius:12px;">è«‹å…ˆæ–°å¢ç¾¤çµ„</div>
                    </div>

                    <!-- Right: Product Pool Checkboxes -->
                    <div class="combo-item-pool" id="combo-item-pool-ui">
                        <div style="color:var(--text-muted); text-align:center; padding:30px; background:var(--bg-body); border-radius:12px;">é»é¸å·¦å´ç¾¤çµ„å¾Œï¼Œåœ¨æ­¤å‹¾é¸å…§å®¹</div>
                    </div>
                </div>
            </div>
        </div>
        <button onclick="saveComboProduct()" class="btn-submit" style="flex-shrink:0;">å®Œæˆä¸¦å„²å­˜å¥—é¤</button>
    </div>
</div>

<!-- Combo Customer Selection Modal -->
<div id="combo-select-modal" class="modal-overlay">
    <div class="modal-content modal-small">
        <div class="modal-header-modern">
            <h2 id="select-combo-title">é¸æ“‡å¥—é¤å…§å®¹</h2>
            <button class="close-icon-btn" onclick="closeModal('combo-select-modal')"><i class="ph ph-x"></i></button>
        </div>
        <div id="combo-selection-area" class="modal-body-scroll"></div>
        <button onclick="confirmComboSelection()" class="btn-submit" style="flex-shrink:0;"><i class="ph-bold ph-check"></i> ç¢ºèªåŠ å…¥æ¸…å–®</button>
    </div>
</div>

<script>
    // --- æ‰‹æ©Ÿç‰ˆè³¼ç‰©è»ŠæŠ½å±œåˆ‡æ›é‚è¼¯ ---
    function toggleMobileCart(show) {
        const drawer = document.getElementById('checkout-drawer');
        if (show) {
            drawer.classList.add('is-open');
        } else {
            drawer.classList.remove('is-open');
        }
    }

    // --- è¨Šæ¯ç­–ç•¥è¨­å®š (Notyf åˆå§‹åŒ– - æŸ”å’Œä¸”ç¾ä»£åŒ–çš„é…ç½®) ---
    const notyf = new Notyf({
        duration: 1500,
        position: { x: 'center', y: 'top' }, // CSS æœƒå¼·åˆ¶å°‡å…¶ç²¾æº–å‚ç›´æ°´å¹³ç½®ä¸­
        dismissible: false,
        ripple: false, // é—œé–‰æ°´æ³¢ç´‹ï¼Œæ•´é«”æ„Ÿè¦ºæ›´æ‰å¯¦ã€é«˜ç´š
        types: [
            { type: 'success', background: '#5A8F69', icon: false },
            { type: 'error', background: '#D96C6C', icon: false }
        ]
    });

    const firebaseConfig = {
        apiKey: "AIzaSyAomzzRW15uwRZ91jhgH6ZRFZA-ldT1iXY",
        authDomain: "yupin-pos.firebaseapp.com",
        databaseURL: "https://yupin-pos-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "yupin-pos",
        storageBucket: "yupin-pos.firebasestorage.app",
        messagingSenderId: "229501500357",
        appId: "1:229501500357:web:342f2c69ecb589da4569ac"
    };

    let db;
    let isOnline = false;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
        isOnline = true;
    } catch(e) {
        console.log("Firebaseæœªé…ç½®ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼");
    }

    let inv = [];
    let orders = [];
    let cart = [];
    let currentPay = 'ç¾é‡‘';

    // å®šç¾©å‹•æ…‹æ¡Œä½é™£åˆ—
    let tableCount = parseInt(localStorage.getItem('yupin_pos_table_count')) || 10;
    let ALL_TABLES = Array.from({length: tableCount}, (_, i) => (i + 1).toString());
    let activeTables = {}; // è¿½è¹¤æ­£åœ¨ä½¿ç”¨ä¸­çš„æ¡Œå­

    const defaultInv = [
        { cat: "æ‹›ç‰Œç©å¶", items: [{id: "A01", n: "ç¶“å…¸å°ç†Š", c: 100, p: 250, s: 10, type: "item"}] },
        { cat: "é£²å“", items: [
                {id: "D01", n: "æ¸…éŸ»é«˜å±±çƒé¾", c: 10, p: 50, s: 100, type: "item"},
                {id: "D02", n: "é›…éŸ»é«˜å±±çƒé¾", c: 12, p: 55, s: 100, type: "item"}
            ]},
        { cat: "ç”œé»", items: [
                {id: "C01", n: "ææ‹‰ç±³è˜‡", c: 40, p: 120, s: 50, type: "item"},
                {id: "C02", n: "å·´æ–¯å…‹", c: 35, p: 110, s: 50, type: "item"}
            ]}
    ];

    // --- System Login & Security Logic (Web Crypto Hash + Salt) ---
    const SALT = "YUPIN_POS_SECURE_SALT";

    async function hashPassword(pwd) {
        const msgBuffer = new TextEncoder().encode(pwd + SALT);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function initSystemPassword() {
        let storedHash = localStorage.getItem('yupin_pos_pwd_hash');
        if (!storedHash) {
            storedHash = await hashPassword('1234');
            localStorage.setItem('yupin_pos_pwd_hash', storedHash);
        }
    }
    initSystemPassword();

    document.getElementById('login-overlay').style.display = 'flex';

    async function checkSystemLogin() {
        const input = document.getElementById('login-pwd-input').value;
        if (!input) return notyf.error('è«‹è¼¸å…¥å¯†ç¢¼');

        const inputHash = await hashPassword(input);
        const storedHash = localStorage.getItem('yupin_pos_pwd_hash');

        if (inputHash === storedHash) {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('login-pwd-input').value = '';
            if (inv.length === 0) loadData();
        } else {
            notyf.error('å¯†ç¢¼ä¸æ­£ç¢º');
        }
    }

    let headerClickCount = 0;
    let headerClickTimer = null;
    function handleHeaderSecretClick() {
        headerClickCount++;
        if (headerClickCount === 1) {
            headerClickTimer = setTimeout(() => { headerClickCount = 0; }, 2000);
        }
        if (headerClickCount >= 5) {
            clearTimeout(headerClickTimer);
            headerClickCount = 0;
            promptChangePassword();
        }
    }

    function promptChangePassword() {
        Swal.fire({
            title: 'ç®¡ç†å“¡è¨­å®š',
            text: 'è«‹è¼¸å…¥æ–°çš„ç³»çµ±ç™»å…¥å¯†ç¢¼',
            input: 'password',
            inputPlaceholder: 'æ–°å¯†ç¢¼',
            showCancelButton: true,
            confirmButtonText: 'å„²å­˜è®Šæ›´',
            cancelButtonText: 'å–æ¶ˆ',
            heightAuto: false
        }).then(async (result) => {
            if (result.isConfirmed && result.value) {
                const newHash = await hashPassword(result.value);
                localStorage.setItem('yupin_pos_pwd_hash', newHash);
                notyf.success('ç³»çµ±å¯†ç¢¼å·²æ›´æ–°');
            }
        });
    }

    // --- Core Data Logic ---
    function loadData() {
        initTableSelect();

        if(isOnline) {
            db.ref('inventory').on('value', snap => {
                inv = snap.val() || defaultInv;
                initUI();
            });
            db.ref('orders').on('value', snap => {
                const data = snap.val();
                orders = data ? Object.keys(data).map(k => ({...data[k], firebaseKey: k})) : [];
                orders.sort((a,b) => (b.d+b.t).localeCompare(a.d+a.t));
                updateLog();
                renderStatTable();
            });
            db.ref('active_tables').on('value', snap => {
                activeTables = snap.val() || {};
                renderTableDashboard();
            });
            // åŒæ­¥é ç«¯æ¡Œæ•¸è¨­å®š
            db.ref('table_count').on('value', snap => {
                if(snap.exists()) {
                    tableCount = snap.val();
                    localStorage.setItem('yupin_pos_table_count', tableCount);
                    ALL_TABLES = Array.from({length: tableCount}, (_, i) => (i + 1).toString());
                    initTableSelect();
                    if(document.getElementById('table-area').style.display !== 'none') {
                        renderTableDashboard();
                    }
                }
            });
        } else {
            inv = defaultInv;
            activeTables = JSON.parse(localStorage.getItem('yupin_pos_active_tables') || '{}');
            initUI();
            renderTableDashboard();
        }
        updateSyncBtnState();
    }

    setInterval(() => {
        if(document.getElementById('table-area').style.display !== 'none') {
            renderTableDashboard();
        }
    }, 60000);

    // --- è¨­å®šæ¡Œæ•¸ ---
    function setTableCount() {
        Swal.fire({
            title: 'è¨­å®šé–€å¸‚æ¡Œæ•¸',
            input: 'number',
            inputLabel: 'è«‹è¼¸å…¥ç¸½æ¡Œæ•¸ (å°‡è‡ªå‹•ç”¢ç”Ÿ 1, 2, 3...)',
            inputValue: tableCount,
            showCancelButton: true,
            confirmButtonText: 'å„²å­˜',
            cancelButtonText: 'å–æ¶ˆ',
            heightAuto: false,
            inputValidator: (value) => {
                if (!value || value <= 0) return 'è«‹è¼¸å…¥å¤§æ–¼ 0 çš„æœ‰æ•ˆæ•¸å­—';
            }
        }).then((result) => {
            if (result.isConfirmed && result.value > 0) {
                tableCount = parseInt(result.value);
                localStorage.setItem('yupin_pos_table_count', tableCount);
                ALL_TABLES = Array.from({length: tableCount}, (_, i) => (i + 1).toString());

                if (isOnline) {
                    db.ref('table_count').set(tableCount);
                }

                initTableSelect();
                if(document.getElementById('table-area').style.display !== 'none') {
                    renderTableDashboard();
                }
                notyf.success(`å·²æ›´æ–°ç‚º ${tableCount} æ¡Œ`);
            }
        });
    }

    // --- Sync Logic (Atomic Updates) ---
    function updateSyncBtnState() {
        const localOrders = JSON.parse(localStorage.getItem('little_nook_offline_orders') || '[]');
        const btn = document.getElementById('sync-btn');
        if (localOrders.length > 0) {
            btn.innerHTML = `<i class="ph-bold ph-warning-circle"></i> <b>${localOrders.length}</b> ç­†æœªåŒæ­¥`;
            btn.classList.add('has-data');
        } else {
            btn.innerHTML = `<i class="ph-bold ph-cloud-arrow-up"></i> é›²ç«¯åŒæ­¥`;
            btn.classList.remove('has-data');
        }
    }

    function syncOfflineData() {
        if(!isOnline) {
            notyf.error('æœªé€£æ¥åˆ° Firebase è³‡æ–™åº«');
            return;
        }

        const localOrders = JSON.parse(localStorage.getItem('little_nook_offline_orders') || '[]');

        if (localOrders.length === 0) {
            let updates = {};
            updates['/inventory'] = inv;
            updates['/active_tables'] = activeTables;
            updates['/table_count'] = tableCount;
            db.ref().update(updates).then(() => notyf.success('ç³»çµ±è¨­å®šèˆ‡æ¡Œæ³å·²åŒæ­¥'));
            return;
        }

        Swal.fire({
            title: 'æº–å‚™åŒæ­¥',
            text: `ç™¼ç¾ ${localOrders.length} ç­†é›¢ç·šè¨‚å–®ï¼Œç¢ºå®šä¸Šå‚³ï¼Ÿ`,
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: 'ç«‹å³åŒæ­¥',
            showLoaderOnConfirm: true,
            heightAuto: false,
            preConfirm: () => {
                let updates = {};
                let localDeductions = {};

                localOrders.forEach(order => {
                    const newKey = db.ref('orders').push().key;
                    updates['/orders/' + newKey] = order;

                    order.items.forEach(cartItem => {
                        if(cartItem.id === "æ”¯å‡º") return;
                        const ids = (cartItem.type === 'combo' && cartItem.comboDeductionIds) ? cartItem.comboDeductionIds : [cartItem.id];
                        ids.forEach(subId => {
                            localDeductions[subId] = (localDeductions[subId] || 0) + 1;
                        });
                    });
                });

                for(let subId in localDeductions) {
                    for (let c = 0; c < inv.length; c++) {
                        for (let i = 0; i < (inv[c].items || []).length; i++) {
                            if (inv[c].items[i].id === subId) {
                                updates[`/inventory/${c}/items/${i}/s`] = firebase.database.ServerValue.increment(-localDeductions[subId]);
                            }
                        }
                    }
                }

                updates['/active_tables'] = activeTables;
                updates['/table_count'] = tableCount;

                return db.ref().update(updates)
                    .then(() => {
                        localStorage.removeItem('little_nook_offline_orders');
                        updateSyncBtnState();
                    })
                    .catch(error => {
                        Swal.showValidationMessage(`åŒæ­¥å¤±æ•—: ${error}`);
                    });
            },
            allowOutsideClick: () => !Swal.isLoading()
        }).then((result) => {
            if (result.isConfirmed) {
                notyf.success('é›¢ç·šè¨‚å–®å·²ä¸Šå‚³ï¼Œåº«å­˜èˆ‡æ¡Œæ³å·²æ›´æ–°');
            }
        });
    }

    // --- View Toggle Logic ---
    function toggleView(view) {
        const itemArea = document.getElementById('item-area');
        const tableArea = document.getElementById('table-area');
        const btnMenu = document.getElementById('btn-nav-menu');
        const btnTables = document.getElementById('btn-nav-tables');

        if (view === 'tables') {
            itemArea.style.display = 'none';
            tableArea.style.display = 'block';
            if(btnMenu) {
                btnMenu.style.background = 'var(--bg-card)';
                btnMenu.style.color = 'var(--text-main)';
                btnMenu.style.border = '1px solid var(--border-soft)';
            }
            if(btnTables) {
                btnTables.style.background = 'var(--primary)';
                btnTables.style.color = 'white';
                btnTables.style.border = 'none';
            }
            renderTableDashboard();
        } else {
            itemArea.style.display = 'block';
            tableArea.style.display = 'none';
            if(btnTables) {
                btnTables.style.background = 'var(--bg-card)';
                btnTables.style.color = 'var(--text-main)';
                btnTables.style.border = '1px solid var(--border-soft)';
            }
            if(btnMenu) {
                btnMenu.style.background = 'var(--primary)';
                btnMenu.style.color = 'white';
                btnMenu.style.border = 'none';
            }
        }
    }

    // --- Init Table Selector ---
    function initTableSelect() {
        const sel = document.getElementById('checkout-table');
        sel.innerHTML = '<option value="" disabled selected hidden>-- é¸æ“‡æ¡Œè™Ÿ --</option>' +
            ALL_TABLES.map(t => `<option value="${t}">${t}</option>`).join('');
    }

    // --- Table Dashboard UI ---
    function renderTableDashboard() {
        const area = document.getElementById('table-area');
        if(!area) return;

        let html = `<h2 style="margin-top:0; color:var(--text-main); font-size:1.4em; display:flex; align-items:center; gap:8px;"><i class="ph-bold ph-armchair"></i> é–€å¸‚æ¡Œæ³ç›£æ§</h2><div class="table-grid">`;
        const now = Date.now();

        ALL_TABLES.forEach(tName => {
            const tableData = activeTables[tName];

            if (tableData && tableData.items && tableData.items.length > 0) {
                const elapsedMins = Math.floor((now - tableData.startTime) / 60000);
                let colorClass = 't-green';
                if (elapsedMins >= 120) colorClass = 't-red-blink';
                else if (elapsedMins >= 90) colorClass = 't-yellow';

                let totalItems = tableData.items.length;
                let unservedItems = tableData.items.filter(it => !it.served).length;
                let serveStatusText = unservedItems === 0 ? `<span style="color:#22543D;"><i class="ph-bold ph-check-circle"></i> å…¨ä¸Š</span>` : `<span style="color:#742A2A;"><i class="ph-bold ph-hourglass-high"></i> å‰© ${unservedItems} é …</span>`;

                html += `
                    <div class="t-card ${colorClass}" onclick="openTableDetails('${tName}')">
                        <div class="t-name">æ¡Œè™Ÿ ${tName}</div>
                        <div class="t-time"><i class="ph-bold ph-timer"></i> ${elapsedMins} åˆ†é˜</div>
                        <div class="t-items"><span>å…± ${totalItems} é …</span><span>${serveStatusText}</span></div>
                    </div>`;
            } else {
                html += `
                    <div class="t-card t-empty" onclick="notyf.success('æ­¤æ¡Œç›®å‰ç©ºé–’')">
                        <div class="t-name">æ¡Œè™Ÿ ${tName}</div>
                        <div class="t-time" style="background:transparent; color:var(--text-muted); box-shadow:none;">ç©ºæ¡Œ</div>
                    </div>`;
            }
        });
        html += '</div>';
        area.innerHTML = html;
    }

    function openTableDetails(tName) {
        const data = activeTables[tName];
        if(!data) return;

        const elapsedMins = Math.floor((Date.now() - data.startTime) / 60000);
        const startStr = new Date(data.startTime).toLocaleTimeString('zh-TW', {hour12:false});
        let colorStyle = elapsedMins >= 120 ? 'color:var(--danger-red);' : (elapsedMins >= 90 ? 'color:#D69E2E;' : 'color:var(--accent-green);');

        let unservedCount = data.items.filter(it => !it.served).length;
        let allServed = unservedCount === 0 && data.items.length > 0;

        let itemsHtml = data.items.map((it, i) => `
            <div class="td-item-row ${it.served ? 'is-served' : ''}">
                <div style="flex:1; padding-right:10px;">
                    <div style="font-weight:700; font-size:1.1em; ${it.served ? 'text-decoration:line-through; color:var(--text-muted);' : 'color:var(--text-main);'}">${it.n}</div>
                    ${it.comboDetail ? `<div style="font-size:0.85em; color:var(--text-muted); margin-top:4px;"><i class="ph-bold ph-arrow-elbow-down-right"></i> ${it.comboDetail}</div>` : ''}
                </div>
                <div class="td-item-right">
                    <div style="font-weight:700; color:var(--primary); font-size:1.1em;">$${it.p}</div>
                    <label class="serve-cb-wrapper ${it.served ? 'served' : ''}">
                        <input type="checkbox" class="serve-cb" ${it.served ? 'checked' : ''} onchange="toggleItemServed('${tName}', ${i}, this.checked)">
                        <span>${it.served ? 'å·²å‡º' : 'å‡ºé¤'}</span>
                    </label>
                </div>
            </div>
        `).join('');

        document.getElementById('td-modal-title').innerHTML = `<i class="ph-bold ph-armchair"></i> æ¡Œè™Ÿ ${tName} - å…¨å–®æ˜ç´°`;
        document.getElementById('td-modal-info').innerHTML = `
            <div style="display:flex; justify-content:space-between; font-size:1.05em;">
                <span>å…¥åº§ï¼š${startStr}</span>
                <span style="${colorStyle}">å·²å…¥åº§ï¼š${elapsedMins} åˆ†é˜</span>
            </div>
            ${allServed ? `<div style="margin-top:12px; color:var(--accent-green); text-align:center; display:flex; align-items:center; justify-content:center; gap:6px;"><i class="ph-fill ph-check-circle"></i> å…¨æ•¸é¤é»å·²å‡ºé½Š</div>` : `<div style="margin-top:12px; color:var(--danger-red); text-align:center; display:flex; align-items:center; justify-content:center; gap:6px;"><i class="ph-bold ph-hourglass-high"></i> å°šæœ‰ ${unservedCount} é …æœªå‡ºé¤</div>`}
        `;
        document.getElementById('td-modal-items').innerHTML = itemsHtml;

        document.getElementById('td-modal-clear-btn').onclick = () => clearTable(tName);

        openModal('table-details-modal');
    }

    // --- Serve Item Toggle Logic ---
    window.toggleItemServed = function(tName, itemIdx, isServed) {
        if(!activeTables[tName] || !activeTables[tName].items[itemIdx]) return;

        activeTables[tName].items[itemIdx].served = isServed;

        if (isOnline) {
            db.ref('/active_tables/' + tName + '/items/' + itemIdx + '/served').set(isServed);
        } else {
            localStorage.setItem('yupin_pos_active_tables', JSON.stringify(activeTables));
        }

        openTableDetails(tName);
        renderTableDashboard();
    };

    function clearTable(tName) {
        Swal.fire({
            title: `ç¢ºå®šæ¸…ç©ºæ¡Œè™Ÿ ${tName}ï¼Ÿ`,
            text: 'å®¢äººå·²é›¢å ´ï¼Ÿé€™å°‡æœƒæŠŠæ¡Œä½è®Šå›ç©ºæ¡Œç‹€æ…‹ï¼Œä¸æœƒå½±éŸ¿å·²çµå¸³çš„æ­·å²ç‡Ÿæ”¶',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#D96C6C',
            confirmButtonText: 'ç¢ºå®šæ¸…ç©º',
            cancelButtonText: 'å–æ¶ˆ',
            heightAuto: false
        }).then(res => {
            if(res.isConfirmed) {
                if (isOnline) {
                    db.ref('/active_tables/' + tName).remove().then(() => {
                        notyf.success(`æ¡Œè™Ÿ ${tName} å·²æ¸…ç©º`);
                        closeModal('table-details-modal');
                    });
                } else {
                    delete activeTables[tName];
                    localStorage.setItem('yupin_pos_active_tables', JSON.stringify(activeTables));
                    renderTableDashboard();
                    notyf.success(`æ¡Œè™Ÿ ${tName} å·²æ¸…ç©º (é›¢ç·š)`);
                    closeModal('table-details-modal');
                }
            }
        });
    }

    // --- UI Rendering (Products) ---
    function initUI() {
        const area = document.getElementById('item-area');
        area.innerHTML = '';

        inv.forEach((cat, idx) => {
            let gridHtml = `<div class="cat-title" id="c${idx}"><i class="ph-fill ph-tag"></i> ${cat.cat}</div><div class="product-grid">`;
            if(!cat.items || cat.items.length === 0) {
                gridHtml += `<div style="color:var(--text-muted); padding:10px;">æ­¤åˆ†é¡æš«ç„¡å•†å“</div>`;
            } else {
                cat.items.forEach((it, itemIdx) => {
                    const isCombo = it.type === 'combo';
                    gridHtml += `<div class="p-btn ${isCombo ? 'combo-item' : ''}" onclick="addCartClick(${idx}, ${itemIdx})">
                        ${isCombo ? '<span class="combo-badge">å¥—é¤</span>' : ''}
                        <div class="p-name">${it.n}</div>
                        <div class="p-price">$${it.p}</div>
                        <div class="p-stock">${isCombo ? 'è‡ªé¸' : 'å­˜:'+it.s}</div>
                    </div>`;
                });
            }
            area.innerHTML += gridHtml + '</div>';
        });

        updateCatSelect('single-cat');
        updateCatSelect('combo-cat');

        if(document.getElementById('admin-panel').style.display === 'flex') renderAdminTable();
    }

    function openModal(id) {
        document.getElementById(id).style.display = 'flex';
        if(id === 'admin-panel') renderAdminTable();
    }
    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
    }

    function openHistoryPanel() {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        const todayStr = `${yyyy}-${mm}-${dd}`;

        document.getElementById('search-date').value = todayStr;
        openModal('history-panel');
        searchHistory('day');
    }

    function openAddSingleModal() {
        document.getElementById('single-id').value = '';
        document.getElementById('single-name').value = '';
        document.getElementById('single-price').value = '';
        document.getElementById('single-cost').value = '';
        document.getElementById('single-stock').value = '99';
        updateCatSelect('single-cat');
        openModal('modal-single-product');
    }

    function saveSingleProduct() {
        const catN = document.getElementById('single-cat').value;
        const n = document.getElementById('single-name').value;
        const p = Number(document.getElementById('single-price').value);
        const c = Number(document.getElementById('single-cost').value);
        const s = Number(document.getElementById('single-stock').value);
        let id = document.getElementById('single-id').value;

        if(!n || !catN) return notyf.error('è«‹å¡«å¯«åˆ†é¡èˆ‡åç¨±');

        const category = inv.find(v => v.cat === catN);
        if(category) {
            if(!category.items) category.items = [];
            if(!id) id = Date.now().toString().slice(-4);
            category.items.push({ id, n, c, p, s, type: 'item' });

            if (isOnline) {
                db.ref('inventory').set(inv).then(() => {
                    closeModal('modal-single-product');
                    notyf.success('å•†å“å·²æ–°å¢');
                });
            } else {
                closeModal('modal-single-product');
                notyf.success('å•†å“å·²æ–°å¢ (é›¢ç·š)');
                initUI();
            }
        }
    }

    let tempComboSpecs = [];
    let tempActiveGroupIdx = -1;

    function openAddComboModal() {
        document.getElementById('combo-name').value = '';
        document.getElementById('combo-price').value = '';
        document.getElementById('combo-id').value = '';
        updateCatSelect('combo-cat');
        tempComboSpecs = [];
        tempActiveGroupIdx = -1;
        renderComboConfigUI();
        openModal('modal-combo-product');
    }

    function addComboGroup() {
        const name = document.getElementById('combo-group-input').value.trim();
        if(!name) return notyf.error('è«‹è¼¸å…¥ç¾¤çµ„åç¨±');
        tempComboSpecs.push({ title: name, options: [] });
        document.getElementById('combo-group-input').value = '';
        tempActiveGroupIdx = tempComboSpecs.length - 1;
        renderComboConfigUI();
    }

    function setComboActiveGroup(idx) {
        tempActiveGroupIdx = idx;
        renderComboConfigUI();
    }

    function toggleItemInCombo(id, checked) {
        if(tempActiveGroupIdx === -1) return;
        const group = tempComboSpecs[tempActiveGroupIdx];
        if(checked) {
            if(!group.options.includes(id)) group.options.push(id);
        } else {
            group.options = group.options.filter(x => x !== id);
        }
        renderComboConfigUI();
    }

    function renderComboConfigUI() {
        const listEl = document.getElementById('combo-group-list-ui');
        if(tempComboSpecs.length === 0) {
            listEl.innerHTML = '<div style="color:var(--text-muted); text-align:center; padding:20px;">è«‹å…ˆæ–°å¢ç¾¤çµ„</div>';
        } else {
            listEl.innerHTML = tempComboSpecs.map((g, idx) => `
                <div class="group-card ${idx === tempActiveGroupIdx ? 'active' : ''}" onclick="setComboActiveGroup(${idx})">
                    <div style="font-weight:700;">${g.title}</div>
                    <div style="font-size:0.85em; color:var(--text-muted); margin-top:4px;">å·²é¸ ${g.options.length} é …</div>
                    <div style="text-align:right; font-size:0.85em; color:var(--danger-red); margin-top:8px;" onclick="event.stopPropagation(); removeComboGroup(${idx})"><i class="ph-bold ph-trash"></i> åˆªé™¤</div>
                </div>
            `).join('');
        }

        const poolEl = document.getElementById('combo-item-pool-ui');
        if(tempActiveGroupIdx === -1) {
            poolEl.innerHTML = '<div style="color:var(--text-muted); text-align:center; padding:20px;">è«‹é»é¸å·¦å´ç¾¤çµ„ä»¥å‹¾é¸å…§å®¹</div>';
            return;
        }

        const currentOptions = tempComboSpecs[tempActiveGroupIdx].options;
        let html = '';
        inv.forEach(cat => {
            let catHtml = `<div style="font-weight:700; margin:12px 0 8px; color:var(--text-main);"><i class="ph-fill ph-tag"></i> ${cat.cat}</div><div class="checkbox-grid">`;
            let hasItems = false;
            (cat.items || []).forEach(item => {
                if(item.type === 'combo') return;
                hasItems = true;
                const isChecked = currentOptions.includes(item.id);
                catHtml += `
                    <label class="check-item">
                        <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleItemInCombo('${item.id}', this.checked)">
                        <span>${item.n}</span>
                    </label>`;
            });
            catHtml += '</div>';
            if(hasItems) html += catHtml;
        });
        poolEl.innerHTML = html;
    }

    function removeComboGroup(idx) {
        tempComboSpecs.splice(idx, 1);
        tempActiveGroupIdx = -1;
        renderComboConfigUI();
    }

    function saveComboProduct() {
        const catN = document.getElementById('combo-cat').value;
        const n = document.getElementById('combo-name').value;
        const p = Number(document.getElementById('combo-price').value);
        let id = document.getElementById('combo-id').value;

        if(!n || !catN) return notyf.error('è«‹å¡«å¯«åˆ†é¡èˆ‡åç¨±');
        if(tempComboSpecs.length === 0) return notyf.error('å¥—é¤è‡³å°‘éœ€è¦ä¸€å€‹å…§å®¹ç¾¤çµ„');

        const category = inv.find(v => v.cat === catN);
        if(category) {
            if(!category.items) category.items = [];
            if(!id) id = Date.now().toString().slice(-4);

            category.items.push({
                id, n, p, c:0, s:0,
                type: 'combo',
                comboSpecs: tempComboSpecs
            });

            if (isOnline) {
                db.ref('inventory').set(inv).then(() => {
                    closeModal('modal-combo-product');
                    notyf.success('å¥—é¤å·²å»ºç«‹');
                });
            } else {
                closeModal('modal-combo-product');
                notyf.success('å¥—é¤å·²å»ºç«‹ (é›¢ç·š)');
                initUI();
            }
        }
    }

    function updateCatSelect(id) {
        const sel = document.getElementById(id);
        if(!sel) return;
        sel.innerHTML = inv.map(c => `<option value="${c.cat}">${c.cat}</option>`).join('') +
            `<option value="ADD">â• æ–°å¢åˆ†é¡...</option>`;
    }

    function checkNewCat(val, id) {
        if(val === "ADD") {
            Swal.fire({
                title: 'æ–°å¢åˆ†é¡',
                input: 'text',
                inputLabel: 'è«‹è¼¸å…¥åˆ†é¡åç¨±',
                showCancelButton: true,
                heightAuto: false
            }).then((result) => {
                if(result.isConfirmed && result.value) {
                    inv.push({cat: result.value, items: []});
                    if(isOnline) db.ref('inventory').set(inv);

                    setTimeout(() => {
                        updateCatSelect('single-cat');
                        updateCatSelect('combo-cat');
                        document.getElementById(id).value = result.value;
                    }, 500);
                } else {
                    document.getElementById(id).selectedIndex = 0;
                }
            });
        }
    }

    function renderAdminTable() {
        let html = `<thead><tr><th style="width:40px;"></th><th>å“å</th><th>æˆæœ¬</th><th>å”®åƒ¹</th><th>åº«å­˜/å…§å®¹</th><th>åˆª</th></tr></thead>`;
        inv.forEach((cat, ci) => {
            html += `<tbody>`;
            html += `<tr id="ac${ci}" class="cat-header-row">
                <td colspan="6" style="text-align:left; padding:14px;">
                    <b style="font-size:1.1em; color:var(--primary); display:inline-flex; align-items:center; gap:6px;"><i class="ph-fill ph-folder-open"></i> ${cat.cat}</b>
                    <button class="btn-setting" style="margin-left:12px; padding:6px 10px;" onclick="editCategoryName(${ci})"><i class="ph-bold ph-pencil-simple"></i></button>
                    <button class="btn-setting" style="color:var(--danger-red); padding:6px 10px;" onclick="deleteCategory(${ci})"><i class="ph-bold ph-trash"></i></button>
                </td>
            </tr>`;
            (cat.items || []).forEach((it, ii) => {
                const isCombo = it.type === 'combo';
                html += `<tr draggable="true" data-cat="${ci}" data-idx="${ii}" class="draggable-row">
                    <td><span class="drag-handle"><i class="ph-bold ph-dots-six-vertical"></i></span></td>
                    <td style="text-align:left;"><input type="text" value="${it.n}" onchange="editItem(${ci},${ii},'n',this.value)" class="admin-table-input"></td>
                    <td>${isCombo ? '-' : `<input type="number" value="${it.c}" onchange="editItem(${ci},${ii},'c',this.value)" class="admin-table-input" style="width:70px;">`}</td>
                    <td><input type="number" value="${it.p}" onchange="editItem(${ci},${ii},'p',this.value)" class="admin-table-input" style="width:70px;"></td>
                    <td>
                        ${isCombo
                    ? `<button onclick="editComboSpecs(${ci},${ii})" class="btn-setting"><i class="ph-bold ph-gear"></i> å…§å®¹</button>`
                    : `<input type="number" value="${it.s}" onchange="editItem(${ci},${ii},'s',this.value)" class="admin-table-input" style="width:70px;">`}
                    </td>
                    <td><span onclick="delP(${ci},${ii})" class="del-x"><i class="ph-bold ph-trash"></i></span></td>
                </tr>`;
            });
            html += `</tbody>`;
        });
        const table = document.getElementById('admin-main-table');
        table.innerHTML = html;

        const rows = table.querySelectorAll('.draggable-row');
        rows.forEach(row => {
            row.addEventListener('dragstart', handleDragStart);
            row.addEventListener('dragover', handleDragOver);
            row.addEventListener('drop', handleDrop);
            row.addEventListener('dragend', handleDragEnd);
        });

        const handles = table.querySelectorAll('.drag-handle');
        handles.forEach(handle => {
            handle.addEventListener('touchstart', handleTouchStart, {passive: false});
            handle.addEventListener('touchmove', handleTouchMove, {passive: false});
            handle.addEventListener('touchend', handleTouchEnd);
        });
    }

    let dragSrcEl = null;

    function handleDragStart(e) {
        dragSrcEl = this;
        e.dataTransfer.effectAllowed = 'move';
        this.classList.add('dragging');
    }

    function handleDragOver(e) {
        if (e.preventDefault) e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        return false;
    }

    function handleDrop(e) {
        if (e.stopPropagation) e.stopPropagation();

        let target = e.target.closest('tr');
        if (dragSrcEl !== target && target.classList.contains('draggable-row')) {
            const srcCat = dragSrcEl.dataset.cat;
            const srcIdx = parseInt(dragSrcEl.dataset.idx);
            const tgtCat = target.dataset.cat;
            const tgtIdx = parseInt(target.dataset.idx);

            if (srcCat === tgtCat) {
                const items = inv[srcCat].items;
                const [movedItem] = items.splice(srcIdx, 1);
                items.splice(tgtIdx, 0, movedItem);

                if(isOnline) db.ref('inventory').set(inv);
                renderAdminTable();
            } else {
                notyf.error('åªèƒ½åœ¨åŒä¸€åˆ†é¡å…§èª¿æ•´é †åº');
            }
        }
        return false;
    }

    function handleDragEnd(e) {
        this.classList.remove('dragging');
    }

    // --- Mobile Touch Event Handlers for Drag and Drop ---
    function handleTouchStart(e) {
        dragSrcEl = this.closest('tr');
        dragSrcEl.classList.add('dragging');

        const clone = dragSrcEl.cloneNode(true);
        const tableWrapper = document.createElement('table');
        tableWrapper.id = 'touch-drag-clone';

        const originalTable = document.getElementById('admin-main-table');
        tableWrapper.style.cssText = `
            position: fixed; pointer-events: none; z-index: 9999; opacity: 0.95;
            box-shadow: var(--shadow-float); background: white;
            border-collapse: collapse; width: ${originalTable.getBoundingClientRect().width}px;
            border-radius: var(--radius-md); overflow: hidden;
        `;

        const tbody = document.createElement('tbody');
        tbody.appendChild(clone);
        tableWrapper.appendChild(tbody);

        Array.from(dragSrcEl.children).forEach((td, i) => {
            clone.children[i].style.width = td.getBoundingClientRect().width + 'px';
            clone.children[i].style.boxSizing = 'border-box';
        });

        document.body.appendChild(tableWrapper);

        const touch = e.touches[0];
        const rect = dragSrcEl.getBoundingClientRect();

        dragSrcEl._touchOffsetX = touch.clientX - rect.left;
        dragSrcEl._touchOffsetY = touch.clientY - rect.top;

        tableWrapper.style.left = rect.left + 'px';
        tableWrapper.style.top = rect.top + 'px';
    }

    function handleTouchMove(e) {
        if (!dragSrcEl) return;
        e.preventDefault();

        const touch = e.touches[0];
        const cloneTable = document.getElementById('touch-drag-clone');

        if (cloneTable) {
            cloneTable.style.left = (touch.clientX - dragSrcEl._touchOffsetX) + 'px';
            cloneTable.style.top = (touch.clientY - dragSrcEl._touchOffsetY) + 'px';
        }

        const targetEl = document.elementFromPoint(touch.clientX, touch.clientY);
        if (!targetEl) return;

        const targetRow = targetEl.closest('tr.draggable-row');

        const rows = document.querySelectorAll('.draggable-row');
        rows.forEach(r => {
            r.style.borderTop = '';
            r.style.borderBottom = '';
        });

        if (targetRow && targetRow !== dragSrcEl && targetRow.dataset.cat === dragSrcEl.dataset.cat) {
            const srcIdx = parseInt(dragSrcEl.dataset.idx);
            const tgtIdx = parseInt(targetRow.dataset.idx);

            if (tgtIdx < srcIdx) {
                targetRow.style.borderTop = '2px solid var(--primary)';
            } else {
                targetRow.style.borderBottom = '2px solid var(--primary)';
            }
        }
    }

    function handleTouchEnd(e) {
        if (!dragSrcEl) return;
        dragSrcEl.classList.remove('dragging');

        const cloneTable = document.getElementById('touch-drag-clone');
        if (cloneTable) cloneTable.remove();

        const touch = e.changedTouches[0];
        const targetEl = document.elementFromPoint(touch.clientX, touch.clientY);

        const rows = document.querySelectorAll('.draggable-row');
        rows.forEach(r => {
            r.style.borderTop = '';
            r.style.borderBottom = '';
        });

        if (targetEl) {
            const targetRow = targetEl.closest('tr.draggable-row');
            if (targetRow && targetRow !== dragSrcEl) {
                const srcCat = dragSrcEl.dataset.cat;
                const srcIdx = parseInt(dragSrcEl.dataset.idx);
                const tgtCat = targetRow.dataset.cat;
                const tgtIdx = parseInt(targetRow.dataset.idx);

                if (srcCat === tgtCat) {
                    const items = inv[srcCat].items;
                    const [movedItem] = items.splice(srcIdx, 1);
                    items.splice(tgtIdx, 0, movedItem);

                    if(isOnline) db.ref('inventory').set(inv);
                    renderAdminTable();
                } else {
                    notyf.error('åªèƒ½åœ¨åŒä¸€åˆ†é¡å…§èª¿æ•´é †åº');
                }
            }
        }
        dragSrcEl = null;
    }

    function editComboSpecs(ci, ii) {
        const item = inv[ci].items[ii];
        document.getElementById('combo-name').value = item.n;
        document.getElementById('combo-price').value = item.p;
        document.getElementById('combo-id').value = item.id;
        document.getElementById('combo-cat').value = inv[ci].cat;

        tempComboSpecs = JSON.parse(JSON.stringify(item.comboSpecs || []));
        tempActiveGroupIdx = tempComboSpecs.length > 0 ? 0 : -1;
        renderComboConfigUI();

        const btn = document.querySelector('#modal-combo-product .btn-submit');
        const oldText = btn.innerHTML;
        const oldOnClick = btn.onclick;

        btn.innerHTML = "<i class='ph-bold ph-check'></i> æ›´æ–°å¥—é¤";
        btn.onclick = function() {
            item.n = document.getElementById('combo-name').value;
            item.p = Number(document.getElementById('combo-price').value);
            item.id = document.getElementById('combo-id').value;
            item.comboSpecs = tempComboSpecs;

            if(isOnline) db.ref('inventory').set(inv);

            closeModal('modal-combo-product');
            notyf.success('å¥—é¤å…§å®¹å·²æ›´æ–°');

            btn.innerHTML = oldText;
            btn.onclick = oldOnClick;
        };

        openModal('modal-combo-product');
    }

    function editItem(ci, ii, k, v) {
        inv[ci].items[ii][k] = (k==='n'?v:Number(v));
        if(isOnline) db.ref('inventory').set(inv);
    }

    function delP(ci, ii) {
        Swal.fire({ title: 'ç¢ºå®šåˆªé™¤?', text: "æ­¤æ“ä½œç„¡æ³•å¾©åŸ", icon: 'warning', showCancelButton: true, confirmButtonColor: '#D96C6C', heightAuto: false }).then((res) => {
            if(res.isConfirmed) {
                inv[ci].items.splice(ii,1);
                if(isOnline) db.ref('inventory').set(inv);
                renderAdminTable();
            }
        });
    }

    function deleteCategory(ci) {
        Swal.fire({ title: `åˆªé™¤åˆ†é¡ã€Œ${inv[ci].cat}ã€?`, text: "åˆ†é¡ä¸‹æ‰€æœ‰å•†å“ä¹Ÿæœƒæ¶ˆå¤±", icon: 'warning', showCancelButton: true, confirmButtonColor: '#D96C6C', heightAuto: false }).then((res) => {
            if(res.isConfirmed) {
                inv.splice(ci, 1);
                if(inv.length === 0) inv = [{cat: "é è¨­åˆ†é¡", items: []}];
                if(isOnline) db.ref('inventory').set(inv);
                renderAdminTable();
                initUI();
            }
        });
    }

    function editCategoryName(ci) {
        Swal.fire({ title: 'ä¿®æ”¹åˆ†é¡åç¨±', input: 'text', inputValue: inv[ci].cat, showCancelButton: true, heightAuto: false }).then((res)=>{
            if(res.isConfirmed && res.value) {
                inv[ci].cat = res.value;
                if(isOnline) db.ref('inventory').set(inv);
                renderAdminTable(); initUI();
            }
        });
    }

    // --- POS Front-end Logic ---
    let pendingCombo = null;

    function addCartClick(catIdx, itemIdx) {
        const item = inv[catIdx].items[itemIdx];
        if (item.type === 'combo') {
            openComboSelectModal(item);
        } else {
            addCartDirect(item);
        }
    }

    function addCartDirect(item) {
        if(item.s <= 0) {
            Swal.fire({ title: 'åº«å­˜ä¸è¶³', text: 'ä»è¦åŠ å…¥è³¼ç‰©è»Šå—ï¼Ÿ', icon: 'question', showCancelButton: true, heightAuto: false }).then((res)=>{
                if(res.isConfirmed) { cart.push({...item}); renderCart(); }
            });
            return;
        }
        cart.push({...item});
        renderCart();
    }

    function openComboSelectModal(item) {
        if (!item.comboSpecs || item.comboSpecs.length === 0) {
            notyf.error('æ­¤å¥—é¤å°šæœªè¨­å®šå…§å®¹');
            return;
        }
        pendingCombo = { ...item, selection: {} };
        const modal = document.getElementById('combo-select-modal');
        const area = document.getElementById('combo-selection-area');
        document.getElementById('select-combo-title').innerHTML = `<i class="ph-bold ph-squares-four"></i> é¸æ“‡ï¼š${item.n}`;
        modal.style.display = 'flex';

        let html = '';
        item.comboSpecs.forEach((group, gIdx) => {
            html += `<div class="combo-select-step">
                <div class="combo-step-title"><i class="ph-bold ph-check-circle"></i> æ­¥é©Ÿ ${gIdx+1}: ${group.title}</div>
                <div style="display:flex; flex-wrap:wrap; gap:10px;">`;

            group.options.forEach(optId => {
                const targetItem = findItemById(optId);
                if (targetItem) {
                    const stockText = targetItem.s <= 0 ? ' (ç¼ºè²¨)' : '';
                    const styleClass = targetItem.s <= 0 ? 'combo-option disabled' : 'combo-option';
                    html += `<span class="${styleClass}" onclick="selectComboOption('${group.title}', '${optId}', this)">
                        ${targetItem.n}${stockText}
                    </span>`;
                }
            });
            html += `</div></div>`;
        });
        area.innerHTML = html;
    }

    function selectComboOption(groupTitle, optId, el) {
        if (el.classList.contains('disabled')) return;
        const siblings = el.parentNode.children;
        for (let i=0; i<siblings.length; i++) siblings[i].classList.remove('selected');
        el.classList.add('selected');
        pendingCombo.selection[groupTitle] = optId;
    }

    function confirmComboSelection() {
        const specs = pendingCombo.comboSpecs;
        for (let spec of specs) {
            if (!pendingCombo.selection[spec.title]) {
                notyf.error(`è«‹é¸æ“‡ï¼š${spec.title}`);
                return;
            }
        }

        const detailNames = [];
        const detailIds = [];
        for (let key in pendingCombo.selection) {
            const iId = pendingCombo.selection[key];
            const item = findItemById(iId);
            if(item) {
                detailNames.push(item.n);
                detailIds.push(iId);
            }
        }

        cart.push({
            ...pendingCombo,
            comboDetail: detailNames.join(' + '),
            comboDeductionIds: detailIds
        });

        closeModal('combo-select-modal');
        renderCart();
    }

    function findItemById(id) {
        for (let c of inv) {
            for (let i of c.items) {
                if (i.id === id) return i;
            }
        }
        return null;
    }

    function renderCart() {
        document.getElementById('cart-list').innerHTML = cart.map((it, i) => `
            <div class="cart-item">
                <div style="flex:1;">
                    <div style="font-weight:600; color:var(--text-main);">${it.n}</div>
                    ${it.comboDetail ? `<span class="cart-details"><i class="ph-bold ph-arrow-elbow-down-right"></i> ${it.comboDetail}</span>` : ''}
                </div>
                <b style="color:var(--primary); font-size:1.1em;">$${it.p}</b>
                <span onclick="cart.splice(${i},1);renderCart()" style="color:var(--danger-red); cursor:pointer; margin-left:16px; padding:4px;"><i class="ph-bold ph-trash"></i></span>
            </div>`).join('');
        calc();

        const mobileCount = document.getElementById('mobile-cart-count');
        if(mobileCount) mobileCount.innerText = cart.length;
    }

    function calc() {
        const total = cart.reduce((a,b)=>a+b.p, 0) - Number(document.getElementById('discount').value || 0);
        const finalT = Math.max(0, total);
        document.getElementById('final-total').innerText = finalT;
        const mobileTotal = document.getElementById('mobile-cart-total');
        if(mobileTotal) mobileTotal.innerText = finalT;

        calcChange();
    }

    function calcChange() {
        const t = Number(document.getElementById('final-total').innerText), p = Number(document.getElementById('cash-in').value || 0);
        document.getElementById('cash-change').innerText = p > t ? p - t : 0;
    }

    function setPay(m) {
        currentPay = m;
        document.getElementById('btn-cash').className = m==='ç¾é‡‘'?'pay-btn active':'pay-btn';
        document.getElementById('btn-elec').className = m==='é›»æ”¯'?'pay-btn active':'pay-btn';
    }

    // --- Atomic Submit Order & Auto-Restock Logic ---
    function submitOrder() {
        if(!cart.length) return notyf.error('è³¼ç‰©è»Šæ˜¯ç©ºçš„');

        const selectedTable = document.getElementById('checkout-table').value;
        if(!selectedTable) {
            toggleMobileCart(true);
            return notyf.error('è«‹å…ˆé¸æ“‡æ¡Œè™Ÿï¼');
        }

        const total = Number(document.getElementById('final-total').innerText);

        Swal.fire({
            title: 'ç¢ºèªçµå¸³?',
            html: `ç¸½é‡‘é¡: <b style="color:var(--danger-red); font-size:1.4em;">$${total}</b><br><br>æ”¯ä»˜æ–¹å¼: ${currentPay}<br>æ¡Œè™Ÿ: <b>${selectedTable}</b>`,
            showCancelButton: true,
            confirmButtonText: 'ç¢ºèªçµå¸³',
            cancelButtonText: 'å–æ¶ˆ',
            heightAuto: false
        }).then((result) => {
            if (result.isConfirmed) {
                const backdateMode = document.getElementById('backdate-mode').checked;
                const manualDate = document.getElementById('manual-date').value;
                const dateObj = (backdateMode && manualDate) ? new Date(manualDate) : new Date();

                let totalCost = 0;
                let stockDeductions = {};

                cart.forEach(item => {
                    if (item.id === "æ”¯å‡º") return;

                    const ids = (item.type === 'combo' && item.comboDeductionIds) ? item.comboDeductionIds : [item.id];
                    ids.forEach(subId => {
                        const realItem = findItemById(subId);
                        if(realItem) totalCost += (realItem.c || 0);
                        stockDeductions[subId] = (stockDeductions[subId] || 0) + 1;
                    });
                });

                const orderData = {
                    t: new Date().toLocaleTimeString('zh-TW', {hour12:false}),
                    d: dateObj.toLocaleDateString('zh-TW'),
                    total,
                    profit: total - totalCost,
                    pay: currentPay,
                    table: selectedTable,
                    items: [...cart],
                    discount: Number(document.getElementById('discount').value || 0),
                    note: document.getElementById('discount-note').value
                };

                // Prepare Active Table Data
                let newTableData = null;
                if (activeTables[selectedTable]) {
                    // Table already occupied, just append items
                    newTableData = {
                        startTime: activeTables[selectedTable].startTime,
                        items: [...(activeTables[selectedTable].items || []), ...cart]
                    };
                } else {
                    // New table session
                    newTableData = {
                        startTime: Date.now(),
                        items: [...cart]
                    };
                }

                if(isOnline) {
                    let updates = {};
                    const newOrderKey = db.ref('orders').push().key;
                    updates['/orders/' + newOrderKey] = orderData;

                    if (newTableData) {
                        updates['/active_tables/' + selectedTable] = newTableData;
                    }

                    // ä½¿ç”¨ Firebase ServerValue.increment é¿å…ç«¶æ…‹æ¢ä»¶ (Race Condition)
                    for (let subId in stockDeductions) {
                        for (let c = 0; c < inv.length; c++) {
                            for (let i = 0; i < (inv[c].items || []).length; i++) {
                                if (inv[c].items[i].id === subId) {
                                    updates[`/inventory/${c}/items/${i}/s`] = firebase.database.ServerValue.increment(-stockDeductions[subId]);
                                }
                            }
                        }
                    }

                    db.ref().update(updates).then(() => {
                        notyf.success('çµå¸³æˆåŠŸï¼æ¡Œæ³èˆ‡è³‡æ–™å·²åŒæ­¥');
                    }).catch(e => notyf.error('åŒæ­¥å¤±æ•—: ' + e.message));

                } else {
                    // Offline Mode
                    orders.unshift(orderData);
                    const localOrders = JSON.parse(localStorage.getItem('little_nook_offline_orders') || '[]');
                    localOrders.push(orderData);
                    localStorage.setItem('little_nook_offline_orders', JSON.stringify(localOrders));
                    updateSyncBtnState();

                    // UI æš«æ™‚æ‰£æ¸› & æ›´æ–°æœ¬åœ°æ¡Œæ³
                    if (newTableData) {
                        activeTables[selectedTable] = newTableData;
                        localStorage.setItem('yupin_pos_active_tables', JSON.stringify(activeTables));
                        renderTableDashboard();
                    }

                    cart.forEach(cartItem => {
                        if (cartItem.type === 'combo' && cartItem.comboDeductionIds) {
                            cartItem.comboDeductionIds.forEach(subId => {
                                inv.forEach(c => (c.items || []).forEach(i => { if(i.id === subId) i.s--; }));
                            });
                        } else {
                            inv.forEach(c => (c.items || []).forEach(i => { if(i.id === cartItem.id) i.s--; }));
                        }
                    });

                    notyf.success('æœ¬åœ°çµå¸³æˆåŠŸï¼å·²æ›´æ–°æ¡Œæ³ä¸¦å„²å­˜è‡³é›¢ç·šæ¸…å–®');
                    updateLog();
                }

                cart=[];
                document.getElementById('discount').value = '';
                document.getElementById('discount-note').value = '';
                document.getElementById('cash-in').value = '';
                document.getElementById('checkout-table').value = '';
                renderCart();

                toggleMobileCart(false);
            }
        });
    }

    function addExtraCost() {
        Swal.fire({
            title: 'ç´€éŒ„é¡å¤–æ”¯å‡º',
            html: '<input id="swal-cost" class="swal2-input" placeholder="é‡‘é¡"><input id="swal-reason" class="swal2-input" placeholder="åŸå› ">',
            showCancelButton: true,
            heightAuto: false
        }).then((res)=>{
            if(res.isConfirmed) {
                const amt = document.getElementById('swal-cost').value;
                const rsn = document.getElementById('swal-reason').value || "é›œæ”¯";
                if(amt && !isNaN(amt)) {
                    cart.push({ id: "æ”¯å‡º", n: "[æ”¯] " + rsn, p: 0, c: Number(amt), s: 0 });
                    renderCart();
                }
            }
        });
    }

    function updateLog() {
        const logArea = document.getElementById('order-log');
        const today = new Date().toLocaleDateString('zh-TW');
        const todayOrders = orders.filter(o => o.d === today).slice(0, 10);
        if(todayOrders.length === 0) { logArea.innerHTML = '<div style="color:var(--text-muted); padding:10px; text-align:center;">ä»Šæ—¥å°šç„¡äº¤æ˜“</div>'; return; }
        logArea.innerHTML = todayOrders.map(o => `
            <div style="border-bottom:1px solid var(--border-soft); padding:8px 0; font-size:0.95em;">
                <span style="color:var(--text-muted); font-weight:600;">[${o.t}]</span> <b style="color:var(--primary);">$${o.total}</b> <span style="font-size:0.85em; color:var(--text-muted); border:1px solid var(--border-soft); padding:2px 6px; border-radius:4px;">${o.pay}</span> ${o.table ? `<span style="color:var(--accent-green); font-weight:bold; margin-left:4px;">æ¡Œè™Ÿ ${o.table}</span>` : ''}
                <div style="color:var(--text-main); font-size:0.9em; margin-top:4px;">${o.items.map(i => i.n + (i.comboDetail ? '(å¥—)' : '')).join(', ')}</div>
            </div>`).join('');
    }

    function searchHistory(mode) {
        const resultArea = document.getElementById('history-result-area');
        let filtered = [];
        let title = "";
        if(mode === 'day') {
            const date = document.getElementById('search-date').value;
            if(!date) return notyf.error('è«‹é¸æ“‡æ—¥æœŸ');
            const dateStr = new Date(date).toLocaleDateString('zh-TW');
            filtered = orders.filter(o => o.d === dateStr);
            title = `<i class="ph-bold ph-calendar-blank"></i> ${dateStr} äº¤æ˜“ç´€éŒ„`;
        } else {
            const month = document.getElementById('search-month').value;
            if(!month) return notyf.error('è«‹é¸æ“‡æœˆä»½');
            filtered = orders.filter(o => {
                const parts = o.d.split('/');
                const oMonth = `${parts[0]}-${parts[1].padStart(2,'0')}`;
                return oMonth === month;
            });
            title = `<i class="ph-bold ph-chart-bar"></i> ${month} æœˆåº¦çµ±è¨ˆ`;
        }
        let totalRev = 0, totalProf = 0;
        let html = `<h3 style="display:flex; align-items:center; gap:8px;">${title}</h3>`;
        if(filtered.length === 0) { html += "<p style='color:var(--text-muted);'>æ­¤æ™‚æ®µç„¡è³‡æ–™</p>"; } else {
            filtered.forEach(o => {
                totalRev += o.total;
                totalProf += (o.profit || 0);
                html += `<div class="history-card">
                    <div class="history-header">
                        <div>
                            <strong style="font-size:1.1em; color:var(--text-main);">ã€${o.pay}ã€‘ç¸½è¨ˆ: <span style="color:var(--primary);">$${o.total}</span></strong>
                            ${o.table ? `<span style="color:var(--accent-green); font-weight:bold; margin-left:8px;">æ¡Œè™Ÿ ${o.table}</span>` : ''}
                        </div>
                        <div class="history-del-btn" onclick="deleteOrder('${o.firebaseKey}')"><i class="ph-bold ph-trash"></i> é€€è²¨/åˆªé™¤</div>
                    </div>
                    <span style="color:var(--text-muted); font-size:0.85em;"><i class="ph-bold ph-clock"></i> ${o.d} ${o.t}</span>
                    <div style="font-size:0.95em; color:var(--text-muted); margin-top:8px; line-height:1.4;"><i class="ph-bold ph-shopping-bag"></i> å…§å®¹: ${o.items.map(i=>`${i.n}${i.comboDetail?`[${i.comboDetail}]`:''}`).join(', ')}</div>
                </div>`;
            });
            html = `<div style="background:#F0FDF4; padding:16px; border-radius:12px; margin-bottom:16px; border:1px solid #C6F6D5; display:flex; gap:16px; flex-wrap:wrap;">
                        <div><span style="color:#22543D; font-size:0.9em;">ç¸½ç‡Ÿæ”¶</span><br><b style="font-size:1.2em; color:var(--accent-green);">$${totalRev}</b></div>
                        <div style="border-left:1px solid #C6F6D5; padding-left:16px;"><span style="color:#22543D; font-size:0.9em;">é ä¼°æ¯›åˆ©</span><br><b style="font-size:1.2em; color:var(--primary);">$${totalProf}</b></div>
                        <div style="border-left:1px solid #C6F6D5; padding-left:16px;"><span style="color:#22543D; font-size:0.9em;">ç¸½å–®æ•¸</span><br><b style="font-size:1.2em; color:var(--text-main);">${filtered.length}</b></div>
                    </div>` + html;
        }
        resultArea.innerHTML = html;
    }

    // --- Auto-Restock Order Deletion ---
    function deleteOrder(key) {
        if(!isOnline) return notyf.error('æœ¬åœ°æ¨¡å¼ä¸æ”¯æ´åˆªé™¤ï¼Œè«‹é€£ç·šå¾Œæ“ä½œ');
        Swal.fire({
            title: 'ç¢ºå®šé€€è²¨/åˆªé™¤?',
            text: 'ç³»çµ±å°‡è‡ªå‹•é€€å›æ­¤å–®çš„å•†å“åº«å­˜',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#D96C6C',
            heightAuto: false
        }).then((res)=>{
            if(res.isConfirmed) {
                const orderToDel = orders.find(o => o.firebaseKey === key);
                if(!orderToDel) return notyf.error('æ‰¾ä¸åˆ°è©²ç­†è¨‚å–®');

                let updates = {};
                updates[`/orders/${key}`] = null;

                let stockIncrements = {};
                orderToDel.items.forEach(item => {
                    if (item.id === "æ”¯å‡º") return;
                    const ids = (item.type === 'combo' && item.comboDeductionIds) ? item.comboDeductionIds : [item.id];
                    ids.forEach(subId => {
                        stockIncrements[subId] = (stockIncrements[subId] || 0) + 1;
                    });
                });

                // å›è£œåº«å­˜çš„åŸå­æ›´æ–°
                for (let subId in stockIncrements) {
                    for (let c = 0; c < inv.length; c++) {
                        for (let i = 0; i < (inv[c].items || []).length; i++) {
                            if (inv[c].items[i].id === subId) {
                                updates[`/inventory/${c}/items/${i}/s`] = firebase.database.ServerValue.increment(stockIncrements[subId]);
                            }
                        }
                    }
                }

                db.ref().update(updates)
                    .then(() => {
                        notyf.success('ç´€éŒ„å·²åˆªé™¤ï¼Œåº«å­˜å·²å›è£œ');
                        document.getElementById('search-date').value && searchHistory('day');
                    })
                    .catch(e => notyf.error('åˆªé™¤å¤±æ•—: ' + e.message));
            }
        });
    }

    function renderStatTable() {
        const stats = {};
        orders.forEach(o => { o.items.forEach(it => { if(it.id === "æ”¯å‡º") return; if(!stats[it.n]) stats[it.n] = { qty: 0, amt: 0 }; stats[it.n].qty += 1; stats[it.n].amt += it.p; }); });
        const sorted = Object.entries(stats).sort((a,b) => b[1].qty - a[1].qty);
        document.getElementById('stat-tbody').innerHTML = sorted.map(([name, data]) => `<tr style="background:white;"><td style="text-align:left; font-weight:600; color:var(--text-main); padding: 8px;">${name}</td><td style="padding: 8px; text-align:center;"><span style="background:var(--bg-body); padding:4px 8px; border-radius:6px; font-weight:600;">${data.qty}</span></td><td style="color:var(--primary); font-weight:700; padding: 8px; text-align:center;">$${data.amt}</td></tr>`).join('');
    }

    function backupData() {
        const blob = new Blob([JSON.stringify({inv, orders, activeTables}, null, 2)], { type: "application/json" });
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `YupinTea_Backup_${new Date().toLocaleDateString()}.json`; a.click();
    }
    function exportToExcel() {
        const data = orders.map(o => ({ "æ—¥æœŸ": o.d, "æ™‚é–“": o.t, "æ¡Œè™Ÿ": o.table||'', "ç¸½é¡": o.total, "æ¯›åˆ©": o.profit, "æ”¯ä»˜æ–¹å¼": o.pay, "å‚™è¨»": o.note, "å•†å“æ˜ç´°": o.items.map(i=>i.n + (i.comboDetail ? `[${i.comboDetail}]` : '')).join(',') }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Sales");
        XLSX.writeFile(wb, `Sales_Export_${new Date().toLocaleDateString()}.xlsx`);
    }
</script>
</body>
</html>