<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸµ å¾¡å“æ³¡èŒ¶é«”é©—</title>

    <!-- å¼•å…¥ Firebase v8 (å·²ç§»é™¤ authï¼Œé€€å›ç°¡æ˜“å‰ç«¯é˜²è­·) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <!-- å¼•å…¥ XLSX ç”¨æ–¼åŒ¯å‡º Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- å¼•å…¥ SweetAlert2 (è™•ç†å°è©±ã€ç¢ºèªã€è¼¸å…¥) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- å¼•å…¥ Notyf (è™•ç†è¼•é‡åŒ– Toast æç¤º) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">
    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>

    <style>
        :root { --main-brown: #b0a496; --bg-cream: #fcf8f5; --accent-brown: #8c7b6c; --price-red: #d9534f; --profit-green: #6b8e23; }
        body { font-family: sans-serif; background: var(--bg-cream); margin: 0; display: flex; flex-direction: column; height: 100vh; color: #5d5246; overflow: hidden; }
        header { background: var(--main-brown); color: white; padding: 12px; text-align: center; font-size: 1.3em; font-weight: bold; flex-shrink: 0; cursor: default; user-select: none; }

        /* Nav Bar */
        .nav-bar { background: #e8e0d9; padding: 10px; display: flex; gap: 10px; overflow-x: auto; border-bottom: 2px solid #d1c7bc; flex-shrink: 0; align-items: center; white-space: nowrap; -webkit-overflow-scrolling: touch; }
        .nav-btn { background: white; border: 1px solid #d1c7bc; padding: 8px 18px; border-radius: 20px; white-space: nowrap; cursor: pointer; font-size: 1.1em; flex-shrink: 0; }

        /* Dashboard Buttons */
        .dash-btn { background: var(--accent-brown); color: white; border: none; padding: 8px 18px; border-radius: 20px; font-weight: bold; cursor: pointer; flex-shrink: 0; transition: transform 0.1s; }
        .dash-btn:active { transform: scale(0.95); }

        /* Improved Sync Button */
        .sync-btn {
            background: #718096; color: white; border: none; padding: 8px 18px; border-radius: 20px; font-weight: bold; cursor: pointer; margin-left: auto; flex-shrink: 0;
            display: flex; align-items: center; gap: 5px; transition: all 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .sync-btn.has-data {
            background: #e53e3e;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(229, 62, 62, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(229, 62, 62, 0); }
            100% { box-shadow: 0 0 0 0 rgba(229, 62, 62, 0); }
        }

        /* Main Layout */
        .main-content { display: flex; flex: 1; overflow: hidden; padding: 10px; gap: 10px; }

        /* Left Area (Products & Tables) */
        .left-pane { flex: 1.8; display: flex; flex-direction: column; overflow: hidden; background: white; border-radius: 15px; border: 2px solid #e8e0d9; position: relative; }
        .item-area { flex: 1; overflow-y: auto; padding: 15px; }
        .table-area { flex: 1; overflow-y: auto; padding: 15px; display: none; background: #fdfaf7; }

        .cat-title { background: #fdf5f0; padding: 8px 15px; border-radius: 20px; margin: 15px 0 8px; font-weight: bold; border-left: 8px solid var(--main-brown); font-size: 1.2em; clear: both; }

        /* Product Grid */
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(135px, 1fr)); gap: 10px; }
        .p-btn { background: white; border: 1px solid #f0e6dd; border-radius: 12px; padding: 10px 5px; text-align: center; cursor: pointer; box-shadow: 2px 2px 0 #e8e0d9; min-height: 90px; display: flex; flex-direction: column; justify-content: center; position: relative; }
        .p-btn.combo-item { border: 2px solid var(--accent-brown); background: #fffcf8; }
        .combo-badge { position: absolute; top: -5px; right: -5px; background: var(--accent-brown); color: white; font-size: 0.7em; padding: 2px 6px; border-radius: 10px; }
        .p-name { font-size: 0.85em; font-weight: bold; margin-bottom: 5px; height: 2.8em; overflow: hidden; line-height: 1.4; }
        .p-price { color: #c2966d; font-size: 1.2em; font-weight: bold; }
        .p-stock { font-size: 0.8em; color: #999; }

        /* Checkout Area */
        .checkout-area { flex: 1; display: flex; flex-direction: column; gap: 10px; min-width: 320px; overflow-y: auto; }
        .card { background: white; border-radius: 15px; padding: 12px; border: 2px solid #e8e0d9; display: flex; flex-direction: column; }
        #cart-list { flex: 1; min-height: 150px; max-height: 300px; overflow-y: auto; border-bottom: 2px dashed #e8e0d9; }
        .cart-item { display: flex; justify-content: space-between; align-items: flex-start; padding: 12px 5px; font-size: 1.1em; border-bottom: 1px solid #eee; }
        .cart-details { font-size: 0.8em; color: #666; margin-left: 10px; display: block; }

        .big-input { font-size: 1.8em; padding: 12px; width: 100%; border-radius: 10px; border: 2px solid #d1c7bc; text-align: right; box-sizing: border-box; background: #fffcf5; font-weight: bold; }
        .table-select { font-size: 1.4em; padding: 10px; width: 100%; border-radius: 10px; border: 2px solid var(--main-brown); background: #fdf5f0; font-weight: bold; color: var(--accent-brown); margin-bottom: 10px; text-align: center; }
        .small-note { font-size: 1em; padding: 8px; width: 100%; border-radius: 8px; border: 1px solid #d1c7bc; box-sizing: border-box; margin-top: 5px; }
        .total-display { font-size: 3.2em; font-weight: bold; color: var(--price-red); text-align: right; margin: 10px 0; }
        .pay-btn { flex: 1; padding: 15px; border-radius: 10px; border: 1px solid #ccc; background: white; cursor: pointer; font-weight: bold; font-size: 1.3em;}
        .pay-btn.active { background: var(--accent-brown); color: white; border-color: var(--accent-brown); }

        /* Table Dashboard Styles */
        .table-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; margin-top: 15px; }
        .t-card { border-radius: 15px; padding: 15px 10px; text-align: center; border: 2px solid #e8e0d9; cursor: pointer; display: flex; flex-direction: column; justify-content: center; min-height: 110px; box-shadow: 2px 2px 5px rgba(0,0,0,0.05); transition: transform 0.1s; }
        .t-card:active { transform: scale(0.95); }
        .t-empty { background: #fff; color: #a0a0a0; border: 2px dashed #d1c7bc; }
        .t-green { background: #e6fffa; border-color: #38a169; color: #234e52; }
        .t-yellow { background: #fffff0; border-color: #d69e2e; color: #744210; }
        .t-red { background: #fff5f5; border-color: #e53e3e; color: #742a2a; }
        .t-red-blink { background: #fff5f5; border-color: #e53e3e; color: #742a2a; animation: redBlink 1.5s infinite; }
        @keyframes redBlink { 0%, 100% { background: #fff5f5; box-shadow: 0 0 0 #e53e3e; } 50% { background: #fed7d7; box-shadow: 0 0 15px rgba(229, 62, 62, 0.6); } }
        .t-name { font-size: 1.4em; font-weight: bold; margin-bottom: 8px; }
        .t-time { font-size: 0.9em; font-weight: bold; background: rgba(255,255,255,0.5); padding: 2px 5px; border-radius: 5px; display: inline-block; margin: 0 auto; }
        .t-items { font-size: 0.8em; margin-top: 8px; opacity: 0.85; }

        /* Panels / Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-content { background: white; width: 95%; max-width: 900px; height: 90%; max-height: 800px; border-radius: 15px; display: flex; flex-direction: column; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); position: relative; animation: slideUp 0.3s ease; box-sizing: border-box; }
        .modal-small { max-width: 500px; height: auto; max-height: 90vh; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .admin-layout { display: grid; grid-template-columns: 1.5fr 1fr; gap: 15px; flex: 1; overflow: hidden; }
        .admin-actions { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }

        .admin-table-container { overflow: auto; border: 1px solid #eee; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background: #f4f4f4; position: sticky; top: 0; padding: 10px; border: 1px solid #ddd; z-index: 5; }
        td { padding: 8px; border: 1px solid #ddd; text-align: center; }
        .del-x { color: red; font-weight: bold; cursor: pointer; font-size: 1.4em; }

        /* Beautified Admin Inputs */
        .admin-table-input { width: 100%; box-sizing: border-box; border: 1px solid #e2e8f0; background: #f8fafc; border-radius: 6px; padding: 8px 10px; font-size: 1em; color: #4a5568; transition: all 0.2s; text-align: center; }
        .admin-table-input:focus { outline: none; border-color: var(--accent-brown); background: #fff; box-shadow: 0 0 0 3px rgba(140, 123, 108, 0.1); }
        td input[type="text"].admin-table-input { text-align: left; }

        /* Drag and Drop Styles */
        .drag-handle { cursor: grab; color: #a0aec0; font-size: 1.2em; user-select: none; touch-action: none; padding: 5px; }
        .drag-handle:active { cursor: grabbing; color: var(--accent-brown); }
        tr.dragging { opacity: 0.4; background: #fff7ed; }

        /* Form Styles */
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 1em; box-sizing: border-box; }
        .btn-submit { width: 100%; padding: 12px; background: var(--profit-green); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1.1em; margin-top: 10px; cursor: pointer; }

        /* Combo Config Styles */
        .combo-config-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; border: 2px dashed #ddd; border-radius: 8px; margin-top: 10px; padding: 10px; }
        .combo-cols { display: flex; flex: 1; gap: 10px; overflow: hidden; }
        .combo-group-list { width: 35%; overflow-y: auto; border-right: 1px solid #eee; padding-right: 5px; }
        .combo-item-pool { flex: 1; overflow-y: auto; padding-left: 5px; }
        .group-card { padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 8px; cursor: pointer; background: #fff; transition: 0.2s; }
        .group-card.active { border-color: var(--accent-brown); background: #fdf5f0; border-left: 5px solid var(--accent-brown); }

        /* Checkbox list styles */
        .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; }
        .check-item { display: flex; align-items: center; padding: 8px; border: 1px solid #eee; border-radius: 6px; cursor: pointer; font-size: 0.9em; }
        .check-item:hover { background: #f9f9f9; }
        .check-item input { margin-right: 8px; transform: scale(1.2); }

        /* History Items */
        .history-card { background: #fdfdfd; border: 1px solid #eee; padding: 10px; border-radius: 8px; margin-bottom: 10px; position: relative; }
        .history-del-btn { position: absolute; top: 10px; right: 10px; color: red; cursor: pointer; font-weight: bold; border: 1px solid red; padding: 2px 5px; border-radius: 4px; font-size: 0.8em; }

        /* Combo Customer Modal Styles */
        .combo-select-step { margin-bottom: 15px; border: 1px solid #eee; padding: 10px; border-radius: 8px; }
        .combo-step-title { font-weight: bold; margin-bottom: 8px; background: #f9f9f9; padding: 5px; border-radius: 4px; }
        .combo-option { display: inline-block; margin: 5px; padding: 8px 12px; border: 1px solid #ddd; border-radius: 20px; cursor: pointer; background: white; }
        .combo-option.selected { background: var(--accent-brown); color: white; border-color: var(--accent-brown); }
        .combo-option.disabled { opacity: 0.5; background: #eee; cursor: not-allowed; }

        /* Beautified Setting Button */
        .btn-setting {
            background: var(--accent-brown); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.9em; font-weight: bold; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1); white-space: nowrap;
        }
        .btn-setting:hover { background: #7a6a5d; transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.15); }
        .btn-setting:active { transform: translateY(0); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        /* ä¿®æ­£ SweetAlert2 ä¿®æ”¹ body é«˜åº¦å°è‡´ Flexbox è·‘ç‰ˆçš„å•é¡Œ */
        .swal2-container { z-index: 20000 !important; }
        html.swal2-height-auto, body.swal2-height-auto { height: 100vh !important; }
        body.swal2-shown { padding-right: 0 !important; overflow: hidden !important; }

        /* Refined Login Overlay Styles */
        #login-overlay {
            position: fixed; inset: 0;
            background: linear-gradient(135deg, #d3cbb8 0%, #b0a496 100%);
            z-index: 10000;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .login-card-ui {
            background: rgba(255, 255, 255, 0.95); padding: 40px 30px; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.15), 0 0 0 1px rgba(255,255,255,0.5) inset; text-align: center; width: 90%; max-width: 400px; box-sizing: border-box; animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .login-card-ui h2 { margin-top: 0; color: #4a4036; margin-bottom: 30px; font-size: 1.8em; font-weight: 800; letter-spacing: 1px; }
        .login-input-wrapper { position: relative; margin-bottom: 20px; }
        .login-card-ui .big-input { width: 100%; padding: 15px; font-size: 1.2em; border: 2px solid #e0d8d0; border-radius: 12px; background: #fff; color: #5d5246; transition: all 0.3s ease; text-align: center; letter-spacing: 2px; }
        .login-card-ui .big-input:focus { border-color: var(--accent-brown); box-shadow: 0 0 0 4px rgba(140, 123, 108, 0.1); outline: none; }
        .login-card-ui .big-input::placeholder { text-align: center; color: #bcaaa4; letter-spacing: normal; }
        .login-card-ui .btn-submit { background: var(--accent-brown); padding: 15px; font-size: 1.2em; border-radius: 12px; transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(140, 123, 108, 0.2); }
        .login-card-ui .btn-submit:hover { background: #7a6a5d; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(140, 123, 108, 0.3); }
        .login-card-ui .btn-submit:active { transform: translateY(0); box-shadow: 0 2px 4px rgba(140, 123, 108, 0.2); }

        /* ==========================================================
           Notyf Toast å®¢è£½åŒ– UI/UX æ¨£å¼ (æŸ”å’Œã€æµæš¢ã€ç·Šæ¹Šè† å›Šç‹€ã€ç•«é¢æ­£ä¸­å¤®)
           ========================================================== */
        .notyf { z-index: 99999 !important; top: 50% !important; bottom: auto !important; transform: translateY(-50%) !important; align-items: center !important; justify-content: center !important; pointer-events: none; }
        .notyf__toast { border-radius: 50px !important; padding: 8px 24px !important; box-shadow: 0 6px 18px rgba(0,0,0,0.12) !important; max-width: 90vw !important; min-height: auto !important; align-items: center !important; pointer-events: auto; }
        .notyf__wrapper { padding: 0 !important; display: flex !important; justify-content: center !important; align-items: center !important; }
        .notyf__message { font-size: 1.05em !important; font-weight: 600 !important; letter-spacing: 0.5px; padding: 0 !important; text-align: center !important; line-height: 1.4 !important; color: #ffffff !important; }
        @keyframes notyf-fadeinup-spring { 0% { opacity: 0; transform: translateY(-20px) scale(0.9); } 60% { opacity: 1; transform: translateY(3px) scale(1.02); } 100% { opacity: 1; transform: translateY(0) scale(1); } }
        .notyf__toast--in { animation: notyf-fadeinup-spring 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards !important; }

        /* RWD Media Queries */
        @media (max-width: 768px) {
            .main-content { flex-direction: column; }
            .left-pane { flex: 1; max-height: 40vh; }
            .checkout-area { flex: 1; min-width: 100%; max-height: 50vh; }
            .admin-layout { grid-template-columns: 1fr; }
            .product-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
            .table-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
            .big-input { font-size: 1.4em; padding: 8px; }
            .table-select { font-size: 1.2em; padding: 8px; }
            .total-display { font-size: 2.2em; margin: 5px 0; }
            .modal-content { width: 100%; height: 100%; max-height: 100%; border-radius: 0; padding: 15px; }
            .combo-cols { flex-direction: column; }
            .combo-group-list { width: 100%; height: 150px; border-right: none; border-bottom: 1px solid #eee; }
            .combo-item-pool { height: 100%; }
            .checkbox-grid { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); }
            .modal-small { height: auto; max-height: 90vh; border-radius: 15px; width: 90%; }
            .admin-table-input { min-width: 60px; font-size: 0.9em; padding: 6px; }
            td input[type="text"].admin-table-input { min-width: 120px; }
            .login-card-ui { padding: 30px 20px; }
            .login-card-ui h2 { font-size: 1.5em; }
            .login-card-ui .big-input { font-size: 1.1em; padding: 12px; }
            .login-card-ui .btn-submit { font-size: 1.1em; padding: 12px; }
            .notyf__toast { padding: 8px 16px !important; }
            .notyf__message { font-size: 0.95em !important; }
        }
    </style>
</head>
<body>

<!-- ç™»å…¥è¦†è“‹å±¤ -->
<div id="login-overlay">
    <div class="login-card-ui">
        <h2>ğŸµ å¾¡å“æ³¡èŒ¶é«”é©—</h2>
        <div class="login-input-wrapper">
            <input type="password" id="login-pwd-input" class="big-input" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" onkeypress="if(event.key==='Enter') checkSystemLogin()">
        </div>
        <button onclick="checkSystemLogin()" class="btn-submit">é€²å…¥ç³»çµ±</button>
    </div>
</div>

<header onclick="handleHeaderSecretClick()">ğŸµ å¾¡å“æ³¡èŒ¶é«”é©—</header>
<div class="nav-bar">
    <!-- æ–°å¢é–€å¸‚æ¡Œæ³æŒ‰éˆ• -->
    <button class="dash-btn" onclick="toggleView('tables')">ğŸª‘ é–€å¸‚æ¡Œæ³</button>
    <div id="navbar" style="display:flex; gap:10px;"></div>
    <button id="sync-btn" class="sync-btn" onclick="syncOfflineData()">â˜ï¸ é›²ç«¯åŒæ­¥</button>
</div>

<div class="main-content">
    <!-- å·¦å´é¡¯ç¤ºå€ï¼šå¯åˆ‡æ›å•†å“æˆ–æ¡Œæ³ -->
    <div class="left-pane">
        <div class="item-area" id="item-area">åŒæ­¥ä¸­...</div>
        <div class="table-area" id="table-area"></div>
    </div>

    <div class="checkout-area">
        <div class="card" style="flex:1;">
            <strong>ğŸ›’ ç•¶å‰æ¸…å–®</strong>
            <!-- æ–°å¢å¼·åˆ¶æ¡Œè™Ÿé¸æ“‡ -->
            <select id="checkout-table" class="table-select">
                <!-- é€é JS åˆå§‹åŒ–é¸é … -->
            </select>

            <div id="cart-list"></div>
            <div style="margin-top:10px; flex-shrink: 0;">
                <input type="number" id="discount" class="big-input" placeholder="æŠ˜æ‰£é‡‘é¡" oninput="calc()">
                <input type="text" id="discount-note" class="small-note" placeholder="æŠ˜æ‰£åŸå› /å‚™è¨» (ä¾‹å¦‚: æ»¿é¡è´ˆ)">
                <div style="margin-top:5px; display:flex; gap:5px;">
                    <button onclick="addExtraCost()" style="flex:1; padding:8px; background:#fef2f2; border:1px solid #fecaca; color:#b91c1c; border-radius:8px; cursor:pointer; font-size:0.9em; font-weight:bold;">â• ç´€éŒ„é¡å¤–æ”¯å‡º</button>
                </div>
            </div>
            <div class="total-display" style="flex-shrink: 0;">$<span id="final-total">0</span></div>
            <div style="display:flex; gap:8px; margin-bottom:10px; flex-shrink: 0;">
                <button class="pay-btn active" id="btn-cash" onclick="setPay('ç¾é‡‘')">ğŸ’µ ç¾é‡‘</button>
                <button class="pay-btn" id="btn-elec" onclick="setPay('é›»æ”¯')">ğŸ“± é›»æ”¯</button>
            </div>
            <input type="number" id="cash-in" class="big-input" placeholder="å¯¦æ”¶é‡‘é¡" oninput="calcChange()" style="flex-shrink: 0;">
            <div style="text-align:right; margin-top:5px; font-size: 1.3em; flex-shrink: 0;">æ‰¾é›¶: <span id="cash-change" style="font-weight:bold; color:red; font-size:1.8em;">0</span></div>

            <div style="margin: 10px 0; padding: 10px; background: #fff5eb; border-radius: 10px; border: 1px dashed var(--main-brown); flex-shrink: 0;">
                <label style="font-size: 0.9em; cursor: pointer;">
                    <input type="checkbox" id="backdate-mode" onclick="document.getElementById('manual-date').style.display = this.checked ? 'inline-block' : 'none'">
                    ğŸ“… è£œç™»éå»æ—¥æœŸè³‡æ–™
                </label>
                <input type="date" id="manual-date" style="display:none; margin-left:10px; padding:5px; border:1px solid #ccc; border-radius:5px;">
            </div>

            <button onclick="submitOrder()" style="width:100%; padding:20px; margin-top:15px; background:var(--profit-green); color:white; border:none; border-radius:15px; font-weight:bold; font-size:1.6em; flex-shrink: 0;">çµå¸³ / é€å–®</button>
        </div>
        <div class="card" style="font-size: 1em; overflow-y: auto; height: 150px; flex-shrink: 0;">
            <strong>ğŸ“‹ ä»Šæ—¥å³æ™‚ç´€éŒ„</strong>
            <div id="order-log"></div>
        </div>
    </div>
</div>

<div style="padding:15px; text-align:center; display: flex; justify-content: center; gap: 15px; flex-shrink: 0;">
    <button onclick="openModal('admin-panel')" style="padding:15px 25px; border-radius:15px; background:white; border:3px solid var(--main-brown); font-weight:bold; font-size:1.1em; cursor:pointer;">ğŸ› ï¸ å•†å“ç®¡ç† / çµ±è¨ˆ</button>
    <button onclick="openHistoryPanel()" style="padding:15px 25px; border-radius:15px; background:var(--accent-brown); color:white; border:none; font-weight:bold; font-size:1.1em; cursor:pointer;">ğŸ“œ æ­·å²ç´€éŒ„ / é€€è²¨</button>
</div>

<!-- æ¡Œæ³æ˜ç´° Modal -->
<div id="table-details-modal" class="modal-overlay">
    <div class="modal-content modal-small">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px; flex-shrink:0;">
            <h2 style="margin:0;" id="td-modal-title">ğŸª‘ æ¡Œæ³æ˜ç´°</h2>
            <button onclick="closeModal('table-details-modal')" style="font-size:1.5em; border:none; background:none; cursor:pointer;">âœ•</button>
        </div>
        <div id="td-modal-info" style="background:#fdf5f0; padding:10px; border-radius:8px; font-weight:bold; margin-bottom:10px; flex-shrink:0;"></div>
        <div id="td-modal-items" style="flex:1; overflow-y:auto; border:1px solid #eee; border-radius:8px; padding:10px; background:#fafafa;"></div>
        <button id="td-modal-clear-btn" style="width:100%; padding:15px; background:#e53e3e; color:white; border:none; border-radius:10px; font-size:1.2em; font-weight:bold; margin-top:15px; flex-shrink:0; cursor:pointer;">ğŸ§¹ æ¸…é™¤æ¡Œé¢ (å®¢é›¢)</button>
    </div>
</div>

<!-- History Modal -->
<div id="history-panel" class="modal-overlay">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-shrink:0;">
            <h2 style="margin:0;">ğŸ“œ æ­·å²ç´€éŒ„ç®¡ç†</h2>
            <button onclick="closeModal('history-panel')" style="font-size:1.5em; border:none; background:none; cursor:pointer;">âœ•</button>
        </div>
        <div style="background:#fdf5f0; padding:15px; border-radius:10px; margin-bottom:15px; display:flex; gap:15px; align-items:center; flex-wrap:wrap; flex-shrink:0;">
            <div>
                <label>å–®æ—¥ï¼š</label><input type="date" id="search-date" style="padding:8px;">
                <button onclick="searchHistory('day')" style="padding:8px 15px; background:var(--main-brown); color:white; border:none; border-radius:5px;">ğŸ” æŸ¥è©¢</button>
            </div>
            <div style="border-left: 2px solid #ddd; padding-left: 15px;">
                <label>ç•¶æœˆï¼š</label><input type="month" id="search-month" style="padding:8px;">
                <button onclick="searchHistory('month')" style="padding:8px 15px; background:var(--accent-brown); color:white; border:none; border-radius:5px;">ğŸ“Š çµ±è¨ˆ</button>
            </div>
        </div>
        <div id="history-result-area" style="flex:1; overflow-y:auto; background:white; padding:15px; border-radius:10px; border:1px solid #eee;"></div>
    </div>
</div>

<!-- Admin Modal (Main) -->
<div id="admin-panel" class="modal-overlay">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; flex-shrink:0;">
            <h2 style="margin:0;">âš™ï¸ ç®¡ç†ä¸­å¿ƒ</h2>
            <div style="display:flex; gap:10px;">
                <button onclick="closeModal('admin-panel')" style="font-size:1.5em; border:none; background:none; cursor:pointer;">âœ•</button>
            </div>
        </div>

        <div class="admin-actions">
            <button onclick="openAddSingleModal()" style="padding:10px 20px; background:#48bb78; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">â• æ–°å¢å–®å“</button>
            <button onclick="openAddComboModal()" style="padding:10px 20px; background:#ed8936; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">ğŸ± æ–°å¢å¥—é¤</button>

            <div style="margin-left:auto; display:flex; gap:10px;">
                <button onclick="exportToExcel()" style="padding:8px 15px; background:#217346; color:white; border:none; border-radius:5px;">ğŸ“¥ åŒ¯å‡º</button>
                <button onclick="backupData()" style="padding:8px 15px; background:#666; color:white; border:none; border-radius:5px;">ğŸ’¾ å‚™ä»½</button>
                <input type="file" id="import-file" style="display:none;" onchange="importData(event)">
                <button onclick="document.getElementById('import-file').click()" style="padding:8px 15px; background:#d9534f; color:white; border:none; border-radius:5px;">âš ï¸ é‚„åŸ</button>
            </div>
        </div>

        <div class="admin-layout">
            <div class="admin-table-container">
                <table id="admin-main-table">
                    <thead><tr><th style="width:40px;"></th><th>é¡å‹</th><th>å“å</th><th>æˆæœ¬</th><th>å”®åƒ¹</th><th>åº«å­˜/å…§å®¹</th><th>åˆª</th></tr></thead>
                    <tbody id="admin-tbody"></tbody>
                </table>
            </div>
            <div style="background:#f9f9f9; padding:15px; border-radius:10px; overflow-y:auto; max-height: 400px;">
                <h3>ğŸ“Š éŠ·å”®æ’å</h3>
                <table style="font-size:0.9em;">
                    <thead><tr style="background:#eee;"><th>å“å</th><th>é‡</th><th>é¡</th></tr></thead>
                    <tbody id="stat-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Add Single Product -->
<div id="modal-single-product" class="modal-overlay">
    <div class="modal-content modal-small">
        <h2 style="margin-top:0;">â• æ–°å¢å–®å“</h2>
        <div style="flex:1; overflow-y:auto;">
            <div class="form-group">
                <label>å•†å“åˆ†é¡</label>
                <select id="single-cat" class="form-control" onchange="checkNewCat(this.value, 'single-cat')"></select>
            </div>
            <div class="form-group">
                <label>å•†å“ä»£ç¢¼ (é¸å¡«)</label>
                <input type="text" id="single-id" class="form-control" placeholder="ä¾‹å¦‚: A01">
            </div>
            <div class="form-group">
                <label>å•†å“åç¨±</label>
                <input type="text" id="single-name" class="form-control" placeholder="è«‹è¼¸å…¥åç¨±">
            </div>
            <div style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1;">
                    <label>æˆæœ¬</label>
                    <input type="number" id="single-cost" class="form-control" value="0">
                </div>
                <div class="form-group" style="flex:1;">
                    <label>å”®åƒ¹</label>
                    <input type="number" id="single-price" class="form-control" value="0">
                </div>
            </div>
            <div class="form-group">
                <label>åˆå§‹åº«å­˜</label>
                <input type="number" id="single-stock" class="form-control" value="99">
            </div>
        </div>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button onclick="closeModal('modal-single-product')" style="flex:1; padding:12px; border:1px solid #ccc; background:#fff; border-radius:8px; cursor:pointer;">å–æ¶ˆ</button>
            <button onclick="saveSingleProduct()" class="btn-submit" style="flex:1; margin-top:0;">ç¢ºèªæ–°å¢</button>
        </div>
    </div>
</div>

<!-- Modal: Add Combo Product -->
<div id="modal-combo-product" class="modal-overlay">
    <div class="modal-content">
        <h2 style="margin-top:0;">ğŸ± æ–°å¢å¥—é¤</h2>
        <!-- Basic Info -->
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <div style="flex:1; min-width:150px;">
                <label style="font-size:0.9em; color:#666;">åˆ†é¡</label>
                <select id="combo-cat" class="form-control" onchange="checkNewCat(this.value, 'combo-cat')"></select>
            </div>
            <div style="flex:1; min-width:150px;">
                <label style="font-size:0.9em; color:#666;">å¥—é¤åç¨±</label>
                <input type="text" id="combo-name" class="form-control" placeholder="ä¾‹: ä¸‹åˆèŒ¶çµ„åˆ">
            </div>
            <div style="width:100px;">
                <label style="font-size:0.9em; color:#666;">å”®åƒ¹</label>
                <input type="number" id="combo-price" class="form-control" value="0">
            </div>
            <div style="width:80px;">
                <label style="font-size:0.9em; color:#666;">ä»£ç¢¼</label>
                <input type="text" id="combo-id" class="form-control">
            </div>
        </div>

        <!-- Combo Config -->
        <div class="combo-config-area">
            <div style="display:flex; gap:10px; margin-bottom:10px; align-items:center; background:#f0fdf4; padding:10px; border-radius:8px;">
                <strong style="color:#2f855a;">æ­¥é©Ÿï¼š</strong>
                <span>1. è¼¸å…¥ç¾¤çµ„åç¨± (å¦‚: é£²å“é¸ä¸€) </span>
                <input type="text" id="combo-group-input" style="padding:5px; border-radius:4px; border:1px solid #ccc;" placeholder="ç¾¤çµ„åç¨±...">
                <button onclick="addComboGroup()" style="background:#48bb78; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">ï¼‹ åŠ å…¥ç¾¤çµ„</button>
            </div>

            <div class="combo-cols">
                <!-- Left: Group List -->
                <div class="combo-group-list" id="combo-group-list-ui">
                    <div style="color:#999; text-align:center; padding:20px;">è«‹å…ˆæ–°å¢ç¾¤çµ„</div>
                </div>

                <!-- Right: Product Pool Checkboxes -->
                <div class="combo-item-pool" id="combo-item-pool-ui">
                    <div style="color:#999; text-align:center; padding:20px;">é»é¸å·¦å´ç¾¤çµ„å¾Œï¼Œåœ¨æ­¤å‹¾é¸å…§å®¹</div>
                </div>
            </div>
        </div>

        <div style="display:flex; gap:10px; margin-top:10px;">
            <button onclick="closeModal('modal-combo-product')" style="flex:1; padding:12px; border:1px solid #ccc; background:#fff; border-radius:8px; cursor:pointer;">å–æ¶ˆ</button>
            <button onclick="saveComboProduct()" class="btn-submit" style="flex:1; margin-top:0;">å®Œæˆä¸¦æ–°å¢å¥—é¤</button>
        </div>
    </div>
</div>

<!-- Combo Customer Selection Modal -->
<div id="combo-select-modal" class="modal-overlay">
    <div class="modal-content modal-small">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px; flex-shrink:0;">
            <h2 style="margin:0;" id="select-combo-title">é¸æ“‡å¥—é¤å…§å®¹</h2>
            <button onclick="closeModal('combo-select-modal')" style="font-size:1.5em; border:none; background:none; cursor:pointer;">âœ•</button>
        </div>
        <div id="combo-selection-area" style="flex:1; overflow-y:auto;"></div>
        <button onclick="confirmComboSelection()" style="width:100%; padding:15px; background:var(--main-brown); color:white; border:none; border-radius:10px; font-size:1.2em; font-weight:bold; margin-top:10px; flex-shrink:0;">ç¢ºèªåŠ å…¥æ¸…å–®</button>
    </div>
</div>

<script>
    // --- è¨Šæ¯ç­–ç•¥è¨­å®š (Notyf åˆå§‹åŒ– - æŸ”å’Œä¸”ç¾ä»£åŒ–çš„é…ç½®) ---
    const notyf = new Notyf({
        duration: 1500,
        position: { x: 'center', y: 'top' }, // CSS æœƒå¼·åˆ¶å°‡å…¶ç²¾æº–å‚ç›´æ°´å¹³ç½®ä¸­
        dismissible: false,
        ripple: false, // é—œé–‰æ°´æ³¢ç´‹ï¼Œæ•´é«”æ„Ÿè¦ºæ›´æ‰å¯¦ã€é«˜ç´š
        types: [
            {
                type: 'success',
                background: '#6FCF97', // è¼ƒæ·ºæŸ”å’Œçš„ç¶ è‰²
                icon: false // ç§»é™¤åœ–ç¤ºï¼Œåªé¡¯ç¤ºç´”æ–‡å­—
            },
            {
                type: 'error',
                background: '#FC8181', // è¼ƒæ·ºæŸ”å’Œçš„ç´…è‰²
                icon: false // ç§»é™¤é è¨­çš„ 'x' åœ–ç¤ºï¼Œåªé¡¯ç¤ºç´”æ–‡å­—
            }
        ]
    });

    const firebaseConfig = {
        apiKey: "AIzaSyAomzzRW15uwRZ91jhgH6ZRFZA-ldT1iXY",
        authDomain: "yupin-pos.firebaseapp.com",
        databaseURL: "https://yupin-pos-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "yupin-pos",
        storageBucket: "yupin-pos.firebasestorage.app",
        messagingSenderId: "229501500357",
        appId: "1:229501500357:web:342f2c69ecb589da4569ac"
    };

    let db;
    let isOnline = false;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
        isOnline = true;
    } catch(e) {
        console.log("Firebaseæœªé…ç½®ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡å¼");
    }

    let inv = [];
    let orders = [];
    let cart = [];
    let currentPay = 'ç¾é‡‘';

    // å®šç¾©å›ºå®šæ¡Œä½
    const ALL_TABLES = ['å§å°1', 'å§å°2', 'å§å°3', 'å§å°4', 'å§å°5', 'æ¡Œä½A', 'æ¡Œä½B', 'æ¡Œä½C', 'æ¡Œä½D'];
    let activeTables = {}; // è¿½è¹¤æ­£åœ¨ä½¿ç”¨ä¸­çš„æ¡Œå­

    const defaultInv = [
        { cat: "ğŸ§¸ æ‹›ç‰Œç©å¶", items: [{id: "A01", n: "ç¶“å…¸å°ç†Š", c: 100, p: 250, s: 10, type: "item"}] },
        { cat: "â˜• é£²å“", items: [
                {id: "D01", n: "æ¸…éŸ»é«˜å±±çƒé¾", c: 10, p: 50, s: 100, type: "item"},
                {id: "D02", n: "é›…éŸ»é«˜å±±çƒé¾", c: 12, p: 55, s: 100, type: "item"}
            ]},
        { cat: "ğŸ° ç”œé»", items: [
                {id: "C01", n: "ææ‹‰ç±³è˜‡", c: 40, p: 120, s: 50, type: "item"},
                {id: "C02", n: "å·´æ–¯å…‹", c: 35, p: 110, s: 50, type: "item"}
            ]}
    ];

    // --- System Login & Security Logic (Web Crypto Hash + Salt) ---
    const SALT = "YUPIN_POS_SECURE_SALT";

    // ç°¡æ˜“çš„ SHA-256 é›œæ¹Šè™•ç† (éåŒæ­¥)
    async function hashPassword(pwd) {
        const msgBuffer = new TextEncoder().encode(pwd + SALT);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // åˆå§‹åŒ–ï¼šå¦‚æœæ²’æœ‰å­˜éå¯†ç¢¼ï¼Œé è¨­ç‚º "1234" çš„ Hash
    async function initSystemPassword() {
        let storedHash = localStorage.getItem('yupin_pos_pwd_hash');
        if (!storedHash) {
            storedHash = await hashPassword('1234');
            localStorage.setItem('yupin_pos_pwd_hash', storedHash);
        }
    }
    initSystemPassword();

    // ç³»çµ±è¼‰å…¥æ™‚å¼·åˆ¶é¡¯ç¤ºç™»å…¥ç•«é¢
    document.getElementById('login-overlay').style.display = 'flex';

    async function checkSystemLogin() {
        const input = document.getElementById('login-pwd-input').value;
        if (!input) return notyf.error('è«‹è¼¸å…¥å¯†ç¢¼');

        const inputHash = await hashPassword(input);
        const storedHash = localStorage.getItem('yupin_pos_pwd_hash');

        if (inputHash === storedHash) {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('login-pwd-input').value = '';
            // ç™»å…¥æˆåŠŸå¾Œæ‰è¼‰å…¥è³‡æ–™ï¼Œé¿å…ç•«é¢ææ—©æ¸²æŸ“
            if (inv.length === 0) loadData();
        } else {
            notyf.error('å¯†ç¢¼ä¸æ­£ç¢º');
        }
    }

    // é€£é»äº”æ¬¡æ¨™é¡Œè§¸ç™¼æ”¹å¯†ç¢¼
    let headerClickCount = 0;
    let headerClickTimer = null;
    function handleHeaderSecretClick() {
        headerClickCount++;
        if (headerClickCount === 1) {
            headerClickTimer = setTimeout(() => { headerClickCount = 0; }, 2000);
        }
        if (headerClickCount >= 5) {
            clearTimeout(headerClickTimer);
            headerClickCount = 0;
            promptChangePassword();
        }
    }

    function promptChangePassword() {
        Swal.fire({
            title: 'ç®¡ç†å“¡è¨­å®š',
            text: 'è«‹è¼¸å…¥æ–°çš„ç³»çµ±ç™»å…¥å¯†ç¢¼',
            input: 'password',
            inputPlaceholder: 'æ–°å¯†ç¢¼',
            showCancelButton: true,
            confirmButtonText: 'å„²å­˜è®Šæ›´',
            cancelButtonText: 'å–æ¶ˆ',
            heightAuto: false
        }).then(async (result) => {
            if (result.isConfirmed && result.value) {
                const newHash = await hashPassword(result.value);
                localStorage.setItem('yupin_pos_pwd_hash', newHash);
                notyf.success('ç³»çµ±å¯†ç¢¼å·²æ›´æ–°');
            }
        });
    }

    // --- Core Data Logic ---
    function loadData() {
        initTableSelect(); // åˆå§‹åŒ–çµå¸³å€çš„æ¡Œè™Ÿé¸å–®

        if(isOnline) {
            db.ref('inventory').on('value', snap => {
                inv = snap.val() || defaultInv;
                initUI();
            });
            db.ref('orders').on('value', snap => {
                const data = snap.val();
                orders = data ? Object.keys(data).map(k => ({...data[k], firebaseKey: k})) : [];
                orders.sort((a,b) => (b.d+b.t).localeCompare(a.d+a.t));
                updateLog();
                renderStatTable();
            });
            db.ref('active_tables').on('value', snap => {
                activeTables = snap.val() || {};
                renderTableDashboard();
            });
        } else {
            inv = defaultInv;
            activeTables = JSON.parse(localStorage.getItem('yupin_pos_active_tables') || '{}');
            initUI();
            renderTableDashboard();
        }
        updateSyncBtnState();
    }

    // å®šæœŸæ›´æ–°æ¡Œæ³é¡è‰² (æ¯ 60 ç§’)
    setInterval(() => {
        if(document.getElementById('table-area').style.display !== 'none') {
            renderTableDashboard();
        }
    }, 60000);

    // --- Sync Logic (Atomic Updates) ---
    function updateSyncBtnState() {
        const localOrders = JSON.parse(localStorage.getItem('little_nook_offline_orders') || '[]');
        const btn = document.getElementById('sync-btn');
        if (localOrders.length > 0) {
            btn.innerHTML = `âš ï¸ <b>${localOrders.length}</b> ç­†æœªåŒæ­¥`;
            btn.classList.add('has-data');
        } else {
            btn.innerHTML = `â˜ï¸ é›²ç«¯åŒæ­¥`;
            btn.classList.remove('has-data');
        }
    }

    function syncOfflineData() {
        if(!isOnline) {
            notyf.error('æœªé€£æ¥åˆ° Firebase è³‡æ–™åº«');
            return;
        }

        const localOrders = JSON.parse(localStorage.getItem('little_nook_offline_orders') || '[]');

        if (localOrders.length === 0) {
            // Even if no orders, sync inventory and active_tables to cloud just in case of local overrides
            let updates = {};
            updates['/inventory'] = inv;
            updates['/active_tables'] = activeTables;
            db.ref().update(updates).then(() => notyf.success('ç³»çµ±è¨­å®šèˆ‡æ¡Œæ³å·²åŒæ­¥'));
            return;
        }

        Swal.fire({
            title: 'æº–å‚™åŒæ­¥',
            text: `ç™¼ç¾ ${localOrders.length} ç­†é›¢ç·šè¨‚å–®ï¼Œç¢ºå®šä¸Šå‚³ï¼Ÿ`,
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: 'ç«‹å³åŒæ­¥',
            showLoaderOnConfirm: true,
            heightAuto: false,
            preConfirm: () => {
                let updates = {};
                let localDeductions = {};

                // è™•ç†é›¢ç·šè¨‚å–®èˆ‡è¨ˆç®—ç¸½æ‰£é™¤é‡
                localOrders.forEach(order => {
                    const newKey = db.ref('orders').push().key;
                    updates['/orders/' + newKey] = order;

                    order.items.forEach(cartItem => {
                        if(cartItem.id === "æ”¯å‡º") return;
                        const ids = (cartItem.type === 'combo' && cartItem.comboDeductionIds) ? cartItem.comboDeductionIds : [cartItem.id];
                        ids.forEach(subId => {
                            localDeductions[subId] = (localDeductions[subId] || 0) + 1;
                        });
                    });
                });

                // å¥—ç”¨åŸå­æ›´æ–° (Atomic Increment) é¿å…ç«¶æ…‹æ¢ä»¶
                for(let subId in localDeductions) {
                    for (let c = 0; c < inv.length; c++) {
                        for (let i = 0; i < (inv[c].items || []).length; i++) {
                            if (inv[c].items[i].id === subId) {
                                updates[`/inventory/${c}/items/${i}/s`] = firebase.database.ServerValue.increment(-localDeductions[subId]);
                            }
                        }
                    }
                }

                // Sync active tables state
                updates['/active_tables'] = activeTables;

                return db.ref().update(updates)
                    .then(() => {
                        localStorage.removeItem('little_nook_offline_orders');
                        updateSyncBtnState();
                    })
                    .catch(error => {
                        Swal.showValidationMessage(`Request failed: ${error}`);
                    });
            },
            allowOutsideClick: () => !Swal.isLoading()
        }).then((result) => {
            if (result.isConfirmed) {
                notyf.success('é›¢ç·šè¨‚å–®å·²ä¸Šå‚³ï¼Œåº«å­˜èˆ‡æ¡Œæ³å·²æ›´æ–°');
            }
        });
    }

    // --- View Toggle Logic ---
    function toggleView(view) {
        const itemArea = document.getElementById('item-area');
        const tableArea = document.getElementById('table-area');

        if (view === 'tables') {
            itemArea.style.display = 'none';
            tableArea.style.display = 'block';
            renderTableDashboard();
        } else {
            itemArea.style.display = 'block';
            tableArea.style.display = 'none';
        }
    }

    // --- Init Table Selector ---
    function initTableSelect() {
        const sel = document.getElementById('checkout-table');
        sel.innerHTML = '<option value="">-- å¿…å¡«ï¼šé¸æ“‡æ¡Œè™Ÿ --</option>' +
            ALL_TABLES.map(t => `<option value="${t}">${t}</option>`).join('');
    }

    // --- Table Dashboard UI ---
    function renderTableDashboard() {
        const area = document.getElementById('table-area');
        if(!area) return;

        let html = `<h2 style="margin-top:0; color:#5d5246;">ğŸª‘ é–€å¸‚æ¡Œæ³ç›£æ§</h2><div class="table-grid">`;
        const now = Date.now();

        ALL_TABLES.forEach(tName => {
            const tableData = activeTables[tName];

            if (tableData && tableData.items && tableData.items.length > 0) {
                const elapsedMins = Math.floor((now - tableData.startTime) / 60000);
                let colorClass = 't-green';
                if (elapsedMins >= 120) colorClass = 't-red-blink';
                else if (elapsedMins >= 90) colorClass = 't-yellow';

                let totalItems = tableData.items.length; // ç°¡å–®è¨ˆç®—ç¸½é …æ•¸
                html += `
                    <div class="t-card ${colorClass}" onclick="openTableDetails('${tName}')">
                        <div class="t-name">${tName}</div>
                        <div class="t-time">â±ï¸ ${elapsedMins} åˆ†é˜</div>
                        <div class="t-items">å·²é» ${totalItems} é …</div>
                    </div>`;
            } else {
                html += `
                    <div class="t-card t-empty" onclick="notyf.success('æ­¤æ¡Œç›®å‰ç©ºé–’')">
                        <div class="t-name">${tName}</div>
                        <div class="t-time">ç©ºæ¡Œ</div>
                    </div>`;
            }
        });
        html += '</div>';
        area.innerHTML = html;
    }

    function openTableDetails(tName) {
        const data = activeTables[tName];
        if(!data) return;

        const elapsedMins = Math.floor((Date.now() - data.startTime) / 60000);
        const startStr = new Date(data.startTime).toLocaleTimeString('zh-TW', {hour12:false});
        let colorStyle = elapsedMins >= 120 ? 'color:red;' : (elapsedMins >= 90 ? 'color:#d69e2e;' : 'color:green;');

        let itemsHtml = data.items.map(it => `
            <div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-weight:bold; font-size:1.1em;">${it.n}</div>
                    ${it.comboDetail ? `<div style="font-size:0.85em; color:#666; margin-top:3px;">â†³ ${it.comboDetail}</div>` : ''}
                </div>
                <div style="font-weight:bold; color:var(--accent-brown);">$${it.p}</div>
            </div>
        `).join('');

        document.getElementById('td-modal-title').innerText = `ğŸª‘ ${tName} - å…¨å–®æ˜ç´°`;
        document.getElementById('td-modal-info').innerHTML = `
            å…¥åº§æ™‚é–“ï¼š${startStr}
            <span style="float:right; ${colorStyle}">å·²å…¥åº§ï¼š${elapsedMins} åˆ†é˜</span>
        `;
        document.getElementById('td-modal-items').innerHTML = itemsHtml;

        document.getElementById('td-modal-clear-btn').onclick = () => clearTable(tName);

        openModal('table-details-modal');
    }

    function clearTable(tName) {
        Swal.fire({
            title: `ç¢ºå®šæ¸…ç©º ${tName}ï¼Ÿ`,
            text: 'å®¢äººå·²é›¢å ´ï¼Ÿé€™å°‡æœƒæŠŠæ¡Œä½è®Šå›ç©ºæ¡Œç‹€æ…‹ï¼Œä¸æœƒå½±éŸ¿å·²çµå¸³çš„æ­·å²ç‡Ÿæ”¶',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#e53e3e',
            confirmButtonText: 'ç¢ºå®šæ¸…ç©º',
            cancelButtonText: 'å–æ¶ˆ',
            heightAuto: false
        }).then(res => {
            if(res.isConfirmed) {
                if (isOnline) {
                    db.ref('/active_tables/' + tName).remove().then(() => {
                        notyf.success(`${tName} å·²æ¸…ç©º`);
                        closeModal('table-details-modal');
                    });
                } else {
                    delete activeTables[tName];
                    localStorage.setItem('yupin_pos_active_tables', JSON.stringify(activeTables));
                    renderTableDashboard();
                    notyf.success(`${tName} å·²æ¸…ç©º (é›¢ç·š)`);
                    closeModal('table-details-modal');
                }
            }
        });
    }

    // --- UI Rendering (Products) ---
    function initUI() {
        const area = document.getElementById('item-area'), nav = document.getElementById('navbar');
        // Removed jumpSelect retrieval as it is removed
        area.innerHTML = ''; nav.innerHTML = '';

        inv.forEach((cat, idx) => {
            // Clicking a category automatically switches view back to products
            nav.innerHTML += `<div class="nav-btn" onclick="toggleView('products'); document.getElementById('c${idx}').scrollIntoView()">${cat.cat}</div>`;

            let gridHtml = `<div class="cat-title" id="c${idx}">${cat.cat}</div><div class="product-grid">`;
            if(!cat.items || cat.items.length === 0) {
                gridHtml += `<div style="color:#999; padding:10px;">æ­¤åˆ†é¡æš«ç„¡å•†å“</div>`;
            } else {
                cat.items.forEach((it, itemIdx) => {
                    const isCombo = it.type === 'combo';
                    gridHtml += `<div class="p-btn ${isCombo ? 'combo-item' : ''}" onclick="addCartClick(${idx}, ${itemIdx})">
                        ${isCombo ? '<span class="combo-badge">å¥—é¤</span>' : ''}
                        <div class="p-name">${it.id} ${it.n}</div>
                        <div class="p-price">$${it.p}</div>
                        <div class="p-stock">${isCombo ? 'è‡ªé¸' : 'å­˜:'+it.s}</div>
                    </div>`;
                });
            }
            area.innerHTML += gridHtml + '</div>';
        });

        // Update Select options in Modals
        updateCatSelect('single-cat');
        updateCatSelect('combo-cat');

        if(document.getElementById('admin-panel').style.display === 'flex') renderAdminTable();
    }

    // --- Modal Helpers ---
    function openModal(id) {
        document.getElementById(id).style.display = 'flex';
        if(id === 'admin-panel') renderAdminTable();
    }
    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
    }

    // Auto-load history for today
    function openHistoryPanel() {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        const todayStr = `${yyyy}-${mm}-${dd}`;

        document.getElementById('search-date').value = todayStr;
        openModal('history-panel');
        searchHistory('day');
    }

    // --- Add Single Product Logic ---
    function openAddSingleModal() {
        // Reset form
        document.getElementById('single-id').value = '';
        document.getElementById('single-name').value = '';
        document.getElementById('single-price').value = '';
        document.getElementById('single-cost').value = '';
        document.getElementById('single-stock').value = '99';
        updateCatSelect('single-cat');
        openModal('modal-single-product');
    }

    function saveSingleProduct() {
        const catN = document.getElementById('single-cat').value;
        const n = document.getElementById('single-name').value;
        const p = Number(document.getElementById('single-price').value);
        const c = Number(document.getElementById('single-cost').value);
        const s = Number(document.getElementById('single-stock').value);
        let id = document.getElementById('single-id').value;

        if(!n || !catN) return notyf.error('è«‹å¡«å¯«åˆ†é¡èˆ‡åç¨±');

        const category = inv.find(v => v.cat === catN);
        if(category) {
            if(!category.items) category.items = [];
            if(!id) id = Date.now().toString().slice(-4);
            category.items.push({ id, n, c, p, s, type: 'item' });

            if (isOnline) {
                db.ref('inventory').set(inv).then(() => {
                    closeModal('modal-single-product');
                    notyf.success('å•†å“å·²æ–°å¢');
                });
            } else {
                closeModal('modal-single-product');
                notyf.success('å•†å“å·²æ–°å¢ (é›¢ç·š)');
                initUI();
            }
        }
    }

    // --- Add Combo Product Logic ---
    let tempComboSpecs = [];
    let tempActiveGroupIdx = -1;

    function openAddComboModal() {
        document.getElementById('combo-name').value = '';
        document.getElementById('combo-price').value = '';
        document.getElementById('combo-id').value = '';
        updateCatSelect('combo-cat');
        tempComboSpecs = [];
        tempActiveGroupIdx = -1;
        renderComboConfigUI();
        openModal('modal-combo-product');
    }

    function addComboGroup() {
        const name = document.getElementById('combo-group-input').value.trim();
        if(!name) return notyf.error('è«‹è¼¸å…¥ç¾¤çµ„åç¨±');
        tempComboSpecs.push({ title: name, options: [] });
        document.getElementById('combo-group-input').value = '';
        tempActiveGroupIdx = tempComboSpecs.length - 1;
        renderComboConfigUI();
    }

    function setComboActiveGroup(idx) {
        tempActiveGroupIdx = idx;
        renderComboConfigUI();
    }

    function toggleItemInCombo(id, checked) {
        if(tempActiveGroupIdx === -1) return;
        const group = tempComboSpecs[tempActiveGroupIdx];
        if(checked) {
            if(!group.options.includes(id)) group.options.push(id);
        } else {
            group.options = group.options.filter(x => x !== id);
        }
        renderComboConfigUI();
    }

    function renderComboConfigUI() {
        const listEl = document.getElementById('combo-group-list-ui');
        if(tempComboSpecs.length === 0) {
            listEl.innerHTML = '<div style="color:#999; text-align:center; padding:20px;">è«‹å…ˆæ–°å¢ç¾¤çµ„</div>';
        } else {
            listEl.innerHTML = tempComboSpecs.map((g, idx) => `
                <div class="group-card ${idx === tempActiveGroupIdx ? 'active' : ''}" onclick="setComboActiveGroup(${idx})">
                    <div style="font-weight:bold;">${g.title}</div>
                    <div style="font-size:0.8em; color:#666;">å·²é¸ ${g.options.length} é …</div>
                    <div style="text-align:right; font-size:0.8em; color:red;" onclick="event.stopPropagation(); removeComboGroup(${idx})">åˆªé™¤</div>
                </div>
            `).join('');
        }

        const poolEl = document.getElementById('combo-item-pool-ui');
        if(tempActiveGroupIdx === -1) {
            poolEl.innerHTML = '<div style="color:#999; text-align:center; padding:20px;">è«‹é»é¸å·¦å´ç¾¤çµ„ä»¥å‹¾é¸å…§å®¹</div>';
            return;
        }

        const currentOptions = tempComboSpecs[tempActiveGroupIdx].options;
        let html = '';
        inv.forEach(cat => {
            let catHtml = `<div style="font-weight:bold; margin-top:5px; margin-bottom:5px; background:#eee; padding:2px 5px;">${cat.cat}</div><div class="checkbox-grid">`;
            let hasItems = false;
            (cat.items || []).forEach(item => {
                if(item.type === 'combo') return;
                hasItems = true;
                const isChecked = currentOptions.includes(item.id);
                catHtml += `
                    <label class="check-item">
                        <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleItemInCombo('${item.id}', this.checked)">
                        <span>${item.n}</span>
                    </label>`;
            });
            catHtml += '</div>';
            if(hasItems) html += catHtml;
        });
        poolEl.innerHTML = html;
    }

    function removeComboGroup(idx) {
        tempComboSpecs.splice(idx, 1);
        tempActiveGroupIdx = -1;
        renderComboConfigUI();
    }

    function saveComboProduct() {
        const catN = document.getElementById('combo-cat').value;
        const n = document.getElementById('combo-name').value;
        const p = Number(document.getElementById('combo-price').value);
        let id = document.getElementById('combo-id').value;

        if(!n || !catN) return notyf.error('è«‹å¡«å¯«åˆ†é¡èˆ‡åç¨±');
        if(tempComboSpecs.length === 0) return notyf.error('å¥—é¤è‡³å°‘éœ€è¦ä¸€å€‹å…§å®¹ç¾¤çµ„');

        const category = inv.find(v => v.cat === catN);
        if(category) {
            if(!category.items) category.items = [];
            if(!id) id = Date.now().toString().slice(-4);

            category.items.push({
                id, n, p, c:0, s:0,
                type: 'combo',
                comboSpecs: tempComboSpecs
            });

            if (isOnline) {
                db.ref('inventory').set(inv).then(() => {
                    closeModal('modal-combo-product');
                    notyf.success('å¥—é¤å·²å»ºç«‹');
                });
            } else {
                closeModal('modal-combo-product');
                notyf.success('å¥—é¤å·²å»ºç«‹ (é›¢ç·š)');
                initUI();
            }
        }
    }

    // --- Admin General Functions ---
    function updateCatSelect(id) {
        const sel = document.getElementById(id);
        if(!sel) return;
        sel.innerHTML = inv.map(c => `<option value="${c.cat}">${c.cat}</option>`).join('') +
            `<option value="ADD">â• æ–°å¢åˆ†é¡...</option>`;
    }

    function checkNewCat(val, id) {
        if(val === "ADD") {
            Swal.fire({
                title: 'æ–°å¢åˆ†é¡',
                input: 'text',
                inputLabel: 'è«‹è¼¸å…¥åˆ†é¡åç¨±',
                showCancelButton: true,
                heightAuto: false
            }).then((result) => {
                if(result.isConfirmed && result.value) {
                    inv.push({cat: result.value, items: []});
                    if(isOnline) db.ref('inventory').set(inv);

                    setTimeout(() => {
                        updateCatSelect('single-cat');
                        updateCatSelect('combo-cat');
                        document.getElementById(id).value = result.value;
                    }, 500);
                } else {
                    document.getElementById(id).selectedIndex = 0;
                }
            });
        }
    }

    function renderAdminTable() {
        let html = '';
        inv.forEach((cat, ci) => {
            html += `<tr id="ac${ci}" style="background:#eee;">
                <td colspan="7" style="text-align:left; padding:10px;">
                    <b>ğŸ“‚ ${cat.cat}</b>
                    <button class="edit-cat-btn" onclick="editCategoryName(${ci})">âœï¸</button>
                    <button class="del-cat-btn" onclick="deleteCategory(${ci})">ğŸ—‘ï¸</button>
                </td>
            </tr>`;
            (cat.items || []).forEach((it, ii) => {
                const isCombo = it.type === 'combo';
                html += `<tr draggable="true" data-cat="${ci}" data-idx="${ii}" class="draggable-row">
                    <td><span class="drag-handle">â˜°</span></td>
                    <td>${isCombo ? '<span style="color:blue">å¥—é¤</span>' : 'å–®å“'}</td>
                    <td style="text-align:left;"><input type="text" value="${it.n}" onchange="editItem(${ci},${ii},'n',this.value)" class="admin-table-input"></td>
                    <td>${isCombo ? '-' : `<input type="number" value="${it.c}" onchange="editItem(${ci},${ii},'c',this.value)" class="admin-table-input" style="width:60px;">`}</td>
                    <td><input type="number" value="${it.p}" onchange="editItem(${ci},${ii},'p',this.value)" class="admin-table-input" style="width:60px;"></td>
                    <td>
                        ${isCombo
                    ? `<button onclick="editComboSpecs(${ci},${ii})" class="btn-setting">âš™ï¸ å…§å®¹</button>`
                    : `<input type="number" value="${it.s}" onchange="editItem(${ci},${ii},'s',this.value)" class="admin-table-input" style="width:60px;">`}
                    </td>
                    <td><span onclick="delP(${ci},${ii})" class="del-x">âœ•</span></td>
                </tr>`;
            });
        });
        const tbody = document.getElementById('admin-tbody');
        tbody.innerHTML = html;

        // Add Drag and Drop Listeners (Desktop)
        const rows = tbody.querySelectorAll('.draggable-row');
        rows.forEach(row => {
            row.addEventListener('dragstart', handleDragStart);
            row.addEventListener('dragover', handleDragOver);
            row.addEventListener('drop', handleDrop);
            row.addEventListener('dragend', handleDragEnd);
        });

        // Add Touch Listeners for Mobile Drag & Drop
        const handles = tbody.querySelectorAll('.drag-handle');
        handles.forEach(handle => {
            handle.addEventListener('touchstart', handleTouchStart, {passive: false});
            handle.addEventListener('touchmove', handleTouchMove, {passive: false});
            handle.addEventListener('touchend', handleTouchEnd);
        });
    }

    let dragSrcEl = null;

    function handleDragStart(e) {
        dragSrcEl = this;
        e.dataTransfer.effectAllowed = 'move';
        this.classList.add('dragging');
    }

    function handleDragOver(e) {
        if (e.preventDefault) e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        return false;
    }

    function handleDrop(e) {
        if (e.stopPropagation) e.stopPropagation();

        let target = e.target.closest('tr');
        if (dragSrcEl !== target && target.classList.contains('draggable-row')) {
            const srcCat = dragSrcEl.dataset.cat;
            const srcIdx = parseInt(dragSrcEl.dataset.idx);
            const tgtCat = target.dataset.cat;
            const tgtIdx = parseInt(target.dataset.idx);

            if (srcCat === tgtCat) {
                const items = inv[srcCat].items;
                const [movedItem] = items.splice(srcIdx, 1);
                items.splice(tgtIdx, 0, movedItem);

                if(isOnline) db.ref('inventory').set(inv);
                renderAdminTable();
            } else {
                notyf.error('åªèƒ½åœ¨åŒä¸€åˆ†é¡å…§èª¿æ•´é †åº');
            }
        }
        return false;
    }

    function handleDragEnd(e) {
        this.classList.remove('dragging');
    }

    // --- Mobile Touch Event Handlers for Drag and Drop ---
    function handleTouchStart(e) {
        dragSrcEl = this.closest('tr');
        dragSrcEl.classList.add('dragging');

        const clone = dragSrcEl.cloneNode(true);
        const tableWrapper = document.createElement('table');
        tableWrapper.id = 'touch-drag-clone';

        const originalTable = document.getElementById('admin-main-table');
        tableWrapper.style.cssText = `
            position: fixed; pointer-events: none; z-index: 9999; opacity: 0.95;
            box-shadow: 0 15px 25px rgba(0,0,0,0.3); background: white;
            border-collapse: collapse; width: ${originalTable.getBoundingClientRect().width}px;
        `;

        const tbody = document.createElement('tbody');
        tbody.appendChild(clone);
        tableWrapper.appendChild(tbody);

        Array.from(dragSrcEl.children).forEach((td, i) => {
            clone.children[i].style.width = td.getBoundingClientRect().width + 'px';
            clone.children[i].style.boxSizing = 'border-box';
        });

        document.body.appendChild(tableWrapper);

        const touch = e.touches[0];
        const rect = dragSrcEl.getBoundingClientRect();

        dragSrcEl._touchOffsetX = touch.clientX - rect.left;
        dragSrcEl._touchOffsetY = touch.clientY - rect.top;

        tableWrapper.style.left = rect.left + 'px';
        tableWrapper.style.top = rect.top + 'px';
    }

    function handleTouchMove(e) {
        if (!dragSrcEl) return;
        e.preventDefault();

        const touch = e.touches[0];
        const cloneTable = document.getElementById('touch-drag-clone');

        if (cloneTable) {
            cloneTable.style.left = (touch.clientX - dragSrcEl._touchOffsetX) + 'px';
            cloneTable.style.top = (touch.clientY - dragSrcEl._touchOffsetY) + 'px';
        }

        const targetEl = document.elementFromPoint(touch.clientX, touch.clientY);
        if (!targetEl) return;

        const targetRow = targetEl.closest('tr.draggable-row');

        const rows = document.querySelectorAll('.draggable-row');
        rows.forEach(r => {
            r.style.borderTop = '';
            r.style.borderBottom = '';
        });

        if (targetRow && targetRow !== dragSrcEl && targetRow.dataset.cat === dragSrcEl.dataset.cat) {
            const srcIdx = parseInt(dragSrcEl.dataset.idx);
            const tgtIdx = parseInt(targetRow.dataset.idx);

            if (tgtIdx < srcIdx) {
                targetRow.style.borderTop = '2px solid var(--accent-brown)';
            } else {
                targetRow.style.borderBottom = '2px solid var(--accent-brown)';
            }
        }
    }

    function handleTouchEnd(e) {
        if (!dragSrcEl) return;
        dragSrcEl.classList.remove('dragging');

        const cloneTable = document.getElementById('touch-drag-clone');
        if (cloneTable) cloneTable.remove();

        const touch = e.changedTouches[0];
        const targetEl = document.elementFromPoint(touch.clientX, touch.clientY);

        const rows = document.querySelectorAll('.draggable-row');
        rows.forEach(r => {
            r.style.borderTop = '';
            r.style.borderBottom = '';
        });

        if (targetEl) {
            const targetRow = targetEl.closest('tr.draggable-row');
            if (targetRow && targetRow !== dragSrcEl) {
                const srcCat = dragSrcEl.dataset.cat;
                const srcIdx = parseInt(dragSrcEl.dataset.idx);
                const tgtCat = targetRow.dataset.cat;
                const tgtIdx = parseInt(targetRow.dataset.idx);

                if (srcCat === tgtCat) {
                    const items = inv[srcCat].items;
                    const [movedItem] = items.splice(srcIdx, 1);
                    items.splice(tgtIdx, 0, movedItem);

                    if(isOnline) db.ref('inventory').set(inv);
                    renderAdminTable();
                } else {
                    notyf.error('åªèƒ½åœ¨åŒä¸€åˆ†é¡å…§èª¿æ•´é †åº');
                }
            }
        }
        dragSrcEl = null;
    }


    function editComboSpecs(ci, ii) {
        const item = inv[ci].items[ii];
        document.getElementById('combo-name').value = item.n;
        document.getElementById('combo-price').value = item.p;
        document.getElementById('combo-id').value = item.id;
        document.getElementById('combo-cat').value = inv[ci].cat;

        tempComboSpecs = JSON.parse(JSON.stringify(item.comboSpecs || []));
        tempActiveGroupIdx = tempComboSpecs.length > 0 ? 0 : -1;
        renderComboConfigUI();

        const btn = document.querySelector('#modal-combo-product .btn-submit');
        const oldText = btn.innerText;
        const oldOnClick = btn.onclick;

        btn.innerText = "æ›´æ–°å¥—é¤";
        btn.onclick = function() {
            item.n = document.getElementById('combo-name').value;
            item.p = Number(document.getElementById('combo-price').value);
            item.id = document.getElementById('combo-id').value;
            item.comboSpecs = tempComboSpecs;

            if(isOnline) db.ref('inventory').set(inv);

            closeModal('modal-combo-product');
            notyf.success('å¥—é¤å…§å®¹å·²æ›´æ–°');

            btn.innerText = oldText;
            btn.onclick = oldOnClick;
        };

        openModal('modal-combo-product');
    }

    function editItem(ci, ii, k, v) {
        inv[ci].items[ii][k] = (k==='n'?v:Number(v));
        if(isOnline) db.ref('inventory').set(inv);
    }

    function delP(ci, ii) {
        Swal.fire({ title: 'ç¢ºå®šåˆªé™¤?', text: "æ­¤æ“ä½œç„¡æ³•å¾©åŸ", icon: 'warning', showCancelButton: true, heightAuto: false }).then((res) => {
            if(res.isConfirmed) {
                inv[ci].items.splice(ii,1);
                if(isOnline) db.ref('inventory').set(inv);
                renderAdminTable();
            }
        });
    }

    function deleteCategory(ci) {
        Swal.fire({ title: `åˆªé™¤åˆ†é¡ã€Œ${inv[ci].cat}ã€?`, text: "åˆ†é¡ä¸‹æ‰€æœ‰å•†å“ä¹Ÿæœƒæ¶ˆå¤±", icon: 'warning', showCancelButton: true, heightAuto: false }).then((res) => {
            if(res.isConfirmed) {
                inv.splice(ci, 1);
                if(inv.length === 0) inv = [{cat: "é è¨­åˆ†é¡", items: []}];
                if(isOnline) db.ref('inventory').set(inv);
                renderAdminTable();
                initUI();
            }
        });
    }

    function editCategoryName(ci) {
        Swal.fire({ title: 'ä¿®æ”¹åˆ†é¡åç¨±', input: 'text', inputValue: inv[ci].cat, showCancelButton: true, heightAuto: false }).then((res)=>{
            if(res.isConfirmed && res.value) {
                inv[ci].cat = res.value;
                if(isOnline) db.ref('inventory').set(inv);
                renderAdminTable(); initUI();
            }
        });
    }

    // --- POS Front-end Logic ---
    let pendingCombo = null;

    function addCartClick(catIdx, itemIdx) {
        const item = inv[catIdx].items[itemIdx];
        if (item.type === 'combo') {
            openComboSelectModal(item);
        } else {
            addCartDirect(item);
        }
    }

    function addCartDirect(item) {
        if(item.s <= 0) {
            Swal.fire({ title: 'åº«å­˜ä¸è¶³', text: 'ä»è¦åŠ å…¥è³¼ç‰©è»Šå—ï¼Ÿ', icon: 'question', showCancelButton: true, heightAuto: false }).then((res)=>{
                if(res.isConfirmed) { cart.push({...item}); renderCart(); }
            });
            return;
        }
        cart.push({...item});
        renderCart();
    }

    function openComboSelectModal(item) {
        if (!item.comboSpecs || item.comboSpecs.length === 0) {
            notyf.error('æ­¤å¥—é¤å°šæœªè¨­å®šå…§å®¹');
            return;
        }
        pendingCombo = { ...item, selection: {} };
        const modal = document.getElementById('combo-select-modal');
        const area = document.getElementById('combo-selection-area');
        document.getElementById('select-combo-title').innerText = `é¸æ“‡ï¼š${item.n}`;
        modal.style.display = 'flex';

        let html = '';
        item.comboSpecs.forEach((group, gIdx) => {
            html += `<div class="combo-select-step">
                <div class="combo-step-title">æ­¥é©Ÿ ${gIdx+1}: ${group.title}</div>
                <div>`;

            group.options.forEach(optId => {
                const targetItem = findItemById(optId);
                if (targetItem) {
                    const stockText = targetItem.s <= 0 ? '(ç¼ºè²¨)' : '';
                    const styleClass = targetItem.s <= 0 ? 'combo-option disabled' : 'combo-option';
                    html += `<span class="${styleClass}" onclick="selectComboOption('${group.title}', '${optId}', this)">
                        ${targetItem.n} ${stockText}
                    </span>`;
                }
            });
            html += `</div></div>`;
        });
        area.innerHTML = html;
    }

    function selectComboOption(groupTitle, optId, el) {
        if (el.classList.contains('disabled')) return;
        const siblings = el.parentNode.children;
        for (let i=0; i<siblings.length; i++) siblings[i].classList.remove('selected');
        el.classList.add('selected');
        pendingCombo.selection[groupTitle] = optId;
    }

    function confirmComboSelection() {
        const specs = pendingCombo.comboSpecs;
        for (let spec of specs) {
            if (!pendingCombo.selection[spec.title]) {
                notyf.error(`è«‹é¸æ“‡ï¼š${spec.title}`);
                return;
            }
        }

        const detailNames = [];
        const detailIds = [];
        for (let key in pendingCombo.selection) {
            const iId = pendingCombo.selection[key];
            const item = findItemById(iId);
            if(item) {
                detailNames.push(item.n);
                detailIds.push(iId);
            }
        }

        cart.push({
            ...pendingCombo,
            comboDetail: detailNames.join(' + '),
            comboDeductionIds: detailIds
        });

        closeModal('combo-select-modal');
        renderCart();
    }

    function findItemById(id) {
        for (let c of inv) {
            for (let i of c.items) {
                if (i.id === id) return i;
            }
        }
        return null;
    }

    function renderCart() {
        document.getElementById('cart-list').innerHTML = cart.map((it, i) => `
            <div class="cart-item">
                <div style="flex:1;">
                    <div>${it.id} ${it.n}</div>
                    ${it.comboDetail ? `<span class="cart-details">â†³ ${it.comboDetail}</span>` : ''}
                </div>
                <b>$${it.p}</b>
                <span onclick="cart.splice(${i},1);renderCart()" style="color:red; cursor:pointer; margin-left:10px;">âœ•</span>
            </div>`).join('');
        calc();
    }

    function calc() {
        const total = cart.reduce((a,b)=>a+b.p, 0) - Number(document.getElementById('discount').value || 0);
        document.getElementById('final-total').innerText = Math.max(0, total);
        calcChange();
    }

    function calcChange() {
        const t = Number(document.getElementById('final-total').innerText), p = Number(document.getElementById('cash-in').value || 0);
        document.getElementById('cash-change').innerText = p > t ? p - t : 0;
    }

    function setPay(m) {
        currentPay = m;
        document.getElementById('btn-cash').className = m==='ç¾é‡‘'?'pay-btn active':'pay-btn';
        document.getElementById('btn-elec').className = m==='é›»æ”¯'?'pay-btn active':'pay-btn';
    }

    // --- Atomic Submit Order & Auto-Restock Logic ---
    function submitOrder() {
        if(!cart.length) return notyf.error('è³¼ç‰©è»Šæ˜¯ç©ºçš„');

        const selectedTable = document.getElementById('checkout-table').value;
        if(!selectedTable) return notyf.error('è«‹å…ˆé¸æ“‡æ¡Œè™Ÿï¼');

        const total = Number(document.getElementById('final-total').innerText);

        Swal.fire({
            title: 'ç¢ºèªçµå¸³?',
            html: `ç¸½é‡‘é¡: <b style="color:red; font-size:1.2em;">$${total}</b><br>æ”¯ä»˜æ–¹å¼: ${currentPay}<br>æ¡Œè™Ÿ: <b>${selectedTable}</b>`,
            showCancelButton: true,
            confirmButtonText: 'ç¢ºèªçµå¸³',
            cancelButtonText: 'å–æ¶ˆ',
            heightAuto: false
        }).then((result) => {
            if (result.isConfirmed) {
                const backdateMode = document.getElementById('backdate-mode').checked;
                const manualDate = document.getElementById('manual-date').value;
                const dateObj = (backdateMode && manualDate) ? new Date(manualDate) : new Date();

                let totalCost = 0;
                let stockDeductions = {};

                cart.forEach(item => {
                    if (item.id === "æ”¯å‡º") return;

                    const ids = (item.type === 'combo' && item.comboDeductionIds) ? item.comboDeductionIds : [item.id];
                    ids.forEach(subId => {
                        const realItem = findItemById(subId);
                        if(realItem) totalCost += (realItem.c || 0);
                        stockDeductions[subId] = (stockDeductions[subId] || 0) + 1;
                    });
                });

                const orderData = {
                    t: new Date().toLocaleTimeString('zh-TW', {hour12:false}),
                    d: dateObj.toLocaleDateString('zh-TW'),
                    total,
                    profit: total - totalCost,
                    pay: currentPay,
                    table: selectedTable,
                    items: [...cart],
                    discount: Number(document.getElementById('discount').value || 0),
                    note: document.getElementById('discount-note').value
                };

                // Prepare Active Table Data
                let newTableData = null;
                if (activeTables[selectedTable]) {
                    // Table already occupied, just append items
                    newTableData = {
                        startTime: activeTables[selectedTable].startTime, // Keep original start time
                        items: [...(activeTables[selectedTable].items || []), ...cart]
                    };
                } else {
                    // New table session
                    newTableData = {
                        startTime: Date.now(),
                        items: [...cart]
                    };
                }

                if(isOnline) {
                    let updates = {};
                    const newOrderKey = db.ref('orders').push().key;
                    updates['/orders/' + newOrderKey] = orderData;

                    // Update active tables
                    if (newTableData) {
                        updates['/active_tables/' + selectedTable] = newTableData;
                    }

                    // ä½¿ç”¨ Firebase ServerValue.increment é¿å…ç«¶æ…‹æ¢ä»¶ (Race Condition)
                    for (let subId in stockDeductions) {
                        for (let c = 0; c < inv.length; c++) {
                            for (let i = 0; i < (inv[c].items || []).length; i++) {
                                if (inv[c].items[i].id === subId) {
                                    updates[`/inventory/${c}/items/${i}/s`] = firebase.database.ServerValue.increment(-stockDeductions[subId]);
                                }
                            }
                        }
                    }

                    db.ref().update(updates).then(() => {
                        notyf.success('çµå¸³æˆåŠŸï¼æ¡Œæ³èˆ‡è³‡æ–™å·²åŒæ­¥');
                    }).catch(e => notyf.error('åŒæ­¥å¤±æ•—: ' + e.message));

                } else {
                    // Offline Mode
                    orders.unshift(orderData);
                    const localOrders = JSON.parse(localStorage.getItem('little_nook_offline_orders') || '[]');
                    localOrders.push(orderData);
                    localStorage.setItem('little_nook_offline_orders', JSON.stringify(localOrders));
                    updateSyncBtnState();

                    // UI æš«æ™‚æ‰£æ¸› & æ›´æ–°æœ¬åœ°æ¡Œæ³
                    if (newTableData) {
                        activeTables[selectedTable] = newTableData;
                        localStorage.setItem('yupin_pos_active_tables', JSON.stringify(activeTables));
                        renderTableDashboard();
                    }

                    cart.forEach(cartItem => {
                        if (cartItem.type === 'combo' && cartItem.comboDeductionIds) {
                            cartItem.comboDeductionIds.forEach(subId => {
                                inv.forEach(c => (c.items || []).forEach(i => { if(i.id === subId) i.s--; }));
                            });
                        } else {
                            inv.forEach(c => (c.items || []).forEach(i => { if(i.id === cartItem.id) i.s--; }));
                        }
                    });

                    notyf.success('æœ¬åœ°çµå¸³æˆåŠŸï¼å·²æ›´æ–°æ¡Œæ³ä¸¦å„²å­˜è‡³é›¢ç·šæ¸…å–®');
                    updateLog();
                }

                cart=[];
                document.getElementById('discount').value = '';
                document.getElementById('discount-note').value = '';
                document.getElementById('cash-in').value = '';
                document.getElementById('checkout-table').value = ''; // çµå¸³å¾Œæ¸…ç©ºæ¡Œè™Ÿé¸é …
                renderCart();
            }
        });
    }

    function addExtraCost() {
        Swal.fire({
            title: 'ç´€éŒ„é¡å¤–æ”¯å‡º',
            html: '<input id="swal-cost" class="swal2-input" placeholder="é‡‘é¡"><input id="swal-reason" class="swal2-input" placeholder="åŸå› ">',
            showCancelButton: true,
            heightAuto: false
        }).then((res)=>{
            if(res.isConfirmed) {
                const amt = document.getElementById('swal-cost').value;
                const rsn = document.getElementById('swal-reason').value || "é›œæ”¯";
                if(amt && !isNaN(amt)) {
                    cart.push({ id: "æ”¯å‡º", n: "[æ”¯] " + rsn, p: 0, c: Number(amt), s: 0 });
                    renderCart();
                }
            }
        });
    }

    function updateLog() {
        const logArea = document.getElementById('order-log');
        const today = new Date().toLocaleDateString('zh-TW');
        const todayOrders = orders.filter(o => o.d === today).slice(0, 10);
        if(todayOrders.length === 0) { logArea.innerHTML = '<div style="color:#999; padding:10px; text-align:center;">ä»Šæ—¥å°šç„¡äº¤æ˜“</div>'; return; }
        logArea.innerHTML = todayOrders.map(o => `
            <div style="border-bottom:1px solid #eee; padding:5px 0; font-size:0.9em;">
                <span style="color:#888;">[${o.t}]</span> <b>$${o.total}</b> (${o.pay}) ${o.table ? `<span style="color:var(--accent-brown); font-weight:bold;">[${o.table}]</span>` : ''}
                <div style="color:#666; font-size:0.85em;">${o.items.map(i => i.n + (i.comboDetail ? '(å¥—)' : '')).join(', ')}</div>
            </div>`).join('');
    }

    function searchHistory(mode) {
        const resultArea = document.getElementById('history-result-area');
        let filtered = [];
        let title = "";
        if(mode === 'day') {
            const date = document.getElementById('search-date').value;
            if(!date) return notyf.error('è«‹é¸æ“‡æ—¥æœŸ');
            const dateStr = new Date(date).toLocaleDateString('zh-TW');
            filtered = orders.filter(o => o.d === dateStr);
            title = `ğŸ“… ${dateStr} äº¤æ˜“ç´€éŒ„`;
        } else {
            const month = document.getElementById('search-month').value;
            if(!month) return notyf.error('è«‹é¸æ“‡æœˆä»½');
            filtered = orders.filter(o => {
                const parts = o.d.split('/');
                const oMonth = `${parts[0]}-${parts[1].padStart(2,'0')}`;
                return oMonth === month;
            });
            title = `ğŸ“Š ${month} æœˆåº¦çµ±è¨ˆ`;
        }
        let totalRev = 0, totalProf = 0;
        let html = `<h3>${title}</h3>`;
        if(filtered.length === 0) { html += "<p>æ­¤æ™‚æ®µç„¡è³‡æ–™</p>"; } else {
            filtered.forEach(o => {
                totalRev += o.total;
                totalProf += (o.profit || 0);
                html += `<div class="history-card">
                    <div class="history-del-btn" onclick="deleteOrder('${o.firebaseKey}')">é€€è²¨/åˆªé™¤</div>
                    <strong>ã€${o.pay}ã€‘ç¸½è¨ˆ: $${o.total}</strong> ${o.table ? `<span style="color:var(--accent-brown); font-weight:bold;">[${o.table}]</span>` : ''} <small>(${o.d} ${o.t})</small><br>
                    <span style="font-size:0.9em; color:#666;">å…§å®¹: ${o.items.map(i=>`${i.n}${i.comboDetail?`[${i.comboDetail}]`:''}`).join(', ')}</span>
                </div>`;
            });
            html = `<div style="background:#e8f5e9; padding:10px; border-radius:8px; margin-bottom:10px;"><b>ç¸½ç‡Ÿæ”¶: $${totalRev}</b> | <b>é ä¼°æ¯›åˆ©: $${totalProf}</b> | <b>å–®æ•¸: ${filtered.length}</b></div>` + html;
        }
        resultArea.innerHTML = html;
    }

    // --- Auto-Restock Order Deletion ---
    function deleteOrder(key) {
        if(!isOnline) return notyf.error('æœ¬åœ°æ¨¡å¼ä¸æ”¯æ´åˆªé™¤ï¼Œè«‹é€£ç·šå¾Œæ“ä½œ');
        Swal.fire({
            title: 'ç¢ºå®šé€€è²¨/åˆªé™¤?',
            text: 'ç³»çµ±å°‡è‡ªå‹•é€€å›æ­¤å–®çš„å•†å“åº«å­˜',
            icon: 'warning',
            showCancelButton: true,
            heightAuto: false
        }).then((res)=>{
            if(res.isConfirmed) {
                const orderToDel = orders.find(o => o.firebaseKey === key);
                if(!orderToDel) return notyf.error('æ‰¾ä¸åˆ°è©²ç­†è¨‚å–®');

                let updates = {};
                updates[`/orders/${key}`] = null;

                let stockIncrements = {};
                orderToDel.items.forEach(item => {
                    if (item.id === "æ”¯å‡º") return;
                    const ids = (item.type === 'combo' && item.comboDeductionIds) ? item.comboDeductionIds : [item.id];
                    ids.forEach(subId => {
                        stockIncrements[subId] = (stockIncrements[subId] || 0) + 1;
                    });
                });

                // å›è£œåº«å­˜çš„åŸå­æ›´æ–°
                for (let subId in stockIncrements) {
                    for (let c = 0; c < inv.length; c++) {
                        for (let i = 0; i < (inv[c].items || []).length; i++) {
                            if (inv[c].items[i].id === subId) {
                                updates[`/inventory/${c}/items/${i}/s`] = firebase.database.ServerValue.increment(stockIncrements[subId]);
                            }
                        }
                    }
                }

                db.ref().update(updates)
                    .then(() => {
                        notyf.success('ç´€éŒ„å·²åˆªé™¤ï¼Œåº«å­˜å·²å›è£œ');
                        // Optional: Re-run search if needed, but Firebase 'on' listener will refresh the array soon.
                        document.getElementById('search-date').value && searchHistory('day');
                    })
                    .catch(e => notyf.error('åˆªé™¤å¤±æ•—: ' + e.message));
            }
        });
    }

    function renderStatTable() {
        const stats = {};
        orders.forEach(o => { o.items.forEach(it => { if(it.id === "æ”¯å‡º") return; if(!stats[it.n]) stats[it.n] = { qty: 0, amt: 0 }; stats[it.n].qty += 1; stats[it.n].amt += it.p; }); });
        const sorted = Object.entries(stats).sort((a,b) => b[1].qty - a[1].qty);
        document.getElementById('stat-tbody').innerHTML = sorted.map(([name, data]) => `<tr><td style="text-align:left;">${name}</td><td>${data.qty}</td><td>$${data.amt}</td></tr>`).join('');
    }

    function backupData() {
        const blob = new Blob([JSON.stringify({inv, orders, activeTables}, null, 2)], { type: "application/json" });
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `YupinTea_Backup_${new Date().toLocaleDateString()}.json`; a.click();
    }
    function exportToExcel() {
        const data = orders.map(o => ({ "æ—¥æœŸ": o.d, "æ™‚é–“": o.t, "æ¡Œè™Ÿ": o.table||'', "ç¸½é¡": o.total, "æ¯›åˆ©": o.profit, "æ”¯ä»˜æ–¹å¼": o.pay, "å‚™è¨»": o.note, "å•†å“æ˜ç´°": o.items.map(i=>i.n + (i.comboDetail ? `[${i.comboDetail}]` : '')).join(',') }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Sales");
        XLSX.writeFile(wb, `Sales_Export_${new Date().toLocaleDateString()}.xlsx`);
    }
</script>
</body>
</html>