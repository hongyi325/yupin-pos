<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>御品泡茶體驗</title>

    <!-- 引入 Firebase v8 (已移除 auth，退回簡易前端防護) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <!-- 引入 XLSX 用於匯出 Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- 引入 SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- 引入 Notyf -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">
    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>

    <!-- 引入 Phosphor Icons (現代質感向量圖示) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* 現代化色彩與設計系統 Token */
        :root {
            --bg-body: #F7F6F3;
            --bg-card: #FFFFFF;
            --primary: #9C836A;     /* 莫蘭迪奶茶色 */
            --primary-hover: #8C735B;
            --accent-green: #5A8F69; /* 柔和品牌綠 */
            --danger-red: #D96C6C;   /* 柔和紅 */
            --text-main: #3C3633;
            --text-muted: #8E8A86;
            --border-soft: #EFEBE6;
            --shadow-soft: 0 4px 24px rgba(60, 54, 51, 0.06);
            --shadow-float: 0 12px 32px rgba(156, 131, 106, 0.2);
            --radius-md: 14px;
            --radius-lg: 20px;
            --radius-pill: 999px;
            --font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;

            /* 補回舊版變數映射，解決按鈕沒底色的問題 */
            --main-brown: var(--primary);
            --accent-brown: var(--primary);
            --profit-green: var(--accent-green);
            --price-red: var(--danger-red);
        }

        body {
            font-family: var(--font-family); background: var(--bg-body); margin: 0;
            display: flex; flex-direction: column; height: 100vh; color: var(--text-main);
            overflow: hidden; -webkit-font-smoothing: antialiased;
        }

        /* 頂部 Header */
        header {
            background: var(--bg-card); color: var(--primary); padding: 16px;
            text-align: center; font-size: 1.25em; font-weight: 700; flex-shrink: 0;
            cursor: default; user-select: none; border-bottom: 1px solid var(--border-soft);
            display: flex; justify-content: center; align-items: center; gap: 8px;
            box-shadow: var(--shadow-soft); z-index: 10;
        }

        /* Nav Bar 導覽列 */
        .nav-bar {
            background: var(--bg-body); padding: 12px 16px; display: flex; gap: 12px;
            overflow-x: auto; border-bottom: 1px solid var(--border-soft); flex-shrink: 0;
            align-items: center; white-space: nowrap; -webkit-overflow-scrolling: touch;
        }
        .nav-bar::-webkit-scrollbar { display: none; }
        .nav-btn {
            background: var(--bg-card); border: 1px solid var(--border-soft); color: var(--text-main);
            padding: 10px 20px; border-radius: var(--radius-pill); cursor: pointer;
            font-size: 1em; font-weight: 500; transition: all 0.2s; min-height: 44px;
            display: flex; align-items: center; gap: 6px; box-shadow: var(--shadow-soft);
        }
        .nav-btn:active { transform: scale(0.96); opacity: 0.9; }

        .dash-btn {
            background: var(--primary); color: white; border: none; padding: 10px 20px;
            border-radius: var(--radius-pill); font-weight: 600; cursor: pointer; transition: all 0.2s;
            min-height: 44px; display: flex; align-items: center; justify-content: center; gap: 6px; box-shadow: var(--shadow-float);
        }
        .dash-btn:active { transform: scale(0.96); opacity: 0.9; }

        .sync-btn {
            background: var(--text-muted); color: white; border: none; padding: 10px 20px;
            border-radius: var(--radius-pill); font-weight: 600; cursor: pointer; margin-left: auto;
            display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.3s; min-height: 44px;
        }
        .sync-btn:active { transform: scale(0.96); }
        .sync-btn.has-data { background: var(--danger-red); animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(217, 108, 108, 0.6); }
            70% { box-shadow: 0 0 0 10px rgba(217, 108, 108, 0); }
            100% { box-shadow: 0 0 0 0 rgba(217, 108, 108, 0); }
        }

        /* Main Layout */
        .main-content { display: flex; flex: 1; overflow: hidden; padding: 16px; gap: 16px; }

        /* 左側顯示區 (商品/桌況) */
        .left-pane {
            flex: 1.8; display: flex; flex-direction: column; overflow: hidden;
            background: transparent; position: relative;
        }
        .item-area { flex: 1; overflow-y: auto; padding-right: 8px; }
        .table-area { flex: 1; overflow-y: auto; display: none; }

        /* 商品分類與 Grid */
        .cat-title {
            padding: 10px 0; margin: 16px 0 12px; font-weight: 700; color: var(--text-main);
            font-size: 1.25em; display: flex; align-items: center; gap: 8px;
        }
        .cat-title i { color: var(--primary); }

        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
        .p-btn {
            background: var(--bg-card); border: 1px solid var(--border-soft); border-radius: var(--radius-md);
            padding: 16px 12px; text-align: center; cursor: pointer; box-shadow: var(--shadow-soft);
            min-height: 100px; display: flex; flex-direction: column; justify-content: center;
            position: relative; transition: all 0.2s;
        }
        .p-btn:active { transform: scale(0.96); box-shadow: none; border-color: var(--primary); }
        .p-btn.combo-item { border: 2px solid var(--primary); background: #FDFCF9; padding-top: 32px; /* 避免標籤遮擋文字 */ }
        .combo-badge {
            position: absolute; top: 0px; right: 0px; background: var(--primary); color: white;
            font-size: 0.75em; padding: 6px 10px; border-radius: 0 var(--radius-md) 0 var(--radius-md); font-weight: 600;
        }
        .p-name { font-size: 0.9em; font-weight: 600; margin-bottom: 8px; height: 2.6em; overflow: hidden; line-height: 1.3; color: var(--text-main); }
        .p-price { color: var(--primary); font-size: 1.15em; font-weight: 700; margin-bottom: 4px; }
        .p-stock { font-size: 0.8em; color: var(--text-muted); font-weight: 500; }

        /* 右側結帳與紀錄區 (iPad 端) */
        .checkout-area {
            flex: 1; display: flex; flex-direction: column; gap: 16px;
            min-width: 360px; overflow-y: auto; max-width: 450px;
        }
        .card {
            background: var(--bg-card); border-radius: var(--radius-lg); padding: 20px;
            border: 1px solid var(--border-soft); display: flex; flex-direction: column;
            box-shadow: var(--shadow-soft);
        }
        .card-header-title { font-size: 1.1em; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; color: var(--text-main); }

        #cart-list { flex: 1; min-height: 180px; max-height: 350px; overflow-y: auto; border-bottom: 1px dashed var(--border-soft); margin-bottom: 12px; }
        .cart-item { display: flex; justify-content: space-between; align-items: flex-start; padding: 12px 0; font-size: 1.05em; border-bottom: 1px solid var(--bg-body); }
        .cart-details { font-size: 0.85em; color: var(--text-muted); margin-top: 4px; display: block; display: flex; gap: 4px; align-items: center; }

        /* 輸入與控制元件 (解決裁切與跑版問題：使用高度而非 padding 垂直推擠) */
        .big-input, .table-select, .form-control {
            font-size: 1.05em; padding: 0 16px; height: 48px; width: 100%; border-radius: var(--radius-md);
            border: 1px solid #E2DED9; text-align: left; box-sizing: border-box;
            background: var(--bg-body); color: var(--text-main); font-weight: 500; transition: all 0.2s;
        }
        .big-input:focus, .table-select:focus, .form-control:focus { outline: none; border-color: var(--primary); background: #FFF; box-shadow: 0 0 0 4px rgba(156, 131, 106, 0.1); }
        .big-input { text-align: right; font-size: 1.4em; font-weight: 700; background: #FFF; border-color: var(--border-soft); height: 54px; }

        .table-select { text-align: center; color: var(--primary); background: #FDFCF9; border-width: 2px; font-weight: 700; cursor: pointer; height: 54px; }

        .small-note { font-size: 1em; padding: 0 16px; height: 44px; width: 100%; border-radius: var(--radius-md); border: 1px solid #E2DED9; box-sizing: border-box; margin-top: 8px; background: var(--bg-body); }

        .total-display { font-size: 2.8em; font-weight: 800; color: var(--danger-red); text-align: right; margin: 16px 0; letter-spacing: -1px; }

        .pay-btn {
            flex: 1; padding: 14px; border-radius: var(--radius-md); border: 1px solid var(--border-soft);
            background: var(--bg-body); cursor: pointer; font-weight: 600; font-size: 1.1em;
            display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; min-height: 48px; color: var(--text-muted);
        }
        .pay-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: var(--shadow-float); }
        .pay-btn:active { transform: scale(0.96); }

        .btn-submit {
            width: 100%; padding: 16px; background: var(--accent-green); color: white; border: none;
            border-radius: var(--radius-md); font-weight: 700; font-size: 1.25em; margin-top: 16px;
            cursor: pointer; box-shadow: 0 8px 20px rgba(90, 143, 105, 0.25); transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px; min-height: 54px;
        }
        .btn-submit:active { transform: scale(0.97); box-shadow: none; }

        /* Table Dashboard Styles */
        .table-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 16px; margin-top: 12px; }
        .t-card {
            border-radius: var(--radius-lg); padding: 16px; text-align: center; border: 1px solid var(--border-soft);
            cursor: pointer; display: flex; flex-direction: column; justify-content: center;
            min-height: 120px; box-shadow: var(--shadow-soft); transition: all 0.2s; background: var(--bg-card);
        }
        .t-card:active { transform: scale(0.96); }
        .t-empty { color: var(--text-muted); border: 2px dashed #E2DED9; background: transparent; box-shadow: none; }
        .t-green { background: #F0FDF4; border-color: #C6F6D5; color: #22543D; }
        .t-yellow { background: #FFFFF0; border-color: #FEFCBF; color: #744210; }
        .t-red { background: #FFF5F5; border-color: #FED7D7; color: #742A2A; }
        .t-red-blink { animation: modernPulse 2s infinite; color: #742A2A; border: 1px solid #FC8181; }
        @keyframes modernPulse { 0%, 100% { background: #FFF5F5; box-shadow: 0 0 0 0 rgba(252, 129, 129, 0.4); } 50% { background: #FED7D7; box-shadow: 0 0 0 8px rgba(252, 129, 129, 0); } }

        .t-name { font-size: 1.3em; font-weight: 700; margin-bottom: 8px; }
        .t-time { font-size: 0.9em; font-weight: 600; background: rgba(255,255,255,0.7); padding: 4px 8px; border-radius: var(--radius-pill); display: inline-flex; align-items: center; gap: 4px; margin: 0 auto; }
        .t-items { font-size: 0.85em; margin-top: 12px; font-weight: 500; display: flex; flex-direction: column; gap: 4px;}

        /* Panels / Modals (Modernized & z-index Fixed to 15000) */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(30, 26, 24, 0.4); z-index: 15000;
            display: none; justify-content: center; align-items: center; backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px); padding: 20px; box-sizing: border-box;
        }
        .modal-content {
            background: var(--bg-body); width: 100%; max-width: 900px; height: 90%; max-height: 800px;
            border-radius: var(--radius-lg); display: flex; flex-direction: column; padding: 24px;
            box-shadow: 0 24px 48px rgba(0,0,0,0.15); position: relative; animation: modalFadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); box-sizing: border-box;
        }
        .modal-small { max-width: 520px; height: auto; max-height: 90vh; }
        @keyframes modalFadeIn { from { transform: translateY(20px) scale(0.98); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }

        .modal-header-modern { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-soft); padding-bottom: 16px; flex-shrink: 0; }
        .modal-header-modern h2 { margin: 0; display: flex; align-items: center; gap: 10px; font-size: 1.4em; color: var(--text-main); }
        .close-icon-btn { background: transparent; border: none; font-size: 1.5em; color: var(--text-muted); cursor: pointer; padding: 8px; display: flex; align-items: center; justify-content: center; border-radius: var(--radius-full); transition: 0.2s; min-width: 44px; min-height: 44px;}
        .close-icon-btn:hover { background: var(--border-soft); color: var(--text-main); }
        .close-icon-btn:active { transform: scale(0.9); }

        /* 捲動容器：為確保 Modal 內容順暢捲動 */
        .modal-body-scroll { flex: 1; overflow-y: auto; padding-right: 4px; display: flex; flex-direction: column; overscroll-behavior: contain; }

        /* 表單協調設定 */
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-weight: 600; font-size: 0.95em; color: var(--text-muted); margin-bottom: 8px; }

        /* --- 管理中心 Grid 比例調整 --- */
        .admin-layout {
            display: grid;
            grid-template-columns: 2.5fr 1fr; /* 電腦版讓商品品項佔比放大至 71% */
            gap: 20px; flex: 1; overflow: hidden; min-height: 0;
        }
        .admin-actions { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }

        /* 管理中心表格設定 */
        .admin-table-container {
            flex: 1; overflow: auto; border: 1px solid var(--border-soft);
            border-radius: var(--radius-md); background: white;
            overscroll-behavior: none; -webkit-overflow-scrolling: touch;
            min-width: 0; min-height: 0;
        }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background: #F2EFEA; position: sticky; top: 0; padding: 0 14px; border-bottom: 1px solid var(--border-soft); z-index: 5; font-weight: 600; color: var(--text-main); text-align: left; height: 50px; box-sizing: border-box; }
        td { padding: 10px 14px; border-bottom: 1px solid var(--border-soft); vertical-align: middle; }

        /* 固定分類列 */
        .cat-header-row td { position: sticky; top: 49px; z-index: 4; background: #FDFCF9; border-bottom: 2px solid var(--border-soft); box-shadow: 0 2px 6px rgba(0,0,0,0.03); box-sizing: border-box; }

        .del-x { color: var(--danger-red); cursor: pointer; font-size: 1.2em; padding: 8px; border-radius: var(--radius-md); transition: 0.2s; display: inline-flex; }
        .del-x:hover { background: #FFF5F5; }

        .admin-table-input { width: 100%; box-sizing: border-box; border: 1px solid #E2DED9; background: var(--bg-body); border-radius: 8px; padding: 0 10px; height: 44px; font-size: 1em; color: var(--text-main); transition: all 0.2s; text-align: center; font-weight: 500;}
        .admin-table-input:focus { outline: none; border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(156, 131, 106, 0.1); }
        td input[type="text"].admin-table-input { text-align: left; }

        .drag-handle { cursor: grab; color: var(--text-muted); font-size: 1.4em; user-select: none; touch-action: none; padding: 8px; display: inline-flex; }
        .drag-handle:active { cursor: grabbing; color: var(--primary); }
        tr.dragging { opacity: 0.5; background: #FDFCF9; }

        /* 銷售排名專屬外層容器 */
        .admin-ranking-box {
            background: #FDFCF9; padding: 20px; border-radius: 12px;
            border: 1px solid var(--border-soft); display: flex; flex-direction: column;
            flex-shrink: 0; min-width: 0; min-height: 0;
        }
        .admin-ranking-inner {
            flex: 1; overflow: auto; -webkit-overflow-scrolling: touch;
            overscroll-behavior: none; min-height: 0;
        }

        /* Combo Settings */
        .combo-config-area { border: 1px solid var(--border-soft); background: white; border-radius: var(--radius-md); padding: 16px; display: flex; flex-direction: column; flex: none; }
        .combo-cols { display: flex; gap: 16px; margin-top: 12px; }
        .combo-group-list { width: 35%; overflow-y: auto; padding-right: 8px; max-height: 300px; }
        .combo-item-pool { flex: 1; overflow-y: auto; padding-left: 8px; border-left: 1px solid var(--border-soft); max-height: 300px; }
        .group-card { padding: 12px 16px; border: 1px solid var(--border-soft); border-radius: var(--radius-md); margin-bottom: 10px; cursor: pointer; background: var(--bg-body); transition: 0.2s; }
        .group-card.active { border-color: var(--primary); background: #FDFCF9; box-shadow: 0 2px 8px rgba(156, 131, 106, 0.15); }

        .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .check-item { display: flex; align-items: center; padding: 12px; border: 1px solid var(--border-soft); background: var(--bg-body); border-radius: var(--radius-md); cursor: pointer; font-size: 0.95em; font-weight: 500; transition: 0.2s;}
        .check-item:hover { border-color: var(--primary); }
        .check-item input { margin-right: 10px; width: 18px; height: 18px; accent-color: var(--primary); }

        /* Combo Selection Modal UI */
        .combo-select-step { margin-bottom: 16px; border: 1px solid var(--border-soft); padding: 16px; border-radius: var(--radius-lg); background: var(--bg-body); }
        .combo-step-title { font-weight: 700; margin-bottom: 12px; color: var(--primary); font-size: 1.1em; display: flex; align-items: center; gap: 8px;}
        .combo-option {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 10px 20px; border: 2px solid var(--border-soft);
            border-radius: var(--radius-pill); cursor: pointer; background: var(--bg-card);
            font-weight: 600; font-size: 1.05em; transition: all 0.2s; min-height: 44px; color: var(--text-main);
            user-select: none; -webkit-tap-highlight-color: transparent;
        }
        .combo-option.selected {
            background: var(--primary); color: white; border-color: var(--primary);
            box-shadow: var(--shadow-float);
        }
        .combo-option:active { transform: scale(0.96); }
        .combo-option.disabled { opacity: 0.5; background: var(--bg-body); cursor: not-allowed; pointer-events: none; }

        /* History Items */
        .history-card {
            background: white; border: 1px solid var(--border-soft); padding: 16px;
            border-radius: var(--radius-md); margin-bottom: 12px; box-shadow: var(--shadow-sm);
            display: flex; flex-direction: column;
        }
        .history-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; gap: 12px;}
        .history-del-btn {
            color: var(--danger-red); cursor: pointer; font-weight: 600; border: 1px solid #FED7D7;
            padding: 6px 12px; border-radius: 8px; font-size: 0.85em; background: #FFF5F5;
            display: inline-flex; align-items: center; justify-content: center; gap: 4px; transition: 0.2s; flex-shrink: 0;
            min-height: 36px;
        }
        .history-del-btn:active { transform: scale(0.95); }

        .btn-setting {
            background: var(--bg-body); color: var(--text-main); border: 1px solid var(--border-soft); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 0.9em; font-weight: 600; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 6px; min-height: 38px;
        }
        .btn-setting:active { transform: scale(0.96); background: var(--border-soft); }

        /* Bottom Controls (Desktop) */
        .bottom-controls { padding: 16px; display: flex; justify-content: center; gap: 16px; flex-shrink: 0; background: var(--bg-body); border-top: 1px solid var(--border-soft); z-index: 10;}
        .ctrl-btn { padding: 14px 24px; border-radius: var(--radius-pill); font-weight: 600; font-size: 1.1em; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; min-height: 48px; border: none;}
        .ctrl-btn.outline { background: white; color: var(--text-main); border: 1px solid var(--border-soft); box-shadow: var(--shadow-sm); }
        .ctrl-btn.primary { background: var(--primary); color: white; box-shadow: var(--shadow-float); }
        .ctrl-btn:active { transform: scale(0.96); }

        /* SweetAlert2 & Notyf Fixes */
        div.swal2-container { z-index: 100000 !important; font-family: var(--font-family); }
        .swal2-popup { border-radius: 24px !important; }
        html.swal2-height-auto, body.swal2-height-auto { height: 100vh !important; }
        body.swal2-shown { padding-right: 0 !important; overflow: hidden !important; }

        /* Refined Login Overlay Styles */
        #login-overlay {
            position: fixed; inset: 0; background: var(--bg-body); z-index: 10000;
            display: flex; justify-content: center; align-items: center;
        }
        .login-card-ui {
            background: white; padding: 40px 32px; border-radius: 24px;
            box-shadow: var(--shadow-float); text-align: center; width: 90%; max-width: 380px;
            box-sizing: border-box; border: 1px solid var(--border-soft);
        }
        .login-card-ui h2 { margin-top: 0; color: var(--text-main); margin-bottom: 24px; font-size: 1.6em; font-weight: 800; display: flex; align-items: center; justify-content: center; gap: 8px; }

        .login-input-wrapper { position: relative; margin-bottom: 20px; width: 100%; }

        .login-input {
            width: 100%;
            height: 60px;
            padding: 0 16px;
            font-size: 1.5em;
            border: 2px solid var(--border-soft);
            border-radius: 12px;
            background: #fff;
            color: var(--text-main);
            transition: all 0.3s ease;
            text-align: center;
            letter-spacing: 8px;
            box-sizing: border-box;
            font-weight: 700;
        }
        .login-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(156, 131, 106, 0.15);
            outline: none;
        }
        .login-input::placeholder {
            text-align: center;
            color: #bcaaa4;
            letter-spacing: normal;
            font-size: 0.7em;
            font-weight: 500;
        }

        .login-card-ui .btn-submit {
            background: var(--primary);
            color: #fff;
            padding: 16px;
            font-size: 1.2em;
            border-radius: 12px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-float);
            border: none;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            box-sizing: border-box;
            min-height: 54px;
        }
        .login-card-ui .btn-submit:hover { background: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(156, 131, 106, 0.3); }
        .login-card-ui .btn-submit:active { transform: translateY(0); box-shadow: 0 2px 4px rgba(156, 131, 106, 0.2); }

        /* Notyf Toast 客製化 UI/UX 樣式 */
        .notyf { z-index: 100000 !important; top: 50% !important; bottom: auto !important; transform: translateY(-50%) !important; align-items: center !important; justify-content: center !important; pointer-events: none; font-family: var(--font-family); }
        .notyf__toast { border-radius: var(--radius-pill) !important; padding: 12px 24px !important; box-shadow: var(--shadow-float) !important; max-width: 90vw !important; min-height: auto !important; align-items: center !important; pointer-events: auto; }
        .notyf__wrapper { padding: 0 !important; display: flex !important; justify-content: center !important; align-items: center !important; }
        .notyf__message { font-size: 1.05em !important; font-weight: 600 !important; padding: 0 !important; text-align: center !important; color: #ffffff !important; }

        /* Table Items Status UI */
        .td-item-row { padding: 14px 12px; border-bottom: 1px solid var(--border-soft); display: flex; justify-content: space-between; align-items: center; transition: 0.3s; background: white; border-radius: 8px; margin-bottom: 6px; }
        .td-item-row.is-served { opacity: 0.5; background: transparent; border-color: transparent; }
        .td-item-right { display: flex; align-items: center; gap: 16px; }
        .serve-cb-wrapper { display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; padding: 8px 14px; background: var(--bg-body); border-radius: var(--radius-pill); border: 1px solid #E2DED9; user-select: none; transition: 0.2s; font-weight: 600; min-height: 44px; min-width: 80px;}
        .serve-cb { width: 20px; height: 20px; accent-color: var(--accent-green); cursor: pointer; margin: 0; }
        .serve-cb-wrapper.served { border-color: var(--accent-green); background: #F0FDF4; color: var(--accent-green); }

        /* iPhone 專屬的底部懸浮結帳列 (Sticky Summary Bar) */
        .mobile-cart-summary {
            display: none; position: fixed; bottom: 20px; left: 16px; right: 16px;
            background: var(--primary); color: white; padding: 16px 24px;
            border-radius: var(--radius-pill); box-shadow: 0 12px 28px rgba(156, 131, 106, 0.4);
            z-index: 4000; justify-content: space-between; align-items: center;
            font-weight: 700; font-size: 1.15em; cursor: pointer; transition: transform 0.2s;
            margin-bottom: env(safe-area-inset-bottom, 0px);
        }
        .mobile-cart-summary:active { transform: scale(0.96); }
        .mobile-cart-summary .qty-badge { background: white; color: var(--primary); padding: 2px 8px; border-radius: 12px; font-size: 0.9em; margin-left: 8px; }

        /* --- 針對窄螢幕 (iPhone) 的 RWD 優化 --- */
        @media (max-width: 768px) {
            .main-content { padding: 12px; padding-bottom: 12px; flex-direction: column; overflow-y: auto;}

            /* 左側商品/桌況在手機上自然向下排 */
            .left-pane { flex: none; overflow: visible; background: transparent; border: none; }
            .item-area { padding: 0; overflow: visible; }
            .table-area { padding: 0; overflow: visible; background: transparent; }

            /* Grid 調整 */
            .product-grid { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; }
            .table-grid { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; }

            /* 重點：將右側結帳區改為底部抽屜 (Bottom Sheet) */
            .checkout-area {
                position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 5000;
                backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
                display: flex; flex-direction: column; justify-content: flex-end;
                opacity: 0; pointer-events: none; transition: opacity 0.3s;
                max-width: none; min-width: 0; padding: 0; gap: 0;
            }
            .checkout-area.is-open { opacity: 1; pointer-events: auto; }

            /* 讓 Card 變成抽屜本體 */
            .checkout-area > .card {
                background: var(--bg-body); border-radius: 24px 24px 0 0; margin: 0;
                border: none; padding: 20px; max-height: 85vh; overflow-y: auto;
                transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
                padding-bottom: max(20px, env(safe-area-inset-bottom)); /* 安全區域留白 */
            }
            .checkout-area.is-open > .card { transform: translateY(0); }

            /* 在抽屜頂部加入關閉把手與按鈕 */
            .mobile-drawer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
            .mobile-drawer-handle { width: 50px; height: 5px; background: #E2DED9; border-radius: 5px; margin: 0 auto 16px; }

            .mobile-cart-summary { display: flex; }

            /* 隱藏桌面版的 今日紀錄 */
            #log-card-container { display: none; }

            /* 模態框手機版改為 Bottom Sheet */
            .modal-overlay { align-items: flex-end; padding: 0; }
            .modal-content {
                border-radius: 24px 24px 0 0; margin: 0; max-height: 90vh;
                animation: slideUpMobile 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); padding: 20px;
                padding-bottom: max(20px, env(safe-area-inset-bottom)); /* 安全區域留白 */
            }
            @keyframes slideUpMobile { from { transform: translateY(100%); } to { transform: translateY(0); } }

            /* 管理中心 Grid 比例調整 (手機版 65% : 35%) */
            .admin-layout { grid-template-columns: 1fr; grid-template-rows: 65% 35%; gap: 12px; min-height: 0; }
            .admin-ranking-box { padding: 12px; }

            /* 管理動作按鈕水平滑動防擠壓 */
            .admin-actions { flex-wrap: nowrap; overflow-x: auto; padding-bottom: 8px; -webkit-overflow-scrolling: touch; }
            .admin-actions button { white-space: nowrap; flex-shrink: 0; }

            /* 底部按鈕重疊 */
            .bottom-controls {
                flex-direction: row;
                padding: 12px;
                padding-bottom: calc(90px + env(safe-area-inset-bottom, 0px));
                justify-content: space-between; gap: 10px;
            }
            .bottom-controls .ctrl-btn { flex: 1; padding: 12px; font-size: 1em; justify-content: center; }

            /* 表格與列表微調 */
            .td-item-row { flex-direction: column; align-items: flex-start; gap: 12px; }
            .td-item-right { width: 100%; justify-content: space-between; padding-top: 8px; border-top: 1px dashed var(--border-soft); }

            /* Table Dashboard RWD adjustments */
            .t-card { padding: 10px 5px; min-height: 90px; }
            .t-name { font-size: 1.15em; margin-bottom: 4px; }
            .t-time { font-size: 0.75em; padding: 2px 4px; }
            .t-items { font-size: 0.75em; margin-top: 6px; }

            /* History Item RWD adjustments */
            .history-card { padding: 12px; }
            .history-del-btn { position: static; margin-left: auto; padding: 6px 10px; font-size: 0.85em; }

            .login-card-ui { padding: 30px 20px; }
            .login-card-ui h2 { font-size: 1.5em; }
            .login-input { font-size: 1.3em; height: 54px; letter-spacing: 6px; }
            .login-card-ui .btn-submit { font-size: 1.1em; padding: 14px; }
            .notyf__toast { padding: 8px 16px !important; }
            .notyf__message { font-size: 0.95em !important; }

            /* 新增套餐跑版 */
            .combo-config-area { flex: none; display: flex; flex-direction: column; overflow: visible; padding: 12px; }
            .combo-cols { flex-direction: column; overflow: visible; height: auto; margin-top: 12px; }
            .combo-group-list { width: 100%; height: auto; max-height: 200px; border-right: none; border-bottom: 1px solid var(--border-soft); padding-right: 0; padding-bottom: 12px; margin-bottom: 12px; }
            .combo-item-pool { width: 100%; height: auto; max-height: 300px; padding-left: 0; border-left: none; }

            /* 修正手機版桌號選擇與輸入框間距、縮小 Placeholder */
            .table-select { font-size: 1.05em; height: 52px; margin-bottom: 16px; }
            .big-input { font-size: 1.3em !important; height: 52px; margin-top: 8px; margin-bottom: 8px; }
            .big-input::placeholder { font-size: 0.8em; }
            .small-note { height: 48px; margin-top: 12px; margin-bottom: 12px; font-size: 0.95em; }
            .small-note::placeholder { font-size: 0.9em; }

            /* 結帳區內的區塊增加上下間距 */
            #checkout-drawer .card > div[style*="margin-top:12px"] { margin-top: 20px !important; }
            #cart-list { margin-bottom: 16px; margin-top: 16px; }
        }

        /* 修復日期選擇框內距導致手機版裁切或破版的問題 */
        input[type="date"].form-control {
            padding: 0 12px;
            font-family: inherit;
        }

        /* 桌面端隱藏手機抽屜頭部 */
        @media (min-width: 769px) { .mobile-drawer-header { display: none; } }

    </style>
</head>
<body>

<!-- 登入覆蓋層 -->
<div id="login-overlay">
    <div class="login-card-ui">
        <h2><i class="ph-fill ph-leaf"></i> 御品泡茶</h2>
        <div class="login-input-wrapper">
            <input type="password" id="login-pwd-input" class="login-input" placeholder="請輸入密碼" onkeypress="if(event.key==='Enter') checkSystemLogin()">
        </div>
        <button onclick="checkSystemLogin()" class="btn-submit"><i class="ph-bold ph-sign-in"></i> 進入系統</button>
    </div>
</div>

<header onclick="handleHeaderSecretClick()"><i class="ph-fill ph-leaf"></i> 御品泡茶體驗</header>
<div class="nav-bar">
    <button id="btn-nav-menu" class="dash-btn" onclick="toggleView('products')" style="background:var(--primary); color:white; border:none;"><i class="ph-bold ph-list"></i> 主選單</button>
    <button id="btn-nav-tables" class="dash-btn" onclick="toggleView('tables')" style="background:var(--bg-card); color:var(--text-main); border:1px solid var(--border-soft);"><i class="ph-bold ph-armchair"></i> 門市桌況</button>
    <div style="flex:1;"></div>
    <button id="sync-btn" class="sync-btn" onclick="syncOfflineData()"><i class="ph-bold ph-cloud-arrow-up"></i> 雲端同步</button>
</div>

<div class="main-content">
    <!-- 左側顯示區 (商品/桌況) -->
    <div class="left-pane">
        <div class="item-area" id="item-area">同步中...</div>
        <div class="table-area" id="table-area"></div>
    </div>

    <!-- 右側結帳區 (手機版為底部抽屜) -->
    <div class="checkout-area" id="checkout-drawer">
        <!-- 點擊背景關閉抽屜 (僅手機版生效) -->
        <div style="flex:1;" onclick="toggleMobileCart(false)"></div>

        <div class="card" style="flex-shrink: 0;" onclick="event.stopPropagation()">
            <div class="mobile-drawer-handle"></div>
            <div class="mobile-drawer-header">
                <span style="font-size: 1.2em; font-weight: 700;"><i class="ph-bold ph-shopping-cart"></i> 購物車結帳</span>
                <button class="close-icon-btn" onclick="toggleMobileCart(false)"><i class="ph ph-x"></i></button>
            </div>

            <div class="card-header-title" style="display: none /* 桌面用自訂title，已融合 */">🛒 當前清單</div>

            <select id="checkout-table" class="table-select"></select>

            <div id="cart-list"></div>
            <div style="margin-top:12px; flex-shrink: 0;">
                <input type="number" id="discount" class="big-input" placeholder="折扣金額" oninput="calc()" style="text-align: left;">
                <input type="text" id="discount-note" class="small-note" placeholder="折扣原因/備註 (例如: 滿額贈)">
                <div style="margin-top:8px; display:flex; gap:8px;">
                    <button onclick="addExtraCost()" style="flex:1; padding:12px; background:#FFF5F5; border:1px solid #FED7D7; color:var(--danger-red); border-radius:10px; cursor:pointer; font-weight:600; display:flex; align-items:center; justify-content:center; gap:6px;"><i class="ph-bold ph-plus-circle"></i> 紀錄額外支出</button>
                </div>
            </div>
            <div class="total-display" style="flex-shrink: 0;">$<span id="final-total">0</span></div>
            <div style="display:flex; gap:10px; margin-bottom:12px; flex-shrink: 0;">
                <button class="pay-btn active" id="btn-cash" onclick="setPay('現金')"><i class="ph-bold ph-money"></i> 現金</button>
                <button class="pay-btn" id="btn-elec" onclick="setPay('電支')"><i class="ph-bold ph-device-mobile"></i> 電支</button>
            </div>
            <input type="number" id="cash-in" class="big-input" placeholder="實收金額" oninput="calcChange()" style="flex-shrink: 0;">
            <div style="text-align:right; margin-top:8px; font-size: 1.2em; flex-shrink: 0; font-weight: 600;">找零: <span id="cash-change" style="font-weight:800; color:var(--danger-red); font-size:1.6em;">0</span></div>

            <div style="margin: 12px 0; padding: 12px; background: #FDFCF9; border-radius: 12px; border: 1px dashed var(--primary); flex-shrink: 0; display: flex; flex-direction: column; gap: 8px;">
                <label style="font-size: 0.95em; cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: 500; margin: 0;">
                    <input type="checkbox" id="backdate-mode" onclick="document.getElementById('manual-date').style.display = this.checked ? 'block' : 'none'" style="width:18px; height:18px; accent-color:var(--primary); margin:0;">
                    <i class="ph-bold ph-calendar-blank"></i> 補登過去日期資料
                </label>
                <input type="date" id="manual-date" class="form-control" style="display:none;">
            </div>

            <button onclick="submitOrder()" class="btn-submit">結帳 / 送單 <i class="ph-bold ph-paper-plane-right"></i></button>
        </div>

        <!-- 桌機版今日紀錄 -->
        <div class="card" id="log-card-container" style="font-size: 1em; overflow-y: auto; height: 180px; flex-shrink: 0; margin-top: 16px;">
            <div class="card-header-title"><i class="ph-bold ph-receipt"></i> 今日即時紀錄</div>
            <div id="order-log"></div>
        </div>
    </div>
</div>

<!-- 手機版專屬底部懸浮列 -->
<div class="mobile-cart-summary" onclick="toggleMobileCart(true)">
    <div style="display:flex; align-items:center; gap:8px;">
        <i class="ph-bold ph-shopping-cart" style="font-size: 1.3em;"></i> 購物車 <span class="qty-badge" id="mobile-cart-count">0</span>
    </div>
    <div>$<span id="mobile-cart-total">0</span></div>
</div>

<!-- 底部系統管理區 -->
<div class="bottom-controls">
    <button class="ctrl-btn outline" onclick="openModal('admin-panel')"><i class="ph-bold ph-gear"></i> 商品管理 / 統計</button>
    <button class="ctrl-btn primary" onclick="openHistoryPanel()"><i class="ph-bold ph-clock-counter-clockwise"></i> 歷史紀錄 / 退貨</button>
</div>

<!-- 桌況明細 Modal -->
<div id="table-details-modal" class="modal-overlay">
    <div class="modal-content modal-small">
        <div class="modal-header-modern">
            <h2 id="td-modal-title"><i class="ph-fill ph-armchair"></i> 桌況明細</h2>
            <button class="close-icon-btn" onclick="closeModal('table-details-modal')"><i class="ph ph-x"></i></button>
        </div>
        <div class="modal-body-scroll">
            <div id="td-modal-info" style="background:#FDFCF9; padding:16px; border-radius:12px; font-weight:600; margin-bottom:12px; flex-shrink:0; border:1px solid var(--border-soft);"></div>
            <div id="td-modal-items" style="flex:1; border-radius:12px; background:var(--bg-body); padding: 8px;"></div>
        </div>
        <button id="td-modal-clear-btn" class="btn-submit" style="background:var(--danger-red); margin-top:16px; flex-shrink:0;"><i class="ph-bold ph-broom"></i> 清除桌面 (客離)</button>
    </div>
</div>

<!-- History Modal -->
<div id="history-panel" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header-modern">
            <h2><i class="ph-bold ph-clock-counter-clockwise"></i> 歷史紀錄管理</h2>
            <button class="close-icon-btn" onclick="closeModal('history-panel')"><i class="ph ph-x"></i></button>
        </div>
        <div style="background:#FDFCF9; padding:16px; border-radius:12px; margin-bottom:16px; display:flex; gap:16px; align-items:center; flex-wrap:wrap; border:1px solid var(--border-soft); flex-shrink:0;">
            <div style="display:flex; align-items:center; gap:8px;">
                <input type="date" id="search-date" class="form-control" style="min-height:44px; padding:0 12px; width:auto; height: 44px;">
                <button onclick="searchHistory('day')" class="dash-btn" style="min-height:44px;"><i class="ph-bold ph-magnifying-glass"></i> 查詢</button>
            </div>
            <div style="border-left: 2px solid var(--border-soft); padding-left: 16px; display:flex; align-items:center; gap:8px;">
                <input type="month" id="search-month" class="form-control" style="min-height:44px; padding:0 12px; width:auto; height: 44px;">
                <button onclick="searchHistory('month')" class="dash-btn" style="background:var(--accent-green); min-height:44px;"><i class="ph-bold ph-chart-bar"></i> 統計</button>
            </div>
        </div>
        <div id="history-result-area" style="flex:1; overflow-y:auto; background:white; padding:16px; border-radius:12px; border:1px solid var(--border-soft);"></div>
    </div>
</div>

<!-- Admin Modal (Main) -->
<div id="admin-panel" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header-modern">
            <h2><i class="ph-bold ph-gear"></i> 管理中心</h2>
            <button class="close-icon-btn" onclick="closeModal('admin-panel')"><i class="ph ph-x"></i></button>
        </div>

        <div class="admin-actions">
            <button onclick="openAddSingleModal()" class="dash-btn" style="background:var(--accent-green);"><i class="ph-bold ph-plus-circle"></i> 新增單品</button>
            <button onclick="openAddComboModal()" class="dash-btn" style="background:#D97706;"><i class="ph-bold ph-squares-four"></i> 新增套餐</button>
            <button onclick="setTableCount()" class="dash-btn" style="background:#4A90E2;"><i class="ph-bold ph-hash"></i> 設定桌數</button>

            <div style="margin-left:auto; display:flex; gap:12px;">
                <button onclick="exportToExcel()" class="dash-btn" style="background:#2F855A;"><i class="ph-bold ph-download-simple"></i> 匯出</button>
                <button onclick="backupData()" class="dash-btn" style="background:var(--text-muted);"><i class="ph-bold ph-floppy-disk"></i> 備份</button>
                <input type="file" id="import-file" style="display:none;" onchange="importData(event)">
                <button onclick="document.getElementById('import-file').click()" class="dash-btn" style="background:var(--danger-red);"><i class="ph-bold ph-warning"></i> 還原</button>
            </div>
        </div>

        <div class="admin-layout">
            <div class="admin-table-container">
                <table id="admin-main-table">
                    <!-- 表格內容由 JS 動態生成 -->
                </table>
            </div>
            <div class="admin-ranking-box">
                <h3 style="margin-top:0; margin-bottom:12px; color:var(--text-main); display:flex; align-items:center; gap:8px; flex-shrink: 0; font-size:1.1em;"><i class="ph-bold ph-chart-line-up"></i> 銷售排名</h3>
                <div class="admin-ranking-inner">
                    <table style="font-size:0.95em; width:100%; border-collapse: collapse; white-space: nowrap;">
                        <thead style="position: sticky; top: 0; background: #FDFCF9; z-index: 2;">
                        <tr>
                            <th style="border-bottom:2px solid #E2DED9; padding-bottom:8px; text-align: left;">品名</th>
                            <th style="border-bottom:2px solid #E2DED9; padding-bottom:8px; padding-left:12px; text-align:center;">量</th>
                            <th style="border-bottom:2px solid #E2DED9; padding-bottom:8px; padding-left:12px; text-align:center;">額</th>
                        </tr>
                        </thead>
                        <tbody id="stat-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Add Single Product -->
<div id="modal-single-product" class="modal-overlay">
    <div class="modal-content modal-small">
        <div class="modal-header-modern">
            <h2><i class="ph-bold ph-plus-circle"></i> 新增單品</h2>
            <button class="close-icon-btn" onclick="closeModal('modal-single-product')"><i class="ph ph-x"></i></button>
        </div>
        <div class="modal-body-scroll">
            <div class="form-group">
                <label>商品分類</label>
                <select id="single-cat" class="form-control" onchange="checkNewCat(this.value, 'single-cat')"></select>
            </div>
            <div class="form-group">
                <label>商品代碼 (選填)</label>
                <input type="text" id="single-id" class="form-control" placeholder="例如: A01">
            </div>
            <div class="form-group">
                <label>商品名稱</label>
                <input type="text" id="single-name" class="form-control" placeholder="請輸入名稱">
            </div>
            <div style="display:flex; gap:16px;">
                <div class="form-group" style="flex:1;">
                    <label>成本</label>
                    <input type="number" id="single-cost" class="form-control" value="0">
                </div>
                <div class="form-group" style="flex:1;">
                    <label>售價</label>
                    <input type="number" id="single-price" class="form-control" value="0">
                </div>
            </div>
            <div class="form-group">
                <label>初始庫存</label>
                <input type="number" id="single-stock" class="form-control" value="99">
            </div>
        </div>
        <button onclick="saveSingleProduct()" class="btn-submit" style="flex-shrink:0;">確認新增</button>
    </div>
</div>

<!-- Modal: Add Combo Product -->
<div id="modal-combo-product" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header-modern">
            <h2><i class="ph-bold ph-squares-four"></i> 新增/編輯套餐</h2>
            <button class="close-icon-btn" onclick="closeModal('modal-combo-product')"><i class="ph ph-x"></i></button>
        </div>
        <div class="modal-body-scroll">
            <!-- Basic Info -->
            <div style="display:flex; gap:16px; flex-wrap:wrap; margin-bottom: 12px; flex-shrink: 0;">
                <div class="form-group" style="flex:1; min-width:150px;">
                    <label>分類</label>
                    <select id="combo-cat" class="form-control" onchange="checkNewCat(this.value, 'combo-cat')"></select>
                </div>
                <div class="form-group" style="flex:1; min-width:150px;">
                    <label>套餐名稱</label>
                    <input type="text" id="combo-name" class="form-control" placeholder="例: 下午茶組合">
                </div>
                <div class="form-group" style="width:120px;">
                    <label>售價</label>
                    <input type="number" id="combo-price" class="form-control" value="0">
                </div>
                <div class="form-group" style="width:100px;">
                    <label>代碼</label>
                    <input type="text" id="combo-id" class="form-control">
                </div>
            </div>

            <!-- Combo Config -->
            <div class="combo-config-area">
                <div style="display:flex; gap:10px; margin-bottom:16px; align-items:center; background:#F0FDF4; padding:12px 16px; border-radius:12px; border: 1px solid #C6F6D5; flex-wrap: wrap;">
                    <strong style="color:#22543D; display:flex; align-items:center; gap:6px; flex-shrink: 0;"><i class="ph-fill ph-check-circle"></i> 步驟：</strong>
                    <span style="color:#22543D; font-weight:500; flex-shrink: 0;">輸入群組名稱 (如: 飲品選一) </span>
                    <input type="text" id="combo-group-input" class="form-control" style="min-height:44px; padding:6px 12px; flex: 1; min-width: 140px; margin-bottom: 0;" placeholder="群組名稱...">
                    <button onclick="addComboGroup()" class="dash-btn" style="background:var(--accent-green); min-height:44px; padding:6px 16px; flex-shrink: 0;"><i class="ph-bold ph-plus"></i> 加入群組</button>
                </div>

                <div class="combo-cols">
                    <!-- Left: Group List -->
                    <div class="combo-group-list" id="combo-group-list-ui">
                        <div style="color:var(--text-muted); text-align:center; padding:30px; background:var(--bg-body); border-radius:12px;">請先新增群組</div>
                    </div>

                    <!-- Right: Product Pool Checkboxes -->
                    <div class="combo-item-pool" id="combo-item-pool-ui">
                        <div style="color:var(--text-muted); text-align:center; padding:30px; background:var(--bg-body); border-radius:12px;">點選左側群組後，在此勾選內容</div>
                    </div>
                </div>
            </div>
        </div>
        <button onclick="saveComboProduct()" class="btn-submit" style="flex-shrink:0;">完成並儲存套餐</button>
    </div>
</div>

<!-- Combo Customer Selection Modal -->
<div id="combo-select-modal" class="modal-overlay">
    <div class="modal-content modal-small">
        <div class="modal-header-modern">
            <h2 id="select-combo-title">選擇套餐內容</h2>
            <button class="close-icon-btn" onclick="closeModal('combo-select-modal')"><i class="ph ph-x"></i></button>
        </div>
        <div id="combo-selection-area" class="modal-body-scroll"></div>
        <button onclick="confirmComboSelection()" class="btn-submit" style="flex-shrink:0;"><i class="ph-bold ph-check"></i> 確認加入清單</button>
    </div>
</div>

<script>
    // --- 手機版購物車抽屜切換邏輯 ---
    function toggleMobileCart(show) {
        const drawer = document.getElementById('checkout-drawer');
        if (show) {
            drawer.classList.add('is-open');
        } else {
            drawer.classList.remove('is-open');
        }
    }

    // --- 訊息策略設定 (Notyf 初始化 - 柔和且現代化的配置) ---
    const notyf = new Notyf({
        duration: 1500,
        position: { x: 'center', y: 'top' }, // CSS 會強制將其精準垂直水平置中
        dismissible: false,
        ripple: false, // 關閉水波紋，整體感覺更扎實、高級
        types: [
            { type: 'success', background: '#5A8F69', icon: false },
            { type: 'error', background: '#D96C6C', icon: false }
        ]
    });

    const firebaseConfig = {
        apiKey: "AIzaSyAomzzRW15uwRZ91jhgH6ZRFZA-ldT1iXY",
        authDomain: "yupin-pos.firebaseapp.com",
        databaseURL: "https://yupin-pos-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "yupin-pos",
        storageBucket: "yupin-pos.firebasestorage.app",
        messagingSenderId: "229501500357",
        appId: "1:229501500357:web:342f2c69ecb589da4569ac"
    };

    let db;
    let isOnline = false;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
        isOnline = true;
    } catch(e) {
        console.log("Firebase未配置，使用本地模式");
    }

    let inv = [];
    let orders = [];
    let cart = [];
    let currentPay = '現金';

    // 定義動態桌位陣列
    let tableCount = parseInt(localStorage.getItem('yupin_pos_table_count')) || 10;
    let ALL_TABLES = Array.from({length: tableCount}, (_, i) => (i + 1).toString());
    let activeTables = {}; // 追蹤正在使用中的桌子

    const defaultInv = [
        { cat: "招牌玩偶", items: [{id: "A01", n: "經典小熊", c: 100, p: 250, s: 10, type: "item"}] },
        { cat: "飲品", items: [
                {id: "D01", n: "清韻高山烏龍", c: 10, p: 50, s: 100, type: "item"},
                {id: "D02", n: "雅韻高山烏龍", c: 12, p: 55, s: 100, type: "item"}
            ]},
        { cat: "甜點", items: [
                {id: "C01", n: "提拉米蘇", c: 40, p: 120, s: 50, type: "item"},
                {id: "C02", n: "巴斯克", c: 35, p: 110, s: 50, type: "item"}
            ]}
    ];

    // --- System Login & Security Logic (Web Crypto Hash + Salt) ---
    const SALT = "YUPIN_POS_SECURE_SALT";

    async function hashPassword(pwd) {
        const msgBuffer = new TextEncoder().encode(pwd + SALT);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function initSystemPassword() {
        let storedHash = localStorage.getItem('yupin_pos_pwd_hash');
        if (!storedHash) {
            storedHash = await hashPassword('1234');
            localStorage.setItem('yupin_pos_pwd_hash', storedHash);
        }
    }
    initSystemPassword();

    document.getElementById('login-overlay').style.display = 'flex';

    async function checkSystemLogin() {
        const input = document.getElementById('login-pwd-input').value;
        if (!input) return notyf.error('請輸入密碼');

        const inputHash = await hashPassword(input);
        const storedHash = localStorage.getItem('yupin_pos_pwd_hash');

        if (inputHash === storedHash) {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('login-pwd-input').value = '';
            if (inv.length === 0) loadData();
        } else {
            notyf.error('密碼不正確');
        }
    }

    let headerClickCount = 0;
    let headerClickTimer = null;
    function handleHeaderSecretClick() {
        headerClickCount++;
        if (headerClickCount === 1) {
            headerClickTimer = setTimeout(() => { headerClickCount = 0; }, 2000);
        }
        if (headerClickCount >= 5) {
            clearTimeout(headerClickTimer);
            headerClickCount = 0;
            promptChangePassword();
        }
    }

    function promptChangePassword() {
        Swal.fire({
            title: '管理員設定',
            text: '請輸入新的系統登入密碼',
            input: 'password',
            inputPlaceholder: '新密碼',
            showCancelButton: true,
            confirmButtonText: '儲存變更',
            cancelButtonText: '取消',
            heightAuto: false
        }).then(async (result) => {
            if (result.isConfirmed && result.value) {
                const newHash = await hashPassword(result.value);
                localStorage.setItem('yupin_pos_pwd_hash', newHash);
                notyf.success('系統密碼已更新');
            }
        });
    }

    // --- Core Data Logic ---
    function loadData() {
        initTableSelect();

        if(isOnline) {
            db.ref('inventory').on('value', snap => {
                inv = snap.val() || defaultInv;
                initUI();
            });
            db.ref('orders').on('value', snap => {
                const data = snap.val();
                orders = data ? Object.keys(data).map(k => ({...data[k], firebaseKey: k})) : [];
                orders.sort((a,b) => (b.d+b.t).localeCompare(a.d+a.t));
                updateLog();
                renderStatTable();
            });
            db.ref('active_tables').on('value', snap => {
                activeTables = snap.val() || {};
                renderTableDashboard();
            });
            // 同步遠端桌數設定
            db.ref('table_count').on('value', snap => {
                if(snap.exists()) {
                    tableCount = snap.val();
                    localStorage.setItem('yupin_pos_table_count', tableCount);
                    ALL_TABLES = Array.from({length: tableCount}, (_, i) => (i + 1).toString());
                    initTableSelect();
                    if(document.getElementById('table-area').style.display !== 'none') {
                        renderTableDashboard();
                    }
                }
            });
        } else {
            inv = defaultInv;
            activeTables = JSON.parse(localStorage.getItem('yupin_pos_active_tables') || '{}');
            initUI();
            renderTableDashboard();
        }
        updateSyncBtnState();
    }

    setInterval(() => {
        if(document.getElementById('table-area').style.display !== 'none') {
            renderTableDashboard();
        }
    }, 60000);

    // --- 設定桌數 ---
    function setTableCount() {
        Swal.fire({
            title: '設定門市桌數',
            input: 'number',
            inputLabel: '請輸入總桌數 (將自動產生 1, 2, 3...)',
            inputValue: tableCount,
            showCancelButton: true,
            confirmButtonText: '儲存',
            cancelButtonText: '取消',
            heightAuto: false,
            inputValidator: (value) => {
                if (!value || value <= 0) return '請輸入大於 0 的有效數字';
            }
        }).then((result) => {
            if (result.isConfirmed && result.value > 0) {
                tableCount = parseInt(result.value);
                localStorage.setItem('yupin_pos_table_count', tableCount);
                ALL_TABLES = Array.from({length: tableCount}, (_, i) => (i + 1).toString());

                if (isOnline) {
                    db.ref('table_count').set(tableCount);
                }

                initTableSelect();
                if(document.getElementById('table-area').style.display !== 'none') {
                    renderTableDashboard();
                }
                notyf.success(`已更新為 ${tableCount} 桌`);
            }
        });
    }

    // --- Sync Logic (Atomic Updates) ---
    function updateSyncBtnState() {
        const localOrders = JSON.parse(localStorage.getItem('little_nook_offline_orders') || '[]');
        const btn = document.getElementById('sync-btn');
        if (localOrders.length > 0) {
            btn.innerHTML = `<i class="ph-bold ph-warning-circle"></i> <b>${localOrders.length}</b> 筆未同步`;
            btn.classList.add('has-data');
        } else {
            btn.innerHTML = `<i class="ph-bold ph-cloud-arrow-up"></i> 雲端同步`;
            btn.classList.remove('has-data');
        }
    }

    function syncOfflineData() {
        if(!isOnline) {
            notyf.error('未連接到 Firebase 資料庫');
            return;
        }

        const localOrders = JSON.parse(localStorage.getItem('little_nook_offline_orders') || '[]');

        if (localOrders.length === 0) {
            let updates = {};
            updates['/inventory'] = inv;
            updates['/active_tables'] = activeTables;
            updates['/table_count'] = tableCount;
            db.ref().update(updates).then(() => notyf.success('系統設定與桌況已同步'));
            return;
        }

        Swal.fire({
            title: '準備同步',
            text: `發現 ${localOrders.length} 筆離線訂單，確定上傳？`,
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: '立即同步',
            showLoaderOnConfirm: true,
            heightAuto: false,
            preConfirm: () => {
                let updates = {};
                let localDeductions = {};

                localOrders.forEach(order => {
                    const newKey = db.ref('orders').push().key;
                    updates['/orders/' + newKey] = order;

                    order.items.forEach(cartItem => {
                        if(cartItem.id === "支出") return;
                        const ids = (cartItem.type === 'combo' && cartItem.comboDeductionIds) ? cartItem.comboDeductionIds : [cartItem.id];
                        ids.forEach(subId => {
                            localDeductions[subId] = (localDeductions[subId] || 0) + 1;
                        });
                    });
                });

                for(let subId in localDeductions) {
                    for (let c = 0; c < inv.length; c++) {
                        for (let i = 0; i < (inv[c].items || []).length; i++) {
                            if (inv[c].items[i].id === subId) {
                                updates[`/inventory/${c}/items/${i}/s`] = firebase.database.ServerValue.increment(-localDeductions[subId]);
                            }
                        }
                    }
                }

                updates['/active_tables'] = activeTables;
                updates['/table_count'] = tableCount;

                return db.ref().update(updates)
                    .then(() => {
                        localStorage.removeItem('little_nook_offline_orders');
                        updateSyncBtnState();
                    })
                    .catch(error => {
                        Swal.showValidationMessage(`同步失敗: ${error}`);
                    });
            },
            allowOutsideClick: () => !Swal.isLoading()
        }).then((result) => {
            if (result.isConfirmed) {
                notyf.success('離線訂單已上傳，庫存與桌況已更新');
            }
        });
    }

    // --- View Toggle Logic ---
    function toggleView(view) {
        const itemArea = document.getElementById('item-area');
        const tableArea = document.getElementById('table-area');
        const btnMenu = document.getElementById('btn-nav-menu');
        const btnTables = document.getElementById('btn-nav-tables');

        if (view === 'tables') {
            itemArea.style.display = 'none';
            tableArea.style.display = 'block';
            if(btnMenu) {
                btnMenu.style.background = 'var(--bg-card)';
                btnMenu.style.color = 'var(--text-main)';
                btnMenu.style.border = '1px solid var(--border-soft)';
            }
            if(btnTables) {
                btnTables.style.background = 'var(--primary)';
                btnTables.style.color = 'white';
                btnTables.style.border = 'none';
            }
            renderTableDashboard();
        } else {
            itemArea.style.display = 'block';
            tableArea.style.display = 'none';
            if(btnTables) {
                btnTables.style.background = 'var(--bg-card)';
                btnTables.style.color = 'var(--text-main)';
                btnTables.style.border = '1px solid var(--border-soft)';
            }
            if(btnMenu) {
                btnMenu.style.background = 'var(--primary)';
                btnMenu.style.color = 'white';
                btnMenu.style.border = 'none';
            }
        }
    }

    // --- Init Table Selector ---
    function initTableSelect() {
        const sel = document.getElementById('checkout-table');
        sel.innerHTML = '<option value="" disabled selected hidden>-- 選擇桌號 --</option>' +
            ALL_TABLES.map(t => `<option value="${t}">${t}</option>`).join('');
    }

    // --- Table Dashboard UI ---
    function renderTableDashboard() {
        const area = document.getElementById('table-area');
        if(!area) return;

        let html = `<h2 style="margin-top:0; color:var(--text-main); font-size:1.4em; display:flex; align-items:center; gap:8px;"><i class="ph-bold ph-armchair"></i> 門市桌況監控</h2><div class="table-grid">`;
        const now = Date.now();

        ALL_TABLES.forEach(tName => {
            const tableData = activeTables[tName];

            if (tableData && tableData.items && tableData.items.length > 0) {
                const elapsedMins = Math.floor((now - tableData.startTime) / 60000);
                let colorClass = 't-green';
                if (elapsedMins >= 120) colorClass = 't-red-blink';
                else if (elapsedMins >= 90) colorClass = 't-yellow';

                let totalItems = tableData.items.length;
                let unservedItems = tableData.items.filter(it => !it.served).length;
                let serveStatusText = unservedItems === 0 ? `<span style="color:#22543D;"><i class="ph-bold ph-check-circle"></i> 全上</span>` : `<span style="color:#742A2A;"><i class="ph-bold ph-hourglass-high"></i> 剩 ${unservedItems} 項</span>`;

                html += `
                    <div class="t-card ${colorClass}" onclick="openTableDetails('${tName}')">
                        <div class="t-name">桌號 ${tName}</div>
                        <div class="t-time"><i class="ph-bold ph-timer"></i> ${elapsedMins} 分鐘</div>
                        <div class="t-items"><span>共 ${totalItems} 項</span><span>${serveStatusText}</span></div>
                    </div>`;
            } else {
                html += `
                    <div class="t-card t-empty" onclick="notyf.success('此桌目前空閒')">
                        <div class="t-name">桌號 ${tName}</div>
                        <div class="t-time" style="background:transparent; color:var(--text-muted); box-shadow:none;">空桌</div>
                    </div>`;
            }
        });
        html += '</div>';
        area.innerHTML = html;
    }

    function openTableDetails(tName) {
        const data = activeTables[tName];
        if(!data) return;

        const elapsedMins = Math.floor((Date.now() - data.startTime) / 60000);
        const startStr = new Date(data.startTime).toLocaleTimeString('zh-TW', {hour12:false});
        let colorStyle = elapsedMins >= 120 ? 'color:var(--danger-red);' : (elapsedMins >= 90 ? 'color:#D69E2E;' : 'color:var(--accent-green);');

        let unservedCount = data.items.filter(it => !it.served).length;
        let allServed = unservedCount === 0 && data.items.length > 0;

        let itemsHtml = data.items.map((it, i) => `
            <div class="td-item-row ${it.served ? 'is-served' : ''}">
                <div style="flex:1; padding-right:10px;">
                    <div style="font-weight:700; font-size:1.1em; ${it.served ? 'text-decoration:line-through; color:var(--text-muted);' : 'color:var(--text-main);'}">${it.n}</div>
                    ${it.comboDetail ? `<div style="font-size:0.85em; color:var(--text-muted); margin-top:4px;"><i class="ph-bold ph-arrow-elbow-down-right"></i> ${it.comboDetail}</div>` : ''}
                </div>
                <div class="td-item-right">
                    <div style="font-weight:700; color:var(--primary); font-size:1.1em;">$${it.p}</div>
                    <label class="serve-cb-wrapper ${it.served ? 'served' : ''}">
                        <input type="checkbox" class="serve-cb" ${it.served ? 'checked' : ''} onchange="toggleItemServed('${tName}', ${i}, this.checked)">
                        <span>${it.served ? '已出' : '出餐'}</span>
                    </label>
                </div>
            </div>
        `).join('');

        document.getElementById('td-modal-title').innerHTML = `<i class="ph-bold ph-armchair"></i> 桌號 ${tName} - 全單明細`;
        document.getElementById('td-modal-info').innerHTML = `
            <div style="display:flex; justify-content:space-between; font-size:1.05em;">
                <span>入座：${startStr}</span>
                <span style="${colorStyle}">已入座：${elapsedMins} 分鐘</span>
            </div>
            ${allServed ? `<div style="margin-top:12px; color:var(--accent-green); text-align:center; display:flex; align-items:center; justify-content:center; gap:6px;"><i class="ph-fill ph-check-circle"></i> 全數餐點已出齊</div>` : `<div style="margin-top:12px; color:var(--danger-red); text-align:center; display:flex; align-items:center; justify-content:center; gap:6px;"><i class="ph-bold ph-hourglass-high"></i> 尚有 ${unservedCount} 項未出餐</div>`}
        `;
        document.getElementById('td-modal-items').innerHTML = itemsHtml;

        document.getElementById('td-modal-clear-btn').onclick = () => clearTable(tName);

        openModal('table-details-modal');
    }

    // --- Serve Item Toggle Logic ---
    window.toggleItemServed = function(tName, itemIdx, isServed) {
        if(!activeTables[tName] || !activeTables[tName].items[itemIdx]) return;

        activeTables[tName].items[itemIdx].served = isServed;

        if (isOnline) {
            db.ref('/active_tables/' + tName + '/items/' + itemIdx + '/served').set(isServed);
        } else {
            localStorage.setItem('yupin_pos_active_tables', JSON.stringify(activeTables));
        }

        openTableDetails(tName);
        renderTableDashboard();
    };

    function clearTable(tName) {
        Swal.fire({
            title: `確定清空桌號 ${tName}？`,
            text: '客人已離場？這將會把桌位變回空桌狀態，不會影響已結帳的歷史營收',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#D96C6C',
            confirmButtonText: '確定清空',
            cancelButtonText: '取消',
            heightAuto: false
        }).then(res => {
            if(res.isConfirmed) {
                if (isOnline) {
                    db.ref('/active_tables/' + tName).remove().then(() => {
                        notyf.success(`桌號 ${tName} 已清空`);
                        closeModal('table-details-modal');
                    });
                } else {
                    delete activeTables[tName];
                    localStorage.setItem('yupin_pos_active_tables', JSON.stringify(activeTables));
                    renderTableDashboard();
                    notyf.success(`桌號 ${tName} 已清空 (離線)`);
                    closeModal('table-details-modal');
                }
            }
        });
    }

    // --- UI Rendering (Products) ---
    function initUI() {
        const area = document.getElementById('item-area');
        area.innerHTML = '';

        inv.forEach((cat, idx) => {
            let gridHtml = `<div class="cat-title" id="c${idx}"><i class="ph-fill ph-tag"></i> ${cat.cat}</div><div class="product-grid">`;
            if(!cat.items || cat.items.length === 0) {
                gridHtml += `<div style="color:var(--text-muted); padding:10px;">此分類暫無商品</div>`;
            } else {
                cat.items.forEach((it, itemIdx) => {
                    const isCombo = it.type === 'combo';
                    gridHtml += `<div class="p-btn ${isCombo ? 'combo-item' : ''}" onclick="addCartClick(${idx}, ${itemIdx})">
                        ${isCombo ? '<span class="combo-badge">套餐</span>' : ''}
                        <div class="p-name">${it.n}</div>
                        <div class="p-price">$${it.p}</div>
                        <div class="p-stock">${isCombo ? '自選' : '存:'+it.s}</div>
                    </div>`;
                });
            }
            area.innerHTML += gridHtml + '</div>';
        });

        updateCatSelect('single-cat');
        updateCatSelect('combo-cat');

        if(document.getElementById('admin-panel').style.display === 'flex') renderAdminTable();
    }

    function openModal(id) {
        document.getElementById(id).style.display = 'flex';
        if(id === 'admin-panel') renderAdminTable();
    }
    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
    }

    function openHistoryPanel() {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        const todayStr = `${yyyy}-${mm}-${dd}`;

        document.getElementById('search-date').value = todayStr;
        openModal('history-panel');
        searchHistory('day');
    }

    function openAddSingleModal() {
        document.getElementById('single-id').value = '';
        document.getElementById('single-name').value = '';
        document.getElementById('single-price').value = '';
        document.getElementById('single-cost').value = '';
        document.getElementById('single-stock').value = '99';
        updateCatSelect('single-cat');
        openModal('modal-single-product');
    }

    function saveSingleProduct() {
        const catN = document.getElementById('single-cat').value;
        const n = document.getElementById('single-name').value;
        const p = Number(document.getElementById('single-price').value);
        const c = Number(document.getElementById('single-cost').value);
        const s = Number(document.getElementById('single-stock').value);
        let id = document.getElementById('single-id').value;

        if(!n || !catN) return notyf.error('請填寫分類與名稱');

        const category = inv.find(v => v.cat === catN);
        if(category) {
            if(!category.items) category.items = [];
            if(!id) id = Date.now().toString().slice(-4);
            category.items.push({ id, n, c, p, s, type: 'item' });

            if (isOnline) {
                db.ref('inventory').set(inv).then(() => {
                    closeModal('modal-single-product');
                    notyf.success('商品已新增');
                });
            } else {
                closeModal('modal-single-product');
                notyf.success('商品已新增 (離線)');
                initUI();
            }
        }
    }

    let tempComboSpecs = [];
    let tempActiveGroupIdx = -1;

    function openAddComboModal() {
        document.getElementById('combo-name').value = '';
        document.getElementById('combo-price').value = '';
        document.getElementById('combo-id').value = '';
        updateCatSelect('combo-cat');
        tempComboSpecs = [];
        tempActiveGroupIdx = -1;
        renderComboConfigUI();
        openModal('modal-combo-product');
    }

    function addComboGroup() {
        const name = document.getElementById('combo-group-input').value.trim();
        if(!name) return notyf.error('請輸入群組名稱');
        tempComboSpecs.push({ title: name, options: [] });
        document.getElementById('combo-group-input').value = '';
        tempActiveGroupIdx = tempComboSpecs.length - 1;
        renderComboConfigUI();
    }

    function setComboActiveGroup(idx) {
        tempActiveGroupIdx = idx;
        renderComboConfigUI();
    }

    function toggleItemInCombo(id, checked) {
        if(tempActiveGroupIdx === -1) return;
        const group = tempComboSpecs[tempActiveGroupIdx];
        if(checked) {
            if(!group.options.includes(id)) group.options.push(id);
        } else {
            group.options = group.options.filter(x => x !== id);
        }
        renderComboConfigUI();
    }

    function renderComboConfigUI() {
        const listEl = document.getElementById('combo-group-list-ui');
        if(tempComboSpecs.length === 0) {
            listEl.innerHTML = '<div style="color:var(--text-muted); text-align:center; padding:20px;">請先新增群組</div>';
        } else {
            listEl.innerHTML = tempComboSpecs.map((g, idx) => `
                <div class="group-card ${idx === tempActiveGroupIdx ? 'active' : ''}" onclick="setComboActiveGroup(${idx})">
                    <div style="font-weight:700;">${g.title}</div>
                    <div style="font-size:0.85em; color:var(--text-muted); margin-top:4px;">已選 ${g.options.length} 項</div>
                    <div style="text-align:right; font-size:0.85em; color:var(--danger-red); margin-top:8px;" onclick="event.stopPropagation(); removeComboGroup(${idx})"><i class="ph-bold ph-trash"></i> 刪除</div>
                </div>
            `).join('');
        }

        const poolEl = document.getElementById('combo-item-pool-ui');
        if(tempActiveGroupIdx === -1) {
            poolEl.innerHTML = '<div style="color:var(--text-muted); text-align:center; padding:20px;">請點選左側群組以勾選內容</div>';
            return;
        }

        const currentOptions = tempComboSpecs[tempActiveGroupIdx].options;
        let html = '';
        inv.forEach(cat => {
            let catHtml = `<div style="font-weight:700; margin:12px 0 8px; color:var(--text-main);"><i class="ph-fill ph-tag"></i> ${cat.cat}</div><div class="checkbox-grid">`;
            let hasItems = false;
            (cat.items || []).forEach(item => {
                if(item.type === 'combo') return;
                hasItems = true;
                const isChecked = currentOptions.includes(item.id);
                catHtml += `
                    <label class="check-item">
                        <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleItemInCombo('${item.id}', this.checked)">
                        <span>${item.n}</span>
                    </label>`;
            });
            catHtml += '</div>';
            if(hasItems) html += catHtml;
        });
        poolEl.innerHTML = html;
    }

    function removeComboGroup(idx) {
        tempComboSpecs.splice(idx, 1);
        tempActiveGroupIdx = -1;
        renderComboConfigUI();
    }

    function saveComboProduct() {
        const catN = document.getElementById('combo-cat').value;
        const n = document.getElementById('combo-name').value;
        const p = Number(document.getElementById('combo-price').value);
        let id = document.getElementById('combo-id').value;

        if(!n || !catN) return notyf.error('請填寫分類與名稱');
        if(tempComboSpecs.length === 0) return notyf.error('套餐至少需要一個內容群組');

        const category = inv.find(v => v.cat === catN);
        if(category) {
            if(!category.items) category.items = [];
            if(!id) id = Date.now().toString().slice(-4);

            category.items.push({
                id, n, p, c:0, s:0,
                type: 'combo',
                comboSpecs: tempComboSpecs
            });

            if (isOnline) {
                db.ref('inventory').set(inv).then(() => {
                    closeModal('modal-combo-product');
                    notyf.success('套餐已建立');
                });
            } else {
                closeModal('modal-combo-product');
                notyf.success('套餐已建立 (離線)');
                initUI();
            }
        }
    }

    function updateCatSelect(id) {
        const sel = document.getElementById(id);
        if(!sel) return;
        sel.innerHTML = inv.map(c => `<option value="${c.cat}">${c.cat}</option>`).join('') +
            `<option value="ADD">➕ 新增分類...</option>`;
    }

    function checkNewCat(val, id) {
        if(val === "ADD") {
            Swal.fire({
                title: '新增分類',
                input: 'text',
                inputLabel: '請輸入分類名稱',
                showCancelButton: true,
                heightAuto: false
            }).then((result) => {
                if(result.isConfirmed && result.value) {
                    inv.push({cat: result.value, items: []});
                    if(isOnline) db.ref('inventory').set(inv);

                    setTimeout(() => {
                        updateCatSelect('single-cat');
                        updateCatSelect('combo-cat');
                        document.getElementById(id).value = result.value;
                    }, 500);
                } else {
                    document.getElementById(id).selectedIndex = 0;
                }
            });
        }
    }

    function renderAdminTable() {
        let html = `<thead><tr><th style="width:40px;"></th><th>品名</th><th>成本</th><th>售價</th><th>庫存/內容</th><th>刪</th></tr></thead>`;
        inv.forEach((cat, ci) => {
            html += `<tbody>`;
            html += `<tr id="ac${ci}" class="cat-header-row">
                <td colspan="6" style="text-align:left; padding:14px;">
                    <b style="font-size:1.1em; color:var(--primary); display:inline-flex; align-items:center; gap:6px;"><i class="ph-fill ph-folder-open"></i> ${cat.cat}</b>
                    <button class="btn-setting" style="margin-left:12px; padding:6px 10px;" onclick="editCategoryName(${ci})"><i class="ph-bold ph-pencil-simple"></i></button>
                    <button class="btn-setting" style="color:var(--danger-red); padding:6px 10px;" onclick="deleteCategory(${ci})"><i class="ph-bold ph-trash"></i></button>
                </td>
            </tr>`;
            (cat.items || []).forEach((it, ii) => {
                const isCombo = it.type === 'combo';
                html += `<tr draggable="true" data-cat="${ci}" data-idx="${ii}" class="draggable-row">
                    <td><span class="drag-handle"><i class="ph-bold ph-dots-six-vertical"></i></span></td>
                    <td style="text-align:left;"><input type="text" value="${it.n}" onchange="editItem(${ci},${ii},'n',this.value)" class="admin-table-input"></td>
                    <td>${isCombo ? '-' : `<input type="number" value="${it.c}" onchange="editItem(${ci},${ii},'c',this.value)" class="admin-table-input" style="width:70px;">`}</td>
                    <td><input type="number" value="${it.p}" onchange="editItem(${ci},${ii},'p',this.value)" class="admin-table-input" style="width:70px;"></td>
                    <td>
                        ${isCombo
                    ? `<button onclick="editComboSpecs(${ci},${ii})" class="btn-setting"><i class="ph-bold ph-gear"></i> 內容</button>`
                    : `<input type="number" value="${it.s}" onchange="editItem(${ci},${ii},'s',this.value)" class="admin-table-input" style="width:70px;">`}
                    </td>
                    <td><span onclick="delP(${ci},${ii})" class="del-x"><i class="ph-bold ph-trash"></i></span></td>
                </tr>`;
            });
            html += `</tbody>`;
        });
        const table = document.getElementById('admin-main-table');
        table.innerHTML = html;

        const rows = table.querySelectorAll('.draggable-row');
        rows.forEach(row => {
            row.addEventListener('dragstart', handleDragStart);
            row.addEventListener('dragover', handleDragOver);
            row.addEventListener('drop', handleDrop);
            row.addEventListener('dragend', handleDragEnd);
        });

        const handles = table.querySelectorAll('.drag-handle');
        handles.forEach(handle => {
            handle.addEventListener('touchstart', handleTouchStart, {passive: false});
            handle.addEventListener('touchmove', handleTouchMove, {passive: false});
            handle.addEventListener('touchend', handleTouchEnd);
        });
    }

    let dragSrcEl = null;

    function handleDragStart(e) {
        dragSrcEl = this;
        e.dataTransfer.effectAllowed = 'move';
        this.classList.add('dragging');
    }

    function handleDragOver(e) {
        if (e.preventDefault) e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        return false;
    }

    function handleDrop(e) {
        if (e.stopPropagation) e.stopPropagation();

        let target = e.target.closest('tr');
        if (dragSrcEl !== target && target.classList.contains('draggable-row')) {
            const srcCat = dragSrcEl.dataset.cat;
            const srcIdx = parseInt(dragSrcEl.dataset.idx);
            const tgtCat = target.dataset.cat;
            const tgtIdx = parseInt(target.dataset.idx);

            if (srcCat === tgtCat) {
                const items = inv[srcCat].items;
                const [movedItem] = items.splice(srcIdx, 1);
                items.splice(tgtIdx, 0, movedItem);

                if(isOnline) db.ref('inventory').set(inv);
                renderAdminTable();
            } else {
                notyf.error('只能在同一分類內調整順序');
            }
        }
        return false;
    }

    function handleDragEnd(e) {
        this.classList.remove('dragging');
    }

    // --- Mobile Touch Event Handlers for Drag and Drop ---
    function handleTouchStart(e) {
        dragSrcEl = this.closest('tr');
        dragSrcEl.classList.add('dragging');

        const clone = dragSrcEl.cloneNode(true);
        const tableWrapper = document.createElement('table');
        tableWrapper.id = 'touch-drag-clone';

        const originalTable = document.getElementById('admin-main-table');
        tableWrapper.style.cssText = `
            position: fixed; pointer-events: none; z-index: 9999; opacity: 0.95;
            box-shadow: var(--shadow-float); background: white;
            border-collapse: collapse; width: ${originalTable.getBoundingClientRect().width}px;
            border-radius: var(--radius-md); overflow: hidden;
        `;

        const tbody = document.createElement('tbody');
        tbody.appendChild(clone);
        tableWrapper.appendChild(tbody);

        Array.from(dragSrcEl.children).forEach((td, i) => {
            clone.children[i].style.width = td.getBoundingClientRect().width + 'px';
            clone.children[i].style.boxSizing = 'border-box';
        });

        document.body.appendChild(tableWrapper);

        const touch = e.touches[0];
        const rect = dragSrcEl.getBoundingClientRect();

        dragSrcEl._touchOffsetX = touch.clientX - rect.left;
        dragSrcEl._touchOffsetY = touch.clientY - rect.top;

        tableWrapper.style.left = rect.left + 'px';
        tableWrapper.style.top = rect.top + 'px';
    }

    function handleTouchMove(e) {
        if (!dragSrcEl) return;
        e.preventDefault();

        const touch = e.touches[0];
        const cloneTable = document.getElementById('touch-drag-clone');

        if (cloneTable) {
            cloneTable.style.left = (touch.clientX - dragSrcEl._touchOffsetX) + 'px';
            cloneTable.style.top = (touch.clientY - dragSrcEl._touchOffsetY) + 'px';
        }

        const targetEl = document.elementFromPoint(touch.clientX, touch.clientY);
        if (!targetEl) return;

        const targetRow = targetEl.closest('tr.draggable-row');

        const rows = document.querySelectorAll('.draggable-row');
        rows.forEach(r => {
            r.style.borderTop = '';
            r.style.borderBottom = '';
        });

        if (targetRow && targetRow !== dragSrcEl && targetRow.dataset.cat === dragSrcEl.dataset.cat) {
            const srcIdx = parseInt(dragSrcEl.dataset.idx);
            const tgtIdx = parseInt(targetRow.dataset.idx);

            if (tgtIdx < srcIdx) {
                targetRow.style.borderTop = '2px solid var(--primary)';
            } else {
                targetRow.style.borderBottom = '2px solid var(--primary)';
            }
        }
    }

    function handleTouchEnd(e) {
        if (!dragSrcEl) return;
        dragSrcEl.classList.remove('dragging');

        const cloneTable = document.getElementById('touch-drag-clone');
        if (cloneTable) cloneTable.remove();

        const touch = e.changedTouches[0];
        const targetEl = document.elementFromPoint(touch.clientX, touch.clientY);

        const rows = document.querySelectorAll('.draggable-row');
        rows.forEach(r => {
            r.style.borderTop = '';
            r.style.borderBottom = '';
        });

        if (targetEl) {
            const targetRow = targetEl.closest('tr.draggable-row');
            if (targetRow && targetRow !== dragSrcEl) {
                const srcCat = dragSrcEl.dataset.cat;
                const srcIdx = parseInt(dragSrcEl.dataset.idx);
                const tgtCat = targetRow.dataset.cat;
                const tgtIdx = parseInt(targetRow.dataset.idx);

                if (srcCat === tgtCat) {
                    const items = inv[srcCat].items;
                    const [movedItem] = items.splice(srcIdx, 1);
                    items.splice(tgtIdx, 0, movedItem);

                    if(isOnline) db.ref('inventory').set(inv);
                    renderAdminTable();
                } else {
                    notyf.error('只能在同一分類內調整順序');
                }
            }
        }
        dragSrcEl = null;
    }

    function editComboSpecs(ci, ii) {
        const item = inv[ci].items[ii];
        document.getElementById('combo-name').value = item.n;
        document.getElementById('combo-price').value = item.p;
        document.getElementById('combo-id').value = item.id;
        document.getElementById('combo-cat').value = inv[ci].cat;

        tempComboSpecs = JSON.parse(JSON.stringify(item.comboSpecs || []));
        tempActiveGroupIdx = tempComboSpecs.length > 0 ? 0 : -1;
        renderComboConfigUI();

        const btn = document.querySelector('#modal-combo-product .btn-submit');
        const oldText = btn.innerHTML;
        const oldOnClick = btn.onclick;

        btn.innerHTML = "<i class='ph-bold ph-check'></i> 更新套餐";
        btn.onclick = function() {
            item.n = document.getElementById('combo-name').value;
            item.p = Number(document.getElementById('combo-price').value);
            item.id = document.getElementById('combo-id').value;
            item.comboSpecs = tempComboSpecs;

            if(isOnline) db.ref('inventory').set(inv);

            closeModal('modal-combo-product');
            notyf.success('套餐內容已更新');

            btn.innerHTML = oldText;
            btn.onclick = oldOnClick;
        };

        openModal('modal-combo-product');
    }

    function editItem(ci, ii, k, v) {
        inv[ci].items[ii][k] = (k==='n'?v:Number(v));
        if(isOnline) db.ref('inventory').set(inv);
    }

    function delP(ci, ii) {
        Swal.fire({ title: '確定刪除?', text: "此操作無法復原", icon: 'warning', showCancelButton: true, confirmButtonColor: '#D96C6C', heightAuto: false }).then((res) => {
            if(res.isConfirmed) {
                inv[ci].items.splice(ii,1);
                if(isOnline) db.ref('inventory').set(inv);
                renderAdminTable();
            }
        });
    }

    function deleteCategory(ci) {
        Swal.fire({ title: `刪除分類「${inv[ci].cat}」?`, text: "分類下所有商品也會消失", icon: 'warning', showCancelButton: true, confirmButtonColor: '#D96C6C', heightAuto: false }).then((res) => {
            if(res.isConfirmed) {
                inv.splice(ci, 1);
                if(inv.length === 0) inv = [{cat: "預設分類", items: []}];
                if(isOnline) db.ref('inventory').set(inv);
                renderAdminTable();
                initUI();
            }
        });
    }

    function editCategoryName(ci) {
        Swal.fire({ title: '修改分類名稱', input: 'text', inputValue: inv[ci].cat, showCancelButton: true, heightAuto: false }).then((res)=>{
            if(res.isConfirmed && res.value) {
                inv[ci].cat = res.value;
                if(isOnline) db.ref('inventory').set(inv);
                renderAdminTable(); initUI();
            }
        });
    }

    // --- POS Front-end Logic ---
    let pendingCombo = null;

    function addCartClick(catIdx, itemIdx) {
        const item = inv[catIdx].items[itemIdx];
        if (item.type === 'combo') {
            openComboSelectModal(item);
        } else {
            addCartDirect(item);
        }
    }

    function addCartDirect(item) {
        if(item.s <= 0) {
            Swal.fire({ title: '庫存不足', text: '仍要加入購物車嗎？', icon: 'question', showCancelButton: true, heightAuto: false }).then((res)=>{
                if(res.isConfirmed) { cart.push({...item}); renderCart(); }
            });
            return;
        }
        cart.push({...item});
        renderCart();
    }

    function openComboSelectModal(item) {
        if (!item.comboSpecs || item.comboSpecs.length === 0) {
            notyf.error('此套餐尚未設定內容');
            return;
        }
        pendingCombo = { ...item, selection: {} };
        const modal = document.getElementById('combo-select-modal');
        const area = document.getElementById('combo-selection-area');
        document.getElementById('select-combo-title').innerHTML = `<i class="ph-bold ph-squares-four"></i> 選擇：${item.n}`;
        modal.style.display = 'flex';

        let html = '';
        item.comboSpecs.forEach((group, gIdx) => {
            html += `<div class="combo-select-step">
                <div class="combo-step-title"><i class="ph-bold ph-check-circle"></i> 步驟 ${gIdx+1}: ${group.title}</div>
                <div style="display:flex; flex-wrap:wrap; gap:10px;">`;

            group.options.forEach(optId => {
                const targetItem = findItemById(optId);
                if (targetItem) {
                    const stockText = targetItem.s <= 0 ? ' (缺貨)' : '';
                    const styleClass = targetItem.s <= 0 ? 'combo-option disabled' : 'combo-option';
                    html += `<span class="${styleClass}" onclick="selectComboOption('${group.title}', '${optId}', this)">
                        ${targetItem.n}${stockText}
                    </span>`;
                }
            });
            html += `</div></div>`;
        });
        area.innerHTML = html;
    }

    function selectComboOption(groupTitle, optId, el) {
        if (el.classList.contains('disabled')) return;
        const siblings = el.parentNode.children;
        for (let i=0; i<siblings.length; i++) siblings[i].classList.remove('selected');
        el.classList.add('selected');
        pendingCombo.selection[groupTitle] = optId;
    }

    function confirmComboSelection() {
        const specs = pendingCombo.comboSpecs;
        for (let spec of specs) {
            if (!pendingCombo.selection[spec.title]) {
                notyf.error(`請選擇：${spec.title}`);
                return;
            }
        }

        const detailNames = [];
        const detailIds = [];
        for (let key in pendingCombo.selection) {
            const iId = pendingCombo.selection[key];
            const item = findItemById(iId);
            if(item) {
                detailNames.push(item.n);
                detailIds.push(iId);
            }
        }

        cart.push({
            ...pendingCombo,
            comboDetail: detailNames.join(' + '),
            comboDeductionIds: detailIds
        });

        closeModal('combo-select-modal');
        renderCart();
    }

    function findItemById(id) {
        for (let c of inv) {
            for (let i of c.items) {
                if (i.id === id) return i;
            }
        }
        return null;
    }

    function renderCart() {
        document.getElementById('cart-list').innerHTML = cart.map((it, i) => `
            <div class="cart-item">
                <div style="flex:1;">
                    <div style="font-weight:600; color:var(--text-main);">${it.n}</div>
                    ${it.comboDetail ? `<span class="cart-details"><i class="ph-bold ph-arrow-elbow-down-right"></i> ${it.comboDetail}</span>` : ''}
                </div>
                <b style="color:var(--primary); font-size:1.1em;">$${it.p}</b>
                <span onclick="cart.splice(${i},1);renderCart()" style="color:var(--danger-red); cursor:pointer; margin-left:16px; padding:4px;"><i class="ph-bold ph-trash"></i></span>
            </div>`).join('');
        calc();

        const mobileCount = document.getElementById('mobile-cart-count');
        if(mobileCount) mobileCount.innerText = cart.length;
    }

    function calc() {
        const total = cart.reduce((a,b)=>a+b.p, 0) - Number(document.getElementById('discount').value || 0);
        const finalT = Math.max(0, total);
        document.getElementById('final-total').innerText = finalT;
        const mobileTotal = document.getElementById('mobile-cart-total');
        if(mobileTotal) mobileTotal.innerText = finalT;

        calcChange();
    }

    function calcChange() {
        const t = Number(document.getElementById('final-total').innerText), p = Number(document.getElementById('cash-in').value || 0);
        document.getElementById('cash-change').innerText = p > t ? p - t : 0;
    }

    function setPay(m) {
        currentPay = m;
        document.getElementById('btn-cash').className = m==='現金'?'pay-btn active':'pay-btn';
        document.getElementById('btn-elec').className = m==='電支'?'pay-btn active':'pay-btn';
    }

    // --- Atomic Submit Order & Auto-Restock Logic ---
    function submitOrder() {
        if(!cart.length) return notyf.error('購物車是空的');

        const selectedTable = document.getElementById('checkout-table').value;
        if(!selectedTable) {
            toggleMobileCart(true);
            return notyf.error('請先選擇桌號！');
        }

        const total = Number(document.getElementById('final-total').innerText);

        Swal.fire({
            title: '確認結帳?',
            html: `總金額: <b style="color:var(--danger-red); font-size:1.4em;">$${total}</b><br><br>支付方式: ${currentPay}<br>桌號: <b>${selectedTable}</b>`,
            showCancelButton: true,
            confirmButtonText: '確認結帳',
            cancelButtonText: '取消',
            heightAuto: false
        }).then((result) => {
            if (result.isConfirmed) {
                const backdateMode = document.getElementById('backdate-mode').checked;
                const manualDate = document.getElementById('manual-date').value;
                const dateObj = (backdateMode && manualDate) ? new Date(manualDate) : new Date();

                let totalCost = 0;
                let stockDeductions = {};

                cart.forEach(item => {
                    if (item.id === "支出") return;

                    const ids = (item.type === 'combo' && item.comboDeductionIds) ? item.comboDeductionIds : [item.id];
                    ids.forEach(subId => {
                        const realItem = findItemById(subId);
                        if(realItem) totalCost += (realItem.c || 0);
                        stockDeductions[subId] = (stockDeductions[subId] || 0) + 1;
                    });
                });

                const orderData = {
                    t: new Date().toLocaleTimeString('zh-TW', {hour12:false}),
                    d: dateObj.toLocaleDateString('zh-TW'),
                    total,
                    profit: total - totalCost,
                    pay: currentPay,
                    table: selectedTable,
                    items: [...cart],
                    discount: Number(document.getElementById('discount').value || 0),
                    note: document.getElementById('discount-note').value
                };

                // Prepare Active Table Data
                let newTableData = null;
                if (activeTables[selectedTable]) {
                    // Table already occupied, just append items
                    newTableData = {
                        startTime: activeTables[selectedTable].startTime,
                        items: [...(activeTables[selectedTable].items || []), ...cart]
                    };
                } else {
                    // New table session
                    newTableData = {
                        startTime: Date.now(),
                        items: [...cart]
                    };
                }

                if(isOnline) {
                    let updates = {};
                    const newOrderKey = db.ref('orders').push().key;
                    updates['/orders/' + newOrderKey] = orderData;

                    if (newTableData) {
                        updates['/active_tables/' + selectedTable] = newTableData;
                    }

                    // 使用 Firebase ServerValue.increment 避免競態條件 (Race Condition)
                    for (let subId in stockDeductions) {
                        for (let c = 0; c < inv.length; c++) {
                            for (let i = 0; i < (inv[c].items || []).length; i++) {
                                if (inv[c].items[i].id === subId) {
                                    updates[`/inventory/${c}/items/${i}/s`] = firebase.database.ServerValue.increment(-stockDeductions[subId]);
                                }
                            }
                        }
                    }

                    db.ref().update(updates).then(() => {
                        notyf.success('結帳成功！桌況與資料已同步');
                    }).catch(e => notyf.error('同步失敗: ' + e.message));

                } else {
                    // Offline Mode
                    orders.unshift(orderData);
                    const localOrders = JSON.parse(localStorage.getItem('little_nook_offline_orders') || '[]');
                    localOrders.push(orderData);
                    localStorage.setItem('little_nook_offline_orders', JSON.stringify(localOrders));
                    updateSyncBtnState();

                    // UI 暫時扣減 & 更新本地桌況
                    if (newTableData) {
                        activeTables[selectedTable] = newTableData;
                        localStorage.setItem('yupin_pos_active_tables', JSON.stringify(activeTables));
                        renderTableDashboard();
                    }

                    cart.forEach(cartItem => {
                        if (cartItem.type === 'combo' && cartItem.comboDeductionIds) {
                            cartItem.comboDeductionIds.forEach(subId => {
                                inv.forEach(c => (c.items || []).forEach(i => { if(i.id === subId) i.s--; }));
                            });
                        } else {
                            inv.forEach(c => (c.items || []).forEach(i => { if(i.id === cartItem.id) i.s--; }));
                        }
                    });

                    notyf.success('本地結帳成功！已更新桌況並儲存至離線清單');
                    updateLog();
                }

                cart=[];
                document.getElementById('discount').value = '';
                document.getElementById('discount-note').value = '';
                document.getElementById('cash-in').value = '';
                document.getElementById('checkout-table').value = '';
                renderCart();

                toggleMobileCart(false);
            }
        });
    }

    function addExtraCost() {
        Swal.fire({
            title: '紀錄額外支出',
            html: '<input id="swal-cost" class="swal2-input" placeholder="金額"><input id="swal-reason" class="swal2-input" placeholder="原因">',
            showCancelButton: true,
            heightAuto: false
        }).then((res)=>{
            if(res.isConfirmed) {
                const amt = document.getElementById('swal-cost').value;
                const rsn = document.getElementById('swal-reason').value || "雜支";
                if(amt && !isNaN(amt)) {
                    cart.push({ id: "支出", n: "[支] " + rsn, p: 0, c: Number(amt), s: 0 });
                    renderCart();
                }
            }
        });
    }

    function updateLog() {
        const logArea = document.getElementById('order-log');
        const today = new Date().toLocaleDateString('zh-TW');
        const todayOrders = orders.filter(o => o.d === today).slice(0, 10);
        if(todayOrders.length === 0) { logArea.innerHTML = '<div style="color:var(--text-muted); padding:10px; text-align:center;">今日尚無交易</div>'; return; }
        logArea.innerHTML = todayOrders.map(o => `
            <div style="border-bottom:1px solid var(--border-soft); padding:8px 0; font-size:0.95em;">
                <span style="color:var(--text-muted); font-weight:600;">[${o.t}]</span> <b style="color:var(--primary);">$${o.total}</b> <span style="font-size:0.85em; color:var(--text-muted); border:1px solid var(--border-soft); padding:2px 6px; border-radius:4px;">${o.pay}</span> ${o.table ? `<span style="color:var(--accent-green); font-weight:bold; margin-left:4px;">桌號 ${o.table}</span>` : ''}
                <div style="color:var(--text-main); font-size:0.9em; margin-top:4px;">${o.items.map(i => i.n + (i.comboDetail ? '(套)' : '')).join(', ')}</div>
            </div>`).join('');
    }

    function searchHistory(mode) {
        const resultArea = document.getElementById('history-result-area');
        let filtered = [];
        let title = "";
        if(mode === 'day') {
            const date = document.getElementById('search-date').value;
            if(!date) return notyf.error('請選擇日期');
            const dateStr = new Date(date).toLocaleDateString('zh-TW');
            filtered = orders.filter(o => o.d === dateStr);
            title = `<i class="ph-bold ph-calendar-blank"></i> ${dateStr} 交易紀錄`;
        } else {
            const month = document.getElementById('search-month').value;
            if(!month) return notyf.error('請選擇月份');
            filtered = orders.filter(o => {
                const parts = o.d.split('/');
                const oMonth = `${parts[0]}-${parts[1].padStart(2,'0')}`;
                return oMonth === month;
            });
            title = `<i class="ph-bold ph-chart-bar"></i> ${month} 月度統計`;
        }
        let totalRev = 0, totalProf = 0;
        let html = `<h3 style="display:flex; align-items:center; gap:8px;">${title}</h3>`;
        if(filtered.length === 0) { html += "<p style='color:var(--text-muted);'>此時段無資料</p>"; } else {
            filtered.forEach(o => {
                totalRev += o.total;
                totalProf += (o.profit || 0);
                html += `<div class="history-card">
                    <div class="history-header">
                        <div>
                            <strong style="font-size:1.1em; color:var(--text-main);">【${o.pay}】總計: <span style="color:var(--primary);">$${o.total}</span></strong>
                            ${o.table ? `<span style="color:var(--accent-green); font-weight:bold; margin-left:8px;">桌號 ${o.table}</span>` : ''}
                        </div>
                        <div class="history-del-btn" onclick="deleteOrder('${o.firebaseKey}')"><i class="ph-bold ph-trash"></i> 退貨/刪除</div>
                    </div>
                    <span style="color:var(--text-muted); font-size:0.85em;"><i class="ph-bold ph-clock"></i> ${o.d} ${o.t}</span>
                    <div style="font-size:0.95em; color:var(--text-muted); margin-top:8px; line-height:1.4;"><i class="ph-bold ph-shopping-bag"></i> 內容: ${o.items.map(i=>`${i.n}${i.comboDetail?`[${i.comboDetail}]`:''}`).join(', ')}</div>
                </div>`;
            });
            html = `<div style="background:#F0FDF4; padding:16px; border-radius:12px; margin-bottom:16px; border:1px solid #C6F6D5; display:flex; gap:16px; flex-wrap:wrap;">
                        <div><span style="color:#22543D; font-size:0.9em;">總營收</span><br><b style="font-size:1.2em; color:var(--accent-green);">$${totalRev}</b></div>
                        <div style="border-left:1px solid #C6F6D5; padding-left:16px;"><span style="color:#22543D; font-size:0.9em;">預估毛利</span><br><b style="font-size:1.2em; color:var(--primary);">$${totalProf}</b></div>
                        <div style="border-left:1px solid #C6F6D5; padding-left:16px;"><span style="color:#22543D; font-size:0.9em;">總單數</span><br><b style="font-size:1.2em; color:var(--text-main);">${filtered.length}</b></div>
                    </div>` + html;
        }
        resultArea.innerHTML = html;
    }

    // --- Auto-Restock Order Deletion ---
    function deleteOrder(key) {
        if(!isOnline) return notyf.error('本地模式不支援刪除，請連線後操作');
        Swal.fire({
            title: '確定退貨/刪除?',
            text: '系統將自動退回此單的商品庫存',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#D96C6C',
            heightAuto: false
        }).then((res)=>{
            if(res.isConfirmed) {
                const orderToDel = orders.find(o => o.firebaseKey === key);
                if(!orderToDel) return notyf.error('找不到該筆訂單');

                let updates = {};
                updates[`/orders/${key}`] = null;

                let stockIncrements = {};
                orderToDel.items.forEach(item => {
                    if (item.id === "支出") return;
                    const ids = (item.type === 'combo' && item.comboDeductionIds) ? item.comboDeductionIds : [item.id];
                    ids.forEach(subId => {
                        stockIncrements[subId] = (stockIncrements[subId] || 0) + 1;
                    });
                });

                // 回補庫存的原子更新
                for (let subId in stockIncrements) {
                    for (let c = 0; c < inv.length; c++) {
                        for (let i = 0; i < (inv[c].items || []).length; i++) {
                            if (inv[c].items[i].id === subId) {
                                updates[`/inventory/${c}/items/${i}/s`] = firebase.database.ServerValue.increment(stockIncrements[subId]);
                            }
                        }
                    }
                }

                db.ref().update(updates)
                    .then(() => {
                        notyf.success('紀錄已刪除，庫存已回補');
                        document.getElementById('search-date').value && searchHistory('day');
                    })
                    .catch(e => notyf.error('刪除失敗: ' + e.message));
            }
        });
    }

    function renderStatTable() {
        const stats = {};
        orders.forEach(o => { o.items.forEach(it => { if(it.id === "支出") return; if(!stats[it.n]) stats[it.n] = { qty: 0, amt: 0 }; stats[it.n].qty += 1; stats[it.n].amt += it.p; }); });
        const sorted = Object.entries(stats).sort((a,b) => b[1].qty - a[1].qty);
        document.getElementById('stat-tbody').innerHTML = sorted.map(([name, data]) => `<tr style="background:white;"><td style="text-align:left; font-weight:600; color:var(--text-main); padding: 8px;">${name}</td><td style="padding: 8px; text-align:center;"><span style="background:var(--bg-body); padding:4px 8px; border-radius:6px; font-weight:600;">${data.qty}</span></td><td style="color:var(--primary); font-weight:700; padding: 8px; text-align:center;">$${data.amt}</td></tr>`).join('');
    }

    function backupData() {
        const blob = new Blob([JSON.stringify({inv, orders, activeTables}, null, 2)], { type: "application/json" });
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `YupinTea_Backup_${new Date().toLocaleDateString()}.json`; a.click();
    }
    function exportToExcel() {
        const data = orders.map(o => ({ "日期": o.d, "時間": o.t, "桌號": o.table||'', "總額": o.total, "毛利": o.profit, "支付方式": o.pay, "備註": o.note, "商品明細": o.items.map(i=>i.n + (i.comboDetail ? `[${i.comboDetail}]` : '')).join(',') }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Sales");
        XLSX.writeFile(wb, `Sales_Export_${new Date().toLocaleDateString()}.xlsx`);
    }
</script>
</body>
</html>